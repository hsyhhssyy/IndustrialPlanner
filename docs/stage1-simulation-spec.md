# Stage1 仿真规范（Draft）

## 1. 仿真时钟

- 使用固定步进离散 tick。
- 目标频率：10Hz（固定）。
- 每个 tick 按统一顺序遍历机器并结算。

## 2. 资源与库存规则

- `ore` 来源无限，但需计入消耗统计。
- `power` 来源无限，但需计入消耗统计。
- 其他物品必须由产线产出并可提交到系统外仓库（全局库存）。
- Stage1 的全局库存仅指系统外仓库库存，不包含地块内机器、物流与仓储中的物品。
- 外部物品输入仅允许来自“物品取货口”。
- Stage1 不提供手动配方选择，机器根据“机器类型 + 输入物品组合”自动决定可执行配方。
- 同机型下，输入物品组合必须唯一匹配 1 个配方。
- 若匹配到 0 个或多个配方，机器进入“配方决策错误”并向用户报错，不进行生产结算。
- 配方允许多输出定义，但 Stage1 仅执行单输出配方。
- `originium_ore`（源石矿）仅允许来自物品取货口，不可由配方产出。
- 系统外仓库可回收并再提供已提交物品（矿除外按库存约束）。
- Phase1 不提供系统外仓库手动清空功能。

首批冻结配方：

- 粉碎机：`1 originium_ore -> 2 秒 -> 1 originium_powder`。

## 3. 机器状态机

状态枚举：

- `running`：可持续推进并完成结算。
- `starved`：到达结算点但输入不足。
- `disabled`：机器被禁用，不参与推进。
- `unpowered`：机器未被供电桩覆盖，不参与推进。

状态转移规则（简化）：

- 输入不足时：`running -> starved`
- 下次输入满足并允许运行时：`starved -> running`
- 无供电时：进入 `unpowered`

## 4. 每 tick 结算顺序

Phase1 冻结实现顺序（后续 Phase 可调整）：

1. 跳过 `disabled` 机器。
2. 对运行机器增加 `progress`。
3. 当 `progress >= recipe.time` 触发结算尝试。
4. 检查 `inputs` 是否满足。
5. 满足：
   - 扣减输入库存。
   - 增加输出库存。
   - 累计 `ore/power` 消耗。
   - `progress -= recipe.time`（保留余量）。
6. 不满足：
   - 不扣减库存。
   - 标记 `starved` 并记录缺失输入。

## 5. 统计口径

必须输出：

- 当前库存：`inventory[itemId]`
- 每种物品每分钟生产（/min）：按最近 60 秒滑动窗口计算
- 每种物品每分钟消耗（/min）：按最近 60 秒滑动窗口计算
- 系统外仓库每种物品当前存量（矿物显示为无穷）

展示顺序：

- `originium_ore` 优先，其次 `originium_powder`，其余按 `itemId` 字母序。

规则：

- 统一使用最近 60 秒窗口计算所有 `/min` 指标，减少瞬时抖动。

## 6. 控制操作语义

- 开始仿真：进入 tick 循环，并从编辑模式切换到仿真模式。
- 退出仿真：停止推进与结算，返回编辑模式，并执行全量运行态重置。
- 仿真模式锁定编辑：禁止放置、移动、删除、旋转、连线与地块切换。
- 仿真模式允许顶部倍速按钮（1x/2x/4x）调速。
- 重置库存：执行与退出仿真一致的全量运行态重置，并同步重置统计。

全量运行态重置至少包含：

- 清空系统外仓库库存（全局库存）
- 清空机器内部物品
- 清空传送带在途物品
- 清零机器 `progress` 等运行期进度状态
- 清空运行期临时状态（如缺料记录、轮询游标等）

地块切换：

- 在 `60x60`、`80x80`、`100x100` 地块间切换时，弹窗确认后先保存当前地块，再加载目标尺寸地块存档。
- 若目标尺寸地块尚无存档，则创建空地块存档并加载。
- Phase1 约定尺寸即地块名；未来可扩展为“地块名 + 尺寸”。
- 默认进入 `60x60` 地块。

## 7. 特殊建筑规则

- 物品取货口：仅在满足边缘摆放约束时生效；默认不出货，需用户选择物品后出货。
- 供电桩：建筑任意格位于“以供电桩中心为基准的 12x12 矩形范围”即视为有电。
- 供电桩坐标公式：若供电桩左上角为 `(x, y)`，则供电矩形左上角为 `(x - 5, y - 5)`，宽高为 `12x12`。
- 覆盖判定采用“格坐标落入”：目标建筑任一格坐标落入供电矩形即视为有电；超出地块部分按地块边界裁剪。
- 物流存储箱：可从库存中按配置速率提交至系统外（视为工业系统外流出）。

## 8. 传送带节点调度

- 桥接（交叉）节点：四向连通且两横两纵，两路直行互不干扰。
- 分流节点：单入多出（`inCount = 1`，`outCount >= 2`）。
- 汇流节点：多入单出（`outCount = 1`，`inCount >= 2`）。
- 节点由 3 向扩展为 4 向且本次绘制将其作为拐点/端点时，必须满足“单入或单出”。
- 禁止对撞：同轴双入或同轴双出。
- 传送带重叠视为非法拓扑，禁止创建。
- 传送带移动速度固定为每 2 秒 1 格。
- 绘制路径允许单步回退，但不允许沿已有同段继续铺设。

## 9. 配方兼容策略

- `outputs.length = 1`：按常规流程结算。
- `outputs.length > 1`：Stage1 标记为“已兼容未启用”，不进入生产结算。
- 多输出配方的数据需可正常读取、展示、保存与加载。

## 10. 异常与边界

- 配方不存在：机器应标记不可运行。
- 同输入匹配到多个配方：机器应标记不可运行并提示“配方决策冲突”。
- 输入项为 0 或负值：视为非法配方。
- 库存扣减后不得出现负数。
- 多输出配方在 Stage1 被自动匹配到时，应阻止启动并给出“暂未开放”提示。

## 11. 运行时约束

- 仿真内核采用 TypeScript 逻辑实现，不依赖游戏引擎生命周期。
- 计算能力扩展优先通过 Worker 并行，而非引入游戏引擎。
- Phase1 暂不执行性能基线压测验收。

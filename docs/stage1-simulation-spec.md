# Stage1 仿真规范（Draft）

## 1. 仿真时钟

- 使用固定步进离散 tick。
- 目标频率：10~20Hz。
- 每个 tick 按统一顺序遍历机器并结算。

## 2. 资源与库存规则

- `ore` 来源无限，但需计入消耗统计。
- `power` 来源无限，但需计入消耗统计。
- 其他物品必须由产线产出并写入全局库存。
- Stage1 仅全局库存，不引入机器内部缓存。
- 外部物品输入仅允许来自“物品取货口”。
- 配方允许多输出定义，但 Stage1 仅执行单输出配方。
- `originium_ore`（源石矿）仅允许来自物品取货口，不可由配方产出。

首批冻结配方：

- 粉碎机：`1 originium_ore -> 2 秒 -> 1 originium_powder`。

## 3. 机器状态机

状态枚举：

- `running`：可持续推进并完成结算。
- `starved`：到达结算点但输入不足。
- `paused`：全局模拟暂停。
- `disabled`：机器被禁用，不参与推进。
- `unpowered`：机器未被供电桩覆盖，不参与推进。

状态转移规则（简化）：

- 输入不足时：`running -> starved`
- 下次输入满足并允许运行时：`starved -> running`
- 全局暂停时：进入 `paused`
- 无供电时：进入 `unpowered`

## 4. 每 tick 结算顺序

1. 跳过 `disabled` 机器。
2. 对运行机器增加 `progress`。
3. 当 `progress >= recipe.time` 触发结算尝试。
4. 检查 `inputs` 是否满足。
5. 满足：
   - 扣减输入库存。
   - 增加输出库存。
   - 累计 `ore/power` 消耗。
   - `progress -= recipe.time`（保留余量）。
6. 不满足：
   - 不扣减库存。
   - 标记 `starved` 并记录缺失输入。

## 5. 统计口径

必须输出：

- 当前库存：`inventory[itemId]`
- 净产量（/min）：按最近 60 秒滑动窗口计算
- 矿石消耗（/min）
- 电力消耗（/min）

规则：

- 统一使用最近 60 秒窗口计算所有 `/min` 指标，减少瞬时抖动。

## 6. 控制操作语义

- 开始模拟：进入 tick 循环。
- 暂停模拟：停止推进与结算。
- 重置库存：将库存重置为初始值；累计统计可选“保留/清零”，需在实现前固定。

## 7. 特殊建筑规则

- 物品取货口：仅在满足边缘摆放约束时生效，并按配置提供外部输入。
- 供电桩：建筑任意格位于“以供电桩中心为基准的 8x8 矩形范围”即视为有电。
- 物流存储箱：可从库存中按配置速率提交至系统外（视为工业系统外流出）。

## 8. 传送带节点调度

- 交叉节点：两路对向链路互不干扰。
- 分流节点：按左/中/右顺序轮询出口（顺时针定义）。
- 汇流节点：按左/中/右顺序轮询入口（顺时针定义）。
- 传送带重叠视为非法拓扑，禁止创建。
- 传送带移动速度固定为每 2 秒 1 格。

## 9. 配方兼容策略

- `outputs.length = 1`：按常规流程结算。
- `outputs.length > 1`：Stage1 标记为“已兼容未启用”，不进入生产结算。
- 多输出配方的数据需可正常读取、展示、保存与加载。

## 10. 异常与边界

- 配方不存在：机器应标记不可运行。
- 输入项为 0 或负值：视为非法配方。
- 库存扣减后不得出现负数。
- 多输出配方在 Stage1 被选择时，应阻止启动并给出“暂未开放”提示。

## 11. 运行时约束

- 仿真内核采用 TypeScript 逻辑实现，不依赖游戏引擎生命周期。
- 计算能力扩展优先通过 Worker 并行，而非引入游戏引擎。

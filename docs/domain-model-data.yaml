version: 2
name: IndustrialPlanner Domain Model Data
scope: project
updatedAt: 2026-02-18

# 统一约定：
# - 设备端口均以 0° 为基准定义，运行时按 90°倍数旋转。
# - 坐标以设备左上角为原点，localCellX/localCellY 为占格内坐标。
# - edge: N/S/E/W；direction: Input/Output。
# - 同一设备同一占格边（localCellX/localCellY/edge）允许“最多一个 Input + 最多一个 Output”。
# - 若同一边出现同方向重复端口（如两个 Input），属于端口定义冲突。
# - 端口可配置 allowedItems + allowedTypes。
# - 当前默认策略：大多数建筑端口 allowedTypes=[solid]，allowedItems.mode=recipe_items。
# - pickup_port 的可选物品配置使用 allowedItems.mode=any。
# - 未来可切换 allowedItems.mode=whitelist。
# - 时间型配方参数统一使用“标准秒”表达（例如 cycleSeconds），运行时按当前 tickRateHz 换算为 tick。

conventions:
  orientationBase: "0deg"
  timeTerminology:
    standardSecond:
      description: 规则层固定时间单位，不受仿真倍速影响
      tickMappingAt20Hz: 20
    standardMinute:
      description: 规则层固定时间单位，不受仿真倍速影响
      tickMappingAt20Hz: 1200
  runtimeKinds:
    - processor
    - storage
    - conveyor
    - junction
  itemTypes:
    - solid
    - liquid
  stallReasons:
    - NONE
    - NO_POWER
    - OVERLAP
    - NO_INPUT
    - OUTPUT_BLOCKED
    - CONFIG_ERROR
  portAllowance:
    perEdgeCardinality:
      maxInputPorts: 1
      maxOutputPorts: 1
      allowInputAndOutputOnSameEdge: true
    conflictHandling:
      duplicatePortKeyPolicy: config_error
      portKey: [deviceInstance, localCellX, localCellY, edge, direction]
    allowedItems:
      modeValues:
        - recipe_items
        - recipe_inputs
        - recipe_outputs
        - whitelist
        - any
      whitelistEffectiveWhenMode: whitelist
    allowedTypes:
      modeValues:
        - whitelist
        - solid
        - liquid
      whitelistEffectiveWhenMode: whitelist
  defaultPortAllowance:
    allowedItems:
      mode: recipe_items
      whitelist: []
    allowedTypes:
      mode: solid
      whitelist: []
  powerRequirement:
    defaultRequiresPower: false
    stage1PoweredDevices:
      - item_port_grinder_1

items:
  - id: item_originium_ore
    displayName: 源石矿
    category: ore
    type: solid
  - id: item_originium_powder
    displayName: 源石粉末
    category: product
    type: solid

recipes:
  - id: r_crusher_originium_powder_basic
    machineType: item_port_grinder_1
    cycleSeconds: 2
    inputs:
      - itemId: item_originium_ore
        amount: 1
    outputs:
      - itemId: item_originium_powder
        amount: 1

powerModel:
  sourceType: item_port_power_diffuser_1
  rule: any_cell_of_building_within_square_has_power
  discreteEvaluation:
    anchor: power_pole_top_left_cell
    anchorNotation: x_y
    inclusiveBounds: true
    xRangeFormula: x:[x-5,x+6]
    yRangeFormula: y:[y-5,y+6]
    description: 以供电桩左上角占格坐标 (x,y) 为锚点，12x12 覆盖区按闭区间判定；目标建筑任意占格落入上述 x/y 区间即视为有电。
  range:
    shape: square
    width: 12
    height: 12
    centeredOn: power_pole_center
  notes:
    - 覆盖区域定义为一个 12x12 正方形供电区，供电桩 2x2 本体位于该区域几何中心。
    - 目标建筑只要任意一格落入该 12x12 范围即判定“有电”。
    - 离散判定口径（固定）：以供电桩左上角格 (x,y) 为锚点，覆盖闭区间为 x:[x-5,x+6]、y:[y-5,y+6]（含边界）。
    - 若建筑未被任一供电桩的供电范围覆盖，则运行态可标记 NO_POWER。

logisticsRules:
  overlap:
    semantics: runtime_legality
    runtimeAllowed: false
    editorPlacementAllowed: true
    persistenceAllowed: true
    runtimeStallReason: OVERLAP
    description: 重叠属于“可编辑可落盘但运行非法”；进入仿真后命中 OVERLAP 并停机（包含传送带与节点设备）。
  allowedOperations:
    - crossing
    - splitting
    - merging
  crossing:
    deviceType: item_log_connector
    description: 同一格仅允许对侧连通交叉（N-S 与 W-E），两路互不干扰
    perChannelSlotCapacity: 1
    forbidSameEdgeTransfer: true
    directionalTransfers:
      - from: N
        to: S
      - from: S
        to: N
      - from: W
        to: E
      - from: E
        to: W
    channels:
      - pair: [N, S]
      - pair: [W, E]
  splitting:
    deviceType: item_log_splitter
    topology:
      inputs: 1
      outputs: 3
    behavior:
      policy: round_robin
      outputOrder: [left, center, right]
      orderReference: relative_to_input_heading
      allowPartialConnections: true
  merging:
    deviceType: item_log_converger
    topology:
      inputs: 3
      outputs: 1
    behavior:
      policy: round_robin
      inputOrder: [left, center, right]
      orderReference: relative_to_output_heading
      allowPartialConnections: true

# 设备定义：端口均是“占格边”而不是点。
devices:
  - id: item_port_unloader_1
    runtimeKind: storage
    requiresPower: false
    size:
      width: 3
      height: 1
    roles:
      - feeder
      - external_source
    configSchema:
      selectableSourceItem:
        type: itemId
        allowedItems:
          mode: any
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
        description: 可选择任意已定义固体物品作为取出目标（包含中间产物）
    notes:
      - item_port_unloader_1 使用固定端口，不使用动态端口。
      - 基准方向下，唯一出口位于中间格北侧；通过旋转适配不同连线方向。
      - item_port_unloader_1 不绑定 placementConstraintRef，允许自由放置与旋转。
    ports0:
      - id: p_out_mid
        localCellX: 1
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: any
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []

  - id: item_port_grinder_1
    runtimeKind: processor
    requiresPower: true
    size:
      width: 3
      height: 3
    ports0:
      - id: in_s_0
        localCellX: 0
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_inputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s_1
        localCellX: 1
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_inputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s_2
        localCellX: 2
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_inputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_0
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_outputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_1
        localCellX: 1
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_outputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_2
        localCellX: 2
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_outputs
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []

  - id: item_port_power_diffuser_1
    runtimeKind: storage
    requiresPower: false
    size:
      width: 2
      height: 2
    ports0: []
    suppliesPower: true
    powerProfile:
      rangeRef: powerModel

  - id: item_port_storager_1
    runtimeKind: storage
    requiresPower: false
    size:
      width: 3
      height: 3
    configSchema:
      submitToWarehouse:
        type: boolean
        default: true
        description: 是否将该存储箱库存按批次计入全局仓库统计池；默认开启（提交）。
    ports0:
      - id: in_s_0
        localCellX: 0
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s_1
        localCellX: 1
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s_2
        localCellX: 2
        localCellY: 2
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_0
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_1
        localCellX: 1
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n_2
        localCellX: 2
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    capabilities:
      internalStorage: true
      externalShipment: true
    shipment:
      mode: user_select
      configKey: submitToWarehouse
      defaultEnabled: true
      cadenceSeconds: 10
      batchPolicy: flush_all_items
      unit: per_batch_10s
      description: 用户可选择是否提交库存到全局仓库统计池；开启时按仿真时间每 10 秒批量提交一次该存储箱内所有物品，默认开启。

  - id: belt_straight_1x1
    runtimeKind: conveyor
    requiresPower: false
    size:
      width: 1
      height: 1
    ports0:
      - id: in_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

  - id: belt_turn_cw_1x1
    runtimeKind: conveyor
    requiresPower: false
    size:
      width: 1
      height: 1
    ports0:
      - id: in_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

  - id: belt_turn_ccw_1x1
    runtimeKind: conveyor
    requiresPower: false
    size:
      width: 1
      height: 1
    ports0:
      - id: in_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

  - id: item_log_splitter
    runtimeKind: junction
    requiresPower: false
    size:
      width: 1
      height: 1
    ports0:
      - id: in_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_s
        localCellX: 0
        localCellY: 0
        edge: S
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    behaviorRef: logisticsRules.splitting
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

  - id: item_log_converger
    runtimeKind: junction
    requiresPower: false
    size:
      width: 1
      height: 1
    ports0:
      - id: in_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s
        localCellX: 0
        localCellY: 0
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    behaviorRef: logisticsRules.merging
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

  - id: item_log_connector
    runtimeKind: junction
    requiresPower: false
    channelSlots:
      ns: 1
      we: 1
    notes:
      - bridge 无手性：不存在 left/right 两种变体。
      - bridge 有方向：仅允许 N↔S 与 W↔E 的对侧传递。
      - 禁止同边输入后从同边输出，禁止跨通道转向（如 N->E）。
    size:
      width: 1
      height: 1
    ports0:
      - id: in_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_n
        localCellX: 0
        localCellY: 0
        edge: N
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_s
        localCellX: 0
        localCellY: 0
        edge: S
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_s
        localCellX: 0
        localCellY: 0
        edge: S
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_w
        localCellX: 0
        localCellY: 0
        edge: W
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: in_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Input
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
      - id: out_e
        localCellX: 0
        localCellY: 0
        edge: E
        direction: Output
        allowedItems:
          mode: recipe_items
          whitelist: []
        allowedTypes:
          mode: solid
          whitelist: []
    behaviorRef: logisticsRules.crossing
    transferAllowance:
      allowedItems:
        mode: recipe_items
        whitelist: []
      allowedTypes:
        mode: solid
        whitelist: []

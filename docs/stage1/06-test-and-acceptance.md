# 06 测试与验收指南

## 1. 测试目标

验证 Stage1 是否满足：

- 功能完整（编辑 + 仿真 + 观测）
- 规则正确（端口连接、两阶段更新、停机判定）
- 体验一致（模式行为、禁用规则、视觉语义）

## 2. 测试分层

## 2.1 单元测试（规则层）

建议覆盖：

- 端口旋转映射（0/90/180/270）
- 连接成立四条件
- 传送带进度区间推进
- reservation 冲突仲裁稳定性
- `stallReason` 判定函数

## 2.2 集成测试（流程层）

建议覆盖：

- 从放置到成线到仿真产出的完整流程
- 设备移动/删除后拓扑重建
- 退出仿真后状态清理与二次启动一致性

## 2.3 UI 交互测试（行为层）

建议覆盖：

- 四模式切换与互斥
- `R` 旋转行为
- 物流拖拽合法/非法起终点反馈
- 删除整条联通带（4 邻接）
- `bridge` 交叉双通道独立删除

## 3. 手工验收脚本（必须）

### 用例 A：基础闭环产线

1. 放置取货口、破碎机、必要传送带
2. 配置取货口为 `originium_ore`
3. 启动仿真并观察 `originium_powder` 产出
4. 校验统计面板产量与消耗数字持续变化

预期：产线稳定运行，无异常停机。

### 用例 B：堵塞与恢复

1. 构造下游堵塞（临时移除末端存储/消费）
2. 观察带上物品停在中点附近（`progress01=0.5` 语义）
3. 恢复下游后继续流动

预期：无丢物，无穿透，恢复后继续结算。

### 用例 C：冲突仲裁

1. 构造两个上游同时向同一入口输送
2. 多 tick 观察接收行为

预期：每 tick 至多接收一个物品，且行为稳定可复现。

### 用例 D：编辑态回归

1. 框选移动一组设备
2. 旋转关键设备并重连物流
3. 删除一条联通带并重铺

预期：占格、连接、渲染与实际仿真结果一致。

### 用例 E：仿真退出清理

1. 运行一段时间后点击退出仿真
2. 检查设备进度、系统外库存、临时状态
3. 重新启动仿真

预期：不继承旧运行态，按干净初始态重新开始。

## 4. 验收判定

全部条件满足才可验收通过：

- DoD 五项全部通过
- 无 P0 缺陷
- 无数据错乱（重复结算、漏结算、库存负值）
- UI 禁用与提示行为符合仿真态限制

## 5. 缺陷分级建议

- `P0`：影响仿真正确性或核心流程不可用
- `P1`：功能可用但结果不稳定或体验严重受损
- `P2`：不影响核心目标的显示与文案问题

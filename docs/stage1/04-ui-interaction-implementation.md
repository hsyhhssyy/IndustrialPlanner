# 04 UI 与交互实现指南

## 1. 页面骨架

严格遵循三栏 + 顶栏：

- 左栏：工具栏（模式切换、设备选择、物流子模式、删除子模式）
- 中栏：网格画布（放置/拖拽/框选/铺带）
- 右栏：统计与选中对象详情
- 顶栏：仿真控制（开始/退出/倍速/提示）

地块规格（当前实现）：`60x60` 与 `40x40`，右栏支持地块切换。

## 2. 交互状态机

建议使用显式编辑模式机：

- `select`
- `place`
- `logistics`
- `delete`

并维护以下子状态：

- 当前选中对象（设备/带格/空）
- 当前设备类型（place 模式）
- 当前物流子模式（Stage1 仅传送带）
- 当前删除子模式（单格 / 整条联通带）

## 3. 选择模式

- 单击设备选中；再次点击空白取消
- 支持拖拽移动与框选移动
- `R` 键旋转选中设备
- 拖拽时展示原位置幽灵框

## 4. 放置模式

- 设备以左上角锚点放置
- 放置预览必须区分合法/非法
- 非法原因至少覆盖：越界、重叠
- 重叠属于“可摆放但非法”状态：允许落盘，进入仿真后以 `stallReason=OVERLAP` 标记并停机。
- 越界不可以落盘。也就是说不允许在放置模式放置越界设备。
- 传送带设备在放置模式时不出现在可放置设备列表。物流节点可以在放置模式手动放置。
- 放置模式手动放置 `item_log_splitter` / `item_log_converger` / `item_log_connector` 时，若目标格为 `belt_*`，则执行“覆盖替换”：删除该格被覆盖传送带，并在该格放置物流节点。

## 5. 物流模式（传送带）

路径输入规则：

- 按住左键拖拽铺设
- 仅允许格线方向；不允许单格落盘（定义：路径长度至少 2 格），但允许显示 1 格路径预览且松手不落盘
- 起点可为：设备输出端口 / 空地 / 传送带
- 终点可为：设备输入端口 / 空地 / 传送带
- 允许空地到空地形成孤立物流段

自动节点规则：

- 起点来自已有传送带：自动创建 `splitter`，原有传送带的入口方向成为 `splitter` 的入口方向。
- 终点接入已有传送带：自动创建 `merger`，原有传送带的出口方向成为 `merger` 的出口方向。
- 跨越直线带（路径内部节点）时：自动创建 `bridge`。
- 轨迹绘制过程中仅生成“临时节点预览”，不落盘：
	- 当前终点命中直线带格时，显示临时 `merger`。
	- 若继续拖拽使该格从“终点”变为“路径内部节点”，该临时节点必须即时重判为临时 `bridge`。
- 鼠标释放后，按最终路径一次性生成实际设备实例。
- 判定优先级：起点规则（`splitter`）与终点规则（`merger`）优先于路径内部跨越规则（`bridge`）。
- 禁止跨拐角带

## 6. 删除模式

- 单格删除：删除目标格设备
- 整条联通带：按 4 邻接删除整条连通传送网络中的纯传送带格（`belt_*`）
- `splitter` / `merger` / `bridge` 不属于“整条联通带”批量删除范围，遇到时停止删除遍历

## 7. 视觉规范映射

来自 UI 文档的关键语义必须落地：

- 正常设备：蓝色系；选中边框：金色；异常：红色系
- 输出端口绿色，输入端口红色，物流起点高亮黄色
- 传送带轨道双层线 + 中部方向箭头
- 工业区边界使用橙色强调
- 可编辑动作在仿真态受限（禁用 + 文案提示双反馈）

## 8. 信息面板

### 8.1 统计区

- 卡片 + 表格展示仓库内物品总量与 `/min` 变化速率
- 字段稳定排序，与仿真统计口径一致
- 统计仅基于仓库，不受当前地图设备增减影响
- `/min` 采用仿真时间口径，不受倍速按钮影响

### 8.2 详情区

- 两列键值布局
- 随选中对象类型切换设备详情/传送带详情
- 展示停机原因与关键运行字段（如 `progress01`）

## 9. 可用性守则

- 同类按钮复用一致样式与激活态
- 快捷键只保留 Stage1 必需项（如 `R`）
- 禁止新增与 PRD 无关的过滤器、浮窗、页面跳转

状态文案映射补充：

- `starved` 为显示层状态，语义等同 `Idle`（未工作）。
- 运行态枚举仍以 `stallReason` 为准，不新增 `STARVED` 枚举值。

## 10. 设备图像批量注册（实现约定）

设备图像采用“注册表驱动”而非渲染层硬编码：

- 注册入口：`src/domain/deviceSprites.ts`
- 注册结构：`DEVICE_SPRITE_REGISTRATIONS`
- 应用函数：`getDeviceSpritePath(typeId)`

批量新增设备图像时，仅需两步：

1. 将图像文件放入 `public/sprites/`。
2. 在 `DEVICE_SPRITE_REGISTRATIONS` 追加设备与文件名映射。

渲染层会自动根据 `typeId` 读取图像路径，无需再修改 `App.tsx` 的设备分支判断。

## 11. 全局提示与对话框（Toast / Modal）使用规范

Stage1 已提供统一的全局提示工具，避免业务层直接调用浏览器原生 `window.alert/window.confirm`。

### 11.1 Toast（轻提示，自动消失）

适用场景：

- 普通状态反馈（如“保存成功”“操作已完成”）
- 不要求用户确认已读

调用方式：

```ts
import { showToast } from '../../src/ui/toast'

showToast('操作成功')
showToast('规则校验失败', { variant: 'warning' })
showToast('网络异常，请稍后重试', { variant: 'error', durationMs: 3000 })
```

约束：

- 默认显示 2 秒
- 不阻塞业务流程
- 不承载“必须阅读后再继续”的关键提示

### 11.2 Modal 对话框（重要提示/确认）

统一入口：`src/ui/dialog.tsx`

#### A) Confirm（阻塞确认）

适用：危险操作、删除、覆盖等需要显式确认。

```ts
import { dialogConfirm } from '../../src/ui/dialog'

const confirmed = await dialogConfirm('确认删除所有内容吗？', {
	title: '确认',
	confirmText: '确定',
	cancelText: '取消',
	variant: 'warning',
})
if (!confirmed) return
```

#### B) Alert（阻塞版）

适用：必须中断当前流程，直到用户确认。

```ts
import { dialogAlertBlocking } from '../../src/ui/dialog'

await dialogAlertBlocking('检测到关键错误，请修复后继续。', {
	title: '提示',
	closeText: '确定',
	variant: 'error',
})
```

#### C) Alert（非阻塞版，需用户点击确定）

适用：重要提示，业务流程可继续，但要求用户“已读确认”。

```ts
import { dialogAlertNonBlocking } from '../../src/ui/dialog'

dialogAlertNonBlocking('当前存档包含旧版本设备，请尽快处理。', {
	title: '提示',
	closeText: '确定',
	variant: 'warning',
})
```

语义说明：

- 非阻塞 alert **不是 toast**
- 非阻塞 alert 不会阻塞主流程，但弹层必须用户点击“确定”才会关闭

### 11.3 i18n 接入约束

- 业务层调用时优先传入 `t('xxx.key')` 翻译后的文本
- 规则配置中的放置失败提示使用 key（例如 `violationMessageKey`）
- 禁止在业务逻辑里新增硬编码中英文混杂文案

### 11.4 选型建议（快速决策）

- 仅提示、无需确认：`showToast`
- 需要用户二选一：`dialogConfirm`
- 必须停住流程等待确认：`dialogAlertBlocking`
- 重要提示但不阻塞流程，且要求已读：`dialogAlertNonBlocking`

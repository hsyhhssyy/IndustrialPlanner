# 03 仿真引擎实现指南

## 1. Tick 循环总览

Stage1 必须使用离散 Tick，并采用两阶段更新：

- **Phase A（Plan）**：计算本 tick 将发生的交接与 reservation
- **Phase B（Commit）**：推进进度、执行交接、落地状态

禁止在单阶段中直接“读取并写入同一时刻下游状态”，否则会出现奇偶交替问题。

## 2. 通用握手接口

所有设备需实现统一端口协议：

- `canReceive(port, item)`
- `receive(port, item)`
- `canSend(port, item)`
- `send(port)`

Plan 阶段只做可行性判断与预留，Commit 阶段才真实变更容器。

## 3. 传送带双区间进度模型

## 3.1 区间定义

- `progress01 ∈ [0,1]`
- 入口段：`0.0 ~ 0.5`
- 出口段：`0.5 ~ 1.0`

## 3.2 入口段规则

- `slot != null` 即可推进至 `<= 0.5`
- 不依赖下游是否可接收

## 3.3 出口段规则

- 仅当下游在 Commit 后将有容量，才允许推进到 `> 0.5`
- 下游不可接收时，停靠在 `0.5`

## 4. Reservation 规则

下游“本 tick 可接收”定义：

1. 当前为空，或本 tick 末将腾空
2. 且入口尚未被其他上游预留

冲突处理建议：

- 先按拓扑顺序尝试
- 同优先级时按稳定键（如 `instanceId`）决策
- 决策必须稳定可复现，避免抖动

## 5. runtimeKind 运行逻辑

## 5.1 `processor`

- 输入端口共享 `inputBuffer`
- 输出端口共享 `outputBuffer`
- 满足配方输入后推进 `progress01`
- 完成周期时向 `outputBuffer` 生成产物

## 5.2 `conveyor` / `junction`

- 单槽位 `slot`，容量固定 1
- `progress01` 表示槽内物品运输进度
- 到达提交点后执行向下游交付

## 5.3 `storage`

- 提供库存存取能力
- 可接入传送带或设备端口
- 不承担生产周期逻辑

## 6. 仿真控制行为

- **开始仿真**：初始化全部 runtime state、统计采样器
- **退出仿真**：清空设备进度、系统外库存、临时队列
- **倍速切换**：仅影响单位真实时间内 tick 数，不改变单 tick 规则

## 7. 统计口径

统计面板至少输出：

- 当前库存
- 每分钟产量
- 每分钟消耗
- 设备状态

排序：矿物优先，其余按 `itemId` 字母序。

## 8. 关键边界用例（必须通过）

1. 下游堵塞时，带上物品停在 `0.5` 且不丢失
2. 下游腾空同 tick，允许平滑过中心完成交接
3. 多上游竞争同一输入端口，不会双写
4. 删除或移动设备后，下一 tick 拓扑已更新
5. 退出仿真后再次启动，不继承旧运行态

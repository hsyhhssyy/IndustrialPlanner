# Stage1 验收与测试基线（Draft）

## 1. 验收总则

Stage1 通过标准：

- 功能闭环完整（搭建、连接、运行、观测、重置）。
- 关键统计可见且数值方向正确。
- 缺料状态可触发且提示明确。
- 50 台机器以内交互与模拟可用。

## 2. 功能验收用例

## AC-00 三栏布局与信息分区

前置：进入主界面。

期望：

- 页面为左中右三栏。
- 中间是 N×N 工业网格（N 仅支持 60、80、100）。
- 右侧上半显示总统计，下半显示选中建筑详情。
- 进图默认地块尺寸为 `60x60`。

## AC-01 基础产线可运行

前置：创建“`originium_ore -> originium_powder`”产线。

期望：

- 模拟运行后 `originium_powder` 库存持续增长。
- 面板可显示 `ore/power` 消耗速率。

## AC-02 增减机器影响产量

操作：增加或删除粉碎机数量。

期望：

- `originium_powder/min` 指标出现可观测变化。

## AC-02B 倍速切换生效

操作：点击屏幕最上方“开始仿真”进入仿真，再在 1x、2x、4x 间切换，最后点击“退出仿真”。

期望：

- 开始仿真后系统进入仿真模式并开始推进。
- 2x/4x 下单位现实时间内产量高于 1x。
- 退出仿真后停止推进并返回编辑模式。
- 配方数据本身不发生变化。

## AC-02C 仿真锁编辑

操作：点击“开始仿真”后尝试放置、移动、删除、旋转、连线与地块切换。

期望：

- 仿真模式下上述编辑操作均被阻止。
- 点击“退出仿真”后，编辑操作恢复可用。

## AC-03 缺料状态可见

操作：中断上游输入或移除关键连接。

期望：

- 下游机器进入 `starved`。
- 显示缺失物品名称。

## AC-03B 重叠停机可见

操作：将两台建筑重叠放置。

期望：

- 重叠区域显示红色。
- 重叠建筑进入停机状态且不再正常产出。

## AC-04 非法连接阻断

操作：尝试 `out -> out` 或 `in -> in`。

期望：

- 连接创建失败。
- 提示非法连接。

## AC-04B 物流模式绘制连接

操作：点击“传送带”模式，选择出入口并绘制路径创建连接；再切换到“管道”模式。

期望：

- 传送带模式可成功创建连接，路径在画布中可见并保留。
- 管道模式在 Phase1 仅占位，不创建可运行连接。

## AC-05 重置库存

操作：运行一段时间后执行“重置库存”。

期望：

- 库存回到初始状态。
- 统计数据同步重置。

## AC-05B 地块尺寸切换

操作：在 60x60、80x80、100x100 间切换。

期望：

- 切换前弹窗提示将进行地块存档切换。
- 确认后先保存当前地块状态，再加载目标尺寸地块存档。
- 目标尺寸无存档时自动创建空地块存档并加载。
- Phase1 中尺寸即地块名（存档标识）。

## AC-05C 仿真频率固定 10Hz

操作：在 1x 速率下运行仿真并统计 60 秒内 tick 次数。

期望：

- 60 秒内 tick 总数为 600（允许实现层面极小计时抖动）。
- /min 统计窗口按 60 秒计算，与 10Hz 基准一致。

## AC-06 选中、旋转与工具条

操作：点击建筑使其选中，按 `R` 或点击建筑上方“旋转”按钮。

期望：

- 右侧下半区域显示该建筑详情。
- 建筑旋转 90° 步进。
- 工具条可执行旋转与删除。

## AC-06B 端口旋转自动计算

操作：加载仅包含 0° 端口配置的建筑，分别旋转至 90°/180°/270°。

期望：

- 各角度端口位置由系统自动计算，无需额外端口配置。
- 端口在不同朝向下与建筑几何关系一致。

## AC-07 运行时约束符合预期

前置：完成 Stage1 打包并在静态环境运行。

期望：

- 应用可作为纯静态前端在浏览器中运行。
- 不依赖游戏引擎运行时。
- 核心能力（画布、仿真、统计）可在该运行形态下正常工作。

## AC-08 物品取货口边缘摆放约束

操作：将 3x1 物品取货口分别摆放在边缘与非边缘位置。

期望：

- 长边贴边时为有效摆放。
- 非贴边时标记为无效且不工作。
- 中间格为唯一有效出口。
- 放置后默认不出货，需在右下详情选择物品后出货。
- 未选择物品时显示“未选物品”图标。
- “未选物品”图标符号为 `?`。

## AC-09 传送带交汇行为

操作：分别构建交叉、分流、汇流三种单格节点。

期望：

- 交叉节点两路物品互不干扰直行。
- 分流节点按左/中/右顺序轮询输出（顺时针定义）。
- 汇流节点按左/中/右顺序轮询合流输出（顺时针定义）。
- 传送带重叠创建被拒绝。
- 路径绘制过程中回头操作被拒绝。
- 删除联通传送带可直接执行，无二次确认。
- 联通删除按 4 邻接定义执行（不含对角）。

## AC-10 供电覆盖生效

操作：放置 2x2 供电桩，将建筑移入/移出其 12x12 覆盖范围。

期望：

- 以供电桩中心 12x12 矩形范围内建筑为有电状态并可运行。
- 覆盖范围外建筑为无电状态并停机。
- 停机建筑显示中心图标与红框提示。
- 供电公式按冻结规则执行：若供电桩左上角为 `(x, y)`，覆盖框左上角为 `(x - 5, y - 5)`，尺寸 `12x12`。
- 覆盖框越界时按工业区域边界裁剪后判定有电。

## AC-11 物流存储箱出货

操作：向存储箱输入物品并开启“每分钟提交系统外”。

期望：

- 存储箱可正常存储与出料。
- 系统外提交速率按配置生效。

## AC-12 灌装机端口布局

操作：放置 6x4 灌装机并验证端口边定义。

期望：

- 长边一侧为 6 个输入口。
- 对侧长边为 6 个输出口。

## AC-13 多配方自动决策

操作：为同一机器类型配置多套候选配方，调整输入物品组合。

期望：

- 界面不提供手动配方选择。
- 输入物品组合可唯一匹配时，机器自动执行对应配方。
- 输入物品组合匹配到 0 个配方时，机器报“配方决策失败”并停机。
- 输入物品组合匹配到多个配方时，机器报“配方决策冲突”并停机。

## AC-13B Phase1 Tick 顺序冻结

操作：构造可复现实例并逐 tick 记录机器状态与库存变化。

期望：

- 按冻结顺序执行：跳过 disabled -> 增加 progress -> 达到周期触发结算检查 -> 满足则扣输入加输出并累计消耗 -> 不满足则 starved。
- Phase1 以该顺序作为实现基线；后续 Phase 可调整但需更新文档。

## AC-14 双产物配方兼容（暂未开放）

操作：加载包含双产物输出的配方数据。

期望：

- 数据可被读取、展示、保存与恢复。
- Stage1 不执行该配方结算，并显示“暂未开放”。

## AC-15 首批物品来源约束

操作：在无取货口输入条件下尝试获得 `originium_ore`。

期望：

- 系统中不存在非取货口来源的 `originium_ore`。

## AC-16 粉碎机首批配方

操作：为粉碎机提供 `originium_ore` 输入并运行。

期望：

- 每消耗 1 个 `originium_ore`，在 2 秒后产出 1 个 `originium_powder`。

## AC-17 传送带速度固定

操作：观察单个物品在传送带上的格子位移。

期望：

- 物品每 2 秒前进 1 格。
- 倍速切换影响时间流逝速率，但不改变该基础速度定义。

## AC-18 外部仓库回取

操作：将非矿物品提交到系统外仓库后，通过取货口取回。

期望：

- 可按系统外库存数量取回非矿物品。
- `originium_ore` 取回不受库存上限影响。

## AC-19 右上仓库统计展示

操作：运行生产并执行系统外提交。

期望：

- 右侧上半显示每种物品当前存量。
- 右侧上半显示每种物品每分钟生产与每分钟消耗。
- 矿物库存显示为“无穷”。
- 物品排序为矿优先、粉末次之，其余按 `itemId` 字母序。

## AC-20 外部仓库无手动清空

操作：检查系统外仓库交互入口。

期望：

- Phase1 不提供仓库手动清空按钮。

## 3. 性能基线

- Phase1 暂不作为验收门槛，后续阶段再单独评估。

## 4. 回归清单（最小）

- 新建/删除机器
- 创建/删除连接
- 顶部开始仿真/退出仿真
- 倍速切换（1x/2x/4x）
- 仿真模式锁编辑
- 选中后 `R` 旋转
- 端口旋转自动计算
- 重叠红色提示与停机
- 物流模式路径绘制
- 传送带交汇（交叉/分流/汇流）
- 供电覆盖判定
- 取货口边缘摆放有效性
- 多配方自动决策
- 双产物配方兼容加载
- 源石矿来源约束
- 粉碎机首批配方
- 传送带固定速度
- 地块尺寸切换存档切换确认
- 外部仓库提交与回取
- 右上仓库统计展示
- 外部仓库无手动清空
- 统计面板刷新
- localStorage 读写恢复

执行方式：

- Stage1 采用人工干预测试执行上述回归清单。
- 本阶段不强制引入 Playwright。

## 5. 非目标说明

- 不验证自动布局优化（Stage2）。
- 不验证传送带寻路与长度约束。
- 不引入游戏引擎作为 Stage1 运行时。

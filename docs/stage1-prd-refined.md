# Stage1 PRD 细化版（Draft）

## 1. 范围定义

### 1.0 当前阶段定位

- 当前执行阶段为 **Stage1 Phase1**。
- Phase1 目标是交付“完整可用网站（MVP）”。
- Phase1 冻结范围：6 个建筑、2 种物品、1 个启用配方。

### 1.1 目标

Stage1 提供可玩的工业模拟闭环，用户可完成：

- 放置机器
- 连接机器
- 选择配方
- 启动/暂停模拟
- 查看库存与产线统计
- 识别缺料状态

### 1.2 范围边界

本阶段不包含：

- 自动布局优化
- 传送带寻路
- 局部库存与物流延迟
- Phase1 之外的新增建筑与新增启用配方

### 1.3 Phase1 冻结清单

- 建筑：`pickup_port_3x1`、`crusher_3x3`、`power_pole_2x2`、`storage_box_3x3`、`filler_6x4`、传送带节点系统。
- 物品：`originium_ore`、`originium_powder`。
- 启用配方：`r_crusher_originium_powder_basic`。

## 2. 功能需求细化

## 2.0 页面分区布局

### FR-LAYOUT-01 三栏结构

- 页面分为左、中、右三个区域。
- 左侧为工具栏区域。
- 中间为工业区域（N 行 N 列网格）。
- 右侧为信息面板区域。

### FR-LAYOUT-02 右侧信息分区

- 右侧上半部分展示全局统计。
- 右侧下半部分展示当前选中建筑详情。

## 2.1 画布系统（Grid Canvas）

### FR-CANVAS-01 网格与坐标

- 画布使用整数网格坐标。
- 机器位置以左上角网格坐标记录。
- 工业区域为有限 N×N 网格。

### FR-CANVAS-02 机器放置与移动

- 支持从左侧工具栏拖入建筑到工业区域进行放置。
- 支持拖拽移动机器。
- 支持框选后整体移动。
- 拖出工业区域视为删除建筑。

### FR-CANVAS-03 删除与编辑

- 支持删除单台机器。
- 删除机器时应同步删除关联连接。
- 选中建筑后支持快捷删除与工具条删除。

### FR-CANVAS-04 视图控制

- 支持滚轮缩放。
- 支持平移。
- 缩放按整格数调整视口可见格数。
- 最小缩放时可看到整个工业区域。

### FR-CANVAS-05 建筑旋转与选中工具条

- 点击建筑可选中。
- 选中建筑时，建筑上方显示悬浮工具条（旋转、删除）。
- 建筑处于选中状态时，按 `R` 可旋转建筑。

### FR-CANVAS-06 重叠规则

- 建筑允许重叠摆放。
- 发生重叠时，重叠区域高亮为红色。
- 发生重叠的建筑不可正常工作（结算禁用）。

## 2.2 连接系统（逻辑连接）

### FR-EDGE-01 连接创建

- 工具栏提供物流模式按钮（至少包含管道、传送带）。
- 进入物流模式后，用户可选择建筑出入口并绘制路径。
- 路径确认后创建逻辑连接。

### FR-EDGE-02 连接合法性

- 禁止 `out -> out`。
- 禁止 `in -> in`。
- 禁止同一连接重复创建（同 from/to）。

### FR-EDGE-03 连接删除

- 支持删除已创建连接。

### FR-EDGE-04 显示要求

- 连接可显示为直线或折线。
- Stage1 中连接路径为用户手绘结果，仅做逻辑表达，不做自动寻路。

## 2.3 模拟引擎

### FR-SIM-01 Tick 机制

- 使用固定步进离散 tick。
- tick 频率目标：10~20Hz。

### FR-SIM-02 资源规则

- 矿石（ore）视为无限可获取，但需统计消耗。
- 电力（power）视为无限可获取，但需统计消耗。
- 其他物品必须由产线产出。

### FR-SIM-02C 首批物品冻结

- 首批物品包含：`源石矿`、`原矿粉末`。
- `源石矿` 只能由物品取货口输入。
- 粉碎机配方：`1 源石矿 -> 2 秒 -> 1 原矿粉末`。

### FR-SIM-02A 配方选择规则

- 每种目标物品可配置多个配方。
- 机器可在其可用配方集合中选择一种执行。
- 配方统一表达为“若干输入 -> 固定秒数 -> 若干输出”。

### FR-SIM-02B 多产物配方兼容（暂不实现）

- 数据结构需兼容“一个配方产出两种物品”。
- 多产物可指定不同出口端口。
- Stage1 暂不启用多产物配方实际结算，仅要求可读取与存档兼容。

### FR-SIM-03 机器结算逻辑

每个 tick：

1. 更新机器进度。
2. 达到配方周期时尝试结算。
3. 检查输入库存是否满足。
4. 满足则扣输入、加输出、累计矿电消耗。
5. 不满足则机器状态变更为“缺料”。
6. 建筑重叠时机器状态变更为“重叠停机”，不推进生产。

### FR-SIM-04 运行倍速控制

- 提供暂停、1 倍速、2 倍速、4 倍速控制。
- 数据配置基准为 1 倍速。
- 倍速仅改变仿真推进速率，不改变配方基准数据。

## 2.4 库存系统

### FR-INV-01 全局库存

- 使用全局库存记录所有物品数量。
- Stage1 不区分机器内部缓冲。

### FR-INV-02 重置能力

- 支持用户重置库存。

## 2.5 统计面板

### FR-PANEL-01 必显指标

- 每种物品库存。
- 每种物品净产量（/min）。
- 矿石消耗（/min）。
- 电力消耗（/min）。
- 机器运行状态（运行中 / 缺某物）。

### FR-PANEL-02 当前选中建筑详情

- 显示选中建筑的基础信息（类型、坐标、朝向）。
- 显示选中建筑当前状态（运行、缺料、重叠停机）。
- 显示选中建筑关联配方与输入输出信息。

## 2.6 基础操作

### FR-OPS-01 操作集合

- 新建机器
- 删除机器
- 删除连接
- 暂停/1x/2x/4x 模拟速率切换
- 重置库存
- 物流模式切换（管道/传送带）

## 2.7 建筑模板与物流规则

### FR-BUILD-01 物品取货口

- 尺寸为 3x1。
- 必须长边贴工业区边缘才算有效摆放。
- 中间格为唯一有效出口。
- 可配置输出任意物品类型。
- Stage1 中其为唯一外部进料口类型。

### FR-BUILD-02 粉碎机

- 尺寸为 3x3。
- 一整边 3 格为输入口。
- 对边 3 格为输出口。

### FR-BUILD-03 供电桩

- 尺寸为 2x2。
- 建筑任意格位于“以供电桩中心为基准的 8x8 矩形范围”即视为有电。
- 无电建筑不可正常工作。

### FR-BUILD-04 物流存储箱

- 尺寸为 3x3。
- 一整边输入，对边输出。
- 可存储物品。
- 可配置按每分钟速率将存储物品提交到系统外。

### FR-BUILD-05 灌装机

- 尺寸为 6x4。
- 两条长度为 6 的长边分别作为输入边与输出边。
- 总计 6 个输入口、6 个输出口。

### FR-BELT-01 传送带交汇规则

- 传送带格子不允许重叠。
- 仅允许交叉、分流、汇流三种操作。

### FR-BELT-02 交叉规则

- 单格内可同时存在两条对向连通路径。
- 两条路径互不干扰并直行通过。

### FR-BELT-03 分流规则

- 单格 1 边入口，3 边出口。
- 物品按照左/中/右顺序轮询分配（顺时针定义）。

### FR-BELT-04 汇流规则

- 单格 3 边入口，1 边出口。
- 多入口物品按照左/中/右顺序轮询出格（顺时针定义）。

### FR-BELT-05 传送带速度

- 传送带移动速度固定为每 2 秒 1 格。

## 3. 非功能需求

### NFR-01 架构边界

- 纯前端实现，不依赖后端服务。

### NFR-02 存档

- 支持 localStorage 本地存档。

### NFR-03 性能

- 在 50 台机器以内保持可用流畅交互与稳定模拟。

### NFR-04 运行时与引擎约束

- Stage1 当前不采用游戏引擎。
- 运行形态为浏览器原生 Web 前端（静态资源 + JS/Worker）。
- 该约束用于降低包体、复杂度与部署成本（目标兼容 GitHub Pages）。

## 4. 完成标志（DoD）

满足以下条件视为 Stage1 完成：

1. 用户可搭建“矿 -> 锭 -> 齿轮”两级产线。
2. 通过增减机器可观察产量变化。
3. 缺料时能看到具体缺料提示。
4. 可看到矿石与电力消耗统计。

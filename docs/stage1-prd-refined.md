# Stage1 PRD 细化版（Draft）

## 1. 范围定义

### 1.0 当前阶段定位

- 当前执行阶段为 **Stage1 Phase1**。
- Phase1 目标是交付“完整可用网站（MVP）”。
- Phase1 冻结范围：6 个建筑、2 种物品、1 个启用配方。

### 1.1 目标

Stage1 提供可玩的工业模拟闭环，用户可完成：

- 放置机器
- 连接机器
- 机器根据输入自动决定配方
- 开始仿真/退出仿真
- 查看库存与产线统计
- 识别缺料状态

### 1.2 范围边界

本阶段不包含：

- 自动布局优化
- 传送带寻路
- 局部库存与物流延迟
- Phase1 之外的新增建筑与新增启用配方

### 1.3 Phase1 冻结清单

- 建筑：`pickup_port_3x1`、`crusher_3x3`、`power_pole_2x2`、`storage_box_3x3`、`filler_6x4`、传送带节点系统。
- 物品：`originium_ore`、`originium_powder`。
- 启用配方：`r_crusher_originium_powder_basic`。
- 地块尺寸选择：`100x100`、`80x80`、`60x60`。

## 2. 功能需求细化

## 2.0 页面分区布局

### FR-LAYOUT-01 三栏结构

- 页面分为左、中、右三个区域。
- 左侧为工具栏区域。
- 中间为工业区域（N 行 N 列网格）。
- 右侧为信息面板区域。

### FR-LAYOUT-04 顶部仿真控制条

- 页面最上方提供固定仿真控制条。
- 控制条包含“开始仿真/退出仿真”与倍速按钮（1x/2x/4x）。
- 进入仿真后保留顶部控制条可见。

### FR-LAYOUT-03 地块尺寸选择

- Phase1 提供地块尺寸选项：`100x100`、`80x80`、`60x60`。
- 进图默认尺寸为 `60x60`。
- 用户切换尺寸时，必须弹窗确认。
- 确认后先保存当前地块存档，再加载目标尺寸对应地块存档。
- 若目标尺寸地块不存在存档，则创建该尺寸空地块存档并加载。
- Phase1 约定“尺寸即地块名（存档标识）”；未来可扩展为“地块名 + 尺寸”。

### FR-LAYOUT-02 右侧信息分区

- 右侧上半部分展示全局统计。
- 右侧下半部分展示当前选中建筑详情。

## 2.1 画布系统（Grid Canvas）

### FR-CANVAS-01 网格与坐标

- 画布使用整数网格坐标。
- 机器位置以左上角网格坐标记录。
- 工业区域为有限 N×N 网格。

### FR-CANVAS-02 机器放置与移动

- 支持在“放置模式”下点击工业区域放置建筑。
- 支持拖拽移动机器。
- 支持框选后整体移动。
- 删除行为由“删除模式”执行，不采用拖出边界删除。

### FR-CANVAS-03 删除与编辑

- 支持删除单台机器。
- 删除机器时保留所有传送带格子与带段，仅清理指向被删机器的连接引用（`beltEdge`）。
- 选中建筑后支持快捷删除与工具条删除。

### FR-CANVAS-04 视图控制

- 支持滚轮缩放。
- 支持平移。
- 缩放允许连续倍率变化，不要求整格步进。
- 最小缩放时可看到整个工业区域。

### FR-CANVAS-05 建筑旋转与选中工具条

- 点击建筑可选中。
- 选中建筑时，建筑上方显示悬浮工具条（旋转、删除）。
- 建筑处于选中状态时，按 `R` 可旋转建筑。
- 建筑仅允许按 90° 整数倍旋转。
- 配置文件仅提供 0° 朝向端口布局，90°/180°/270° 端口坐标由运行时自动计算。
- 端口随建筑旋转保持相对布局不变（局部坐标旋转）。
- 建筑旋转围绕几何中心执行（非左上角原地旋转）。
- 端口方向使用显式字段 `direction`，并随旋转同步更新。

### FR-CANVAS-06 重叠规则

- 建筑允许重叠摆放。
- 发生重叠时，重叠区域高亮为红色。
- 发生重叠的建筑不可正常工作（结算禁用）。

## 2.2 连接系统（逻辑连接）

### FR-EDGE-01 连接创建

- 工具栏提供物流模式按钮（至少包含管道、传送带）。
- 管道模式在 Phase1 仅占位展示，不参与连线结算；传送带模式可完整创建与删除。
- 进入物流模式后，用户可选择建筑出入口并绘制路径。
- 路径确认后先创建传送带路径本体；若满足 `out -> in` 则额外创建逻辑连接。

### FR-EDGE-01A 传送带绘制规则

- 按住左键拖拽逐格铺设；松开后结束一次绘制。
- 起点不能是输入端口；若起点位于机器本体，仅允许从输出端口起笔。
- 绘制过程中允许单步回退（拖回上一步网格），不允许沿已有同段继续铺设。
- 路径仅允许沿格线方向，不允许曲线。
- 路径进入机器本体时，必须进入输入端口格，且进入方向与端口 `direction` 一致。
- 从输出端口离开时，离开方向必须与端口 `direction` 一致。
- 传送带路径可独立存在，不要求必须形成 `out -> in`。
- 当形成 `out -> in` 时，系统同步记录逻辑连接用于仿真连接关系。

### FR-EDGE-01B 传送带节点规则（分流/汇流/桥接）

- 桥接（桥）：节点四向连通且两横两纵，作为直行交叉节点。
- 分流（分）：节点满足单入多出（`inCount = 1`，`outCount >= 2`）。
- 汇流（汇）：节点满足多入单出（`outCount = 1`，`inCount >= 2`）。
- 若节点从 3 向扩展为 4 向且本次绘制将其作为拐点或端点，必须满足分流/汇流；否则拒绝铺设。
- 禁止传送带对撞（同轴双入或同轴双出）。

### FR-EDGE-02 连接合法性

- 禁止 `out -> out`。
- 禁止 `in -> in`。
- 禁止同一连接重复创建（同 from/to）。

### FR-EDGE-03 连接删除

- 支持删除已创建连接。

### FR-EDGE-03A 传送带删除模式


- 在“删除模式”下提供两种传送带删除方式：
	- 按格删除（逐格）
	- 删除整条联通传送带
- 删除整条联通传送带不需要二次确认。
- 联通定义采用 4 邻接（上/下/左/右），不包含对角。

### FR-EDGE-04 显示要求

- 连接可显示为直线或折线。
- Stage1 中连接路径为用户手绘结果，仅做逻辑表达，不做自动寻路。

## 2.3 模拟引擎

### FR-SIM-01 Tick 机制

- 使用固定步进离散 tick。
- tick 频率固定：10Hz。

### FR-SIM-02 资源规则

- 矿石（ore）视为无限可获取，但需统计消耗。
- 电力（power）视为无限可获取，但需统计消耗。
- 其他物品必须由产线产出。

### FR-SIM-02D 外部仓库规则

- 工业地块外视为一个无限容量的系统外仓库。
- 存储箱可将物品提交到系统外仓库。
- 取货口可从系统外仓库取回物品。
- `originium_ore` 为系统外无限物品；其他物品受系统外仓库库存约束。
- Phase1 不提供外部仓库“手动清空”按钮。

### FR-SIM-02C 首批物品冻结

- 首批物品包含：`源石矿`、`原矿粉末`。
- `源石矿` 只能由物品取货口输入。
- 粉碎机配方：`1 源石矿 -> 2 秒 -> 1 原矿粉末`。

### FR-SIM-02A 配方决策规则

- 每种目标物品可配置多个配方。
- 对于给定“机器类型 + 输入物品组合”，可产出物品固定。
- Stage1 不提供手动选配方；机器在运行时根据输入物品自动匹配可执行配方。
- 对于同一机器类型，输入物品组合必须唯一决定 1 个配方。
- 若自动匹配结果为 0 个或大于 1 个，机器进入错误状态并向用户报错，不执行结算。
- 配方统一表达为“若干输入 -> 固定秒数 -> 若干输出”。

### FR-SIM-02B 多产物配方兼容（暂不实现）

- 数据结构需兼容“一个配方产出两种物品”。
- 多产物可指定不同出口端口。
- Stage1 暂不启用多产物配方实际结算，仅要求可读取与存档兼容。

### FR-SIM-03 机器结算逻辑

每个 tick：

1. 更新机器进度。
2. 达到配方周期时尝试结算。
3. 检查输入库存是否满足。
4. 满足则扣输入、加输出、累计矿电消耗。
5. 不满足则机器状态变更为“缺料”。
6. 建筑重叠时机器状态变更为“重叠停机”，不推进生产。

### FR-SIM-04 运行倍速控制

- 顶部仿真控制条提供“开始仿真/退出仿真”与 1 倍速、2 倍速、4 倍速控制。
- 进入仿真时，系统从“编辑模式”切换为“仿真模式”。
- 仿真模式下禁止编辑工业区内容（放置、移动、删除、旋转、连线、地块切换）。
- 退出仿真后回到编辑模式并恢复编辑能力。
- 退出仿真时必须执行全量运行态重置：清空系统外仓库库存（全局库存）、机器进度、机器内部物品、传送带在途物品与其他运行期临时数据。
- 数据配置基准为 1 倍速。
- 倍速仅改变仿真推进速率，不改变配方基准数据。

## 2.4 库存系统

### FR-INV-01 全局库存

- 全局库存定义为“系统外库存”（系统外仓库库存）。
- 全局库存不包含工业地块上的机器、物流系统与仓储建筑内物品。
- 地块内物品可在机器/传送带/存储箱等容器中流转，但不计入全局库存。

### FR-INV-02 重置能力

- 支持用户重置库存。
- 重置库存时执行与“退出仿真”一致的全量运行态重置（系统外仓库库存、机器进度、机器内部物品、传送带在途物品、运行期临时数据），并同步重置统计数据。

## 2.5 统计面板

### FR-PANEL-01 必显指标

- 系统外仓库每种物品当前存量（即全局库存，矿物显示为无穷）。
- 每种物品每分钟生产（/min）。
- 每种物品每分钟消耗（/min）。
- 机器运行状态（运行中 / 缺某物）。
- 物品排序规则：`originium_ore` 优先，其次 `originium_powder`，其余按 `itemId` 字母序。

### FR-PANEL-02 当前选中建筑详情

- 显示选中建筑的基础信息（类型、坐标、朝向）。
- 显示选中建筑当前状态（运行、缺料、重叠停机）。
- 显示选中建筑关联配方与输入输出信息。
- 选中物品取货口后，可在右下详情区选择输出物品。
- 若取货口未选择物品，显示“未选择物品”图标提示。
- “未选择物品”图标默认使用 `?`。

## 2.6 基础操作

### FR-OPS-01 操作集合

- 新建机器
- 删除机器
- 删除连接
- 开始仿真/退出仿真
- 1x/2x/4x 模拟速率切换
- 重置库存
- 物流模式切换（管道占位/传送带可用）
- 地块尺寸切换（含存档切换确认）

### FR-OPS-02 地块切换副作用

- 切换地块尺寸时必须弹窗提示将进行地块存档切换。
- 用户确认后，保存当前地块状态并加载目标尺寸地块存档。
- 若目标尺寸无存档，则创建空档并加载。

### FR-UX-01 Phase1 简化外观

- 建筑外观统一为粗边框矩形。
- 出入口格使用箭头表示方向。
- 建筑名称使用汉字显示在建筑中央。
- 建筑旋转时名称保持正向显示，不随建筑旋转。

### FR-UX-02 停机提示样式

- 无电、重叠、缺料停机时，在机器中心显示状态图标。
- 同时对机器边缘显示红框提示。

## 2.7 建筑模板与物流规则

### FR-BUILD-01 物品取货口

- 尺寸为 3x1。
- 必须长边贴工业区边缘才算有效摆放。
- 中间格为唯一有效出口。
- 可配置输出任意物品类型。
- Stage1 中其为唯一外部进料口类型。

### FR-BUILD-02 粉碎机

- 尺寸为 3x3。
- 一整边 3 格为输入口。
- 对边 3 格为输出口。

### FR-BUILD-03 供电桩

- 尺寸为 2x2。
- 建筑任意格位于“以供电桩中心为基准的 12x12 矩形范围”即视为有电。
- 无电建筑不可正常工作。
- 该 12x12 范围中间为供电桩 2x2 本体区域。
- 冻结坐标公式：若供电桩左上角为 `(x, y)`，则覆盖范围左上角为 `(x - 5, y - 5)`，覆盖宽高为 `12x12`。
- 覆盖判定采用“格坐标落入”规则：目标建筑任一格坐标落入该范围即判定有电。
- 覆盖范围超出工业区域边界时，按工业区域边界裁剪后再判定。

### FR-BUILD-04 物流存储箱

- 尺寸为 3x3。
- 一整边输入，对边输出。
- 可存储物品。
- 可配置按每分钟速率将存储物品提交到系统外。

### FR-BUILD-05 灌装机

- 尺寸为 6x4。
- 两条长度为 6 的长边分别作为输入边与输出边。
- 总计 6 个输入口、6 个输出口。

### FR-BELT-01 传送带交汇规则

- 传送带格子不允许重叠。
- 节点支持桥接（交叉直行）、分流、汇流三种形态。

### FR-BELT-02 交叉规则

- 单格内可同时存在两条对向连通路径。
- 两条路径互不干扰并直行通过。

### FR-BELT-03 分流规则

- 节点满足单入多出（`inCount = 1`，`outCount >= 2`）。
- 当节点由 3 向扩展为 4 向且本次绘制将其作为拐点/端点时，必须形成分流或汇流。

### FR-BELT-04 汇流规则

- 节点满足多入单出（`outCount = 1`，`inCount >= 2`）。
- 禁止同轴对撞（同轴双入或同轴双出）。

### FR-BELT-05 传送带速度

- 传送带移动速度固定为每 2 秒 1 格。
- 在 2x/4x 倍速下按整倍数加速推进。

## 3. 非功能需求

### NFR-01 架构边界

- 纯前端实现，不依赖后端服务。

### NFR-02 存档

- 支持 localStorage 本地存档。

### NFR-03 性能

- 性能基线在 Phase1 暂不作为验收门槛，后续阶段单独评估。

### NFR-04 运行时与引擎约束

- Stage1 当前不采用游戏引擎。
- 运行形态为浏览器原生 Web 前端（静态资源 + JS/Worker）。
- 该约束用于降低包体、复杂度与部署成本（目标兼容 GitHub Pages）。

## 4. 完成标志（DoD）

满足以下条件视为 Stage1 完成：

1. 用户可搭建并运行 `originium_ore -> originium_powder` 基础产线。
2. 通过增减机器可观察产量变化。
3. 缺料时能看到具体缺料提示。
4. 可看到矿石与电力消耗统计。

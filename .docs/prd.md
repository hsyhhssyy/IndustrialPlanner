# 终末地集成工业系统仿真器

# Product Requirements Document（PRD）

## Stage1 冻结版（完整规格）

---

# 0. Background

## 0.1 项目背景

本项目用于模拟《明日方舟：终末地》中的“集成工业系统”，构建一个规则显式、可计算、可扩展的工业仿真软件。

本项目定位为：

> 工业系统仿真与规则验证工具
> 而非原创工业游戏

本项目目标：

* 对终末地工业规则进行结构化建模
* 实现端口级显式连接
* 实现离散 Tick 仿真
* 保持架构可扩展至自动求解与流体工业

本项目：

* 不依赖游戏源码
* 不进行视觉资产复刻
* 不包含商业发行目标
* 专注规则与仿真一致性

---

## 0.2 技术约束

* 纯前端实现
* 不依赖后端服务
* 可离线运行
* 使用浏览器原生 Web 技术
* 使用 localStorage 进行存档
* 可部署至 GitHub Pages
* 不使用游戏引擎

---

## 0.3 阶段规划

### Stage1（当前阶段）

* 建立稳定的工业建模框架
* 验证端口邻接规则
* 实现基础闭环产线
* 建立统一运行时状态模型

### Stage2

* 增加更多配方
* 启用多产物配方
* 引入更复杂输入组合

### Stage3

* 自动产线布局计算
* 目标产量反推设备数量
* 图搜索 / 优化算法

### Stage4

* 引入管道系统
* 引入液体工业
* 扩展流体仿真模型

---

# 1. Stage1 范围定义

## 1.1 阶段目标

用户可以：

* 放置设备
* 旋转设备
* 拖拽移动设备
* 框选移动
* 删除设备
* 绘制传送带
* 自动创建分流/汇流/桥接节点
* 运行仿真
* 查看库存与统计
* 识别停机原因

---

## 1.2 冻结清单

### 设备（10类）

* item_port_unloader_1
* item_port_grinder_1
* item_port_power_diffuser_1
* item_port_storager_1
* belt_straight_1x1
* belt_turn_cw_1x1
* belt_turn_ccw_1x1
* item_log_splitter
* item_log_converger
* item_log_connector

### 物品

* item_originium_ore
* item_originium_powder

### 启用配方

* r_crusher_originium_powder_basic

---

## 1.3 不包含

* 自动布局
* 寻路
* 局部库存延迟
* 物流延迟建模
* 多产物实际结算

## 1.4 UI 语言与国际化（Stage1 新增）

Stage1 UI 语言要求：

* 必须支持 `中文` 与 `英文` 两种界面语言。
* 页面左上角必须提供语言切换入口，切换后立即生效。
* 语言选择应持久化（刷新页面后保持上次选择）。
* 模式名称、按钮文案、面板标题、表头、详情标签等核心 UI 文本必须接入 i18n 词典。
* 未接入翻译的文本视为缺陷（不得出现中英混杂或硬编码文案漂移）。

---

# 2. 核心建模原则（冻结）

---

## 2.1 全设备化建模

* 工业区内所有对象均为设备实例
* 传送带每格为设备
* splitter/merger/bridge 必须为显式设备
* 禁止隐式节点
* 禁止“动态连接对象”

---

## 2.2 领域模型必须声明 runtimeKind

每个设备类型必须声明：

```
runtimeKind:
  - processor
  - storage
  - conveyor
  - junction
```

运行时状态由 runtimeKind 决定。

每个设备类型还必须声明：

* requiresPower（是否需要供电才能运转）

每个设备类型可选声明：

* tags: string[]（用于标记建筑特殊功能或特性，可为空或包含多个字符串）

Stage1 当前口径：

* 仅 item_port_grinder_1 需要供电
* 其他设备 requiresPower=false

## 2.3 编辑可落盘 vs 规则合法性（统一定义）

* 编辑器允许将“规则不合法”的布局落盘，以保留用户操作结果。
* “规则不合法”不等于“禁止编辑提交”：例如重叠可落盘，但属于非法布局。
* 进入仿真后，非法布局必须按运行态规则立即标记停机原因（如 `OVERLAP` / `CONFIG_ERROR`）。

---

# 3. 端口模型（冻结）

---

## 3.1 端口几何定义

端口不是点，不是格子。

端口定义为：

> 设备占据的某个格子的某一条边

字段：

* localCellX
* localCellY
* edge（N / S / E / W）
* direction（Input / Output）
* allowedItems（mode + whitelist）
* allowedTypes

同边端口基数约束（冻结）：

* 在同一设备的同一占格边（`localCellX + localCellY + edge`）上，允许同时存在 Input 与 Output 端口。
* 但每个方向最多各 1 个：最多 1 个 Input + 最多 1 个 Output。
* 若同一边出现 2 个及以上同方向端口（如 2 个 Input），判定为端口定义冲突。

---

## 3.2 旋转规则

* 仅提供 0° 布局
* 运行时按 90° 旋转
* 围绕几何中心
* 端口 edge 同步旋转
* 设备名称不旋转

---

## 3.3 连接成立条件

连接成立必须满足：

1. 两端口处于同一公共边
2. edge 相对
3. 一入一出
4. 物品类型兼容

端口匹配键与冲突处理：

* 端口匹配键：`(instanceId, localCellX, localCellY, edge, direction)`。
* 同一设备内若出现相同匹配键重复，属于非法定义，需要修复领域模型。
* `item_log_connector` 的 `in_n/out_n` 等“同边一入一出”属于合法定义。

系统不存在寻路。

---

## 3.4 统一端口握手协议

所有设备必须实现：

* canReceive(port, item)
* receive(port, item)
* canSend(port, item)
* send(port)

---

# 4. 运行时状态模型

---

## 4.1 所有设备统一字段

* progress01 ∈ [0,1]
* stallReason
* isStalled = stallReason != NONE

---

## 4.2 stallReason 枚举

* NONE
* NO_POWER（无供电覆盖/供电异常）
* OVERLAP
* NO_INPUT
* OUTPUT_BLOCKED
* CONFIG_ERROR

`CONFIG_ERROR` 判定时机（Stage1）：

* 所有配置型错误在“进入仿真”时统一校验并立即报错。
* 不等待设备首次执行到相关逻辑再报错。

---

# 5. 设备运行模型

---

## 5.1 processor（生产设备）

* inputBuffer
* outputBuffer
* progress01 表示生产周期

缓存与槽位（新增冻结口径）：

* `inputBufferSlots` / `outputBufferSlots`：输入/输出可并存物品种类数（槽位数）
* `inputBufferSlotCapacities` / `outputBufferSlotCapacities`：输入/输出缓存“按槽位”容量上限数组（按件数计）
* 两类参数均为**设备类型属性**，由领域模型定义；不是运行时硬编码常量
* 槽位容量规则：
  * **上限不共享**：每个槽位独立校验自身容量，不存在跨槽位共享总上限
  * **可不一致**：不同槽位可配置不同上限（例如 `[20, 50]`）
* 当前默认配置（Stage1 当前实现口径）：所有 `processor` 设备
  * `inputBufferSlots = 1`
  * `outputBufferSlots = 1`
  * `inputBufferSlotCapacities = [50]`
  * `outputBufferSlotCapacities = [50]`

输入端口共用 inputBuffer
输出端口共用 outputBuffer

接收规则（输入/输出缓存一致）：

* 先判定槽位绑定：
  * 若待写入物品已绑定到某槽位，则继续写入该槽位
  * 若待写入物品尚未绑定，则仅当有空槽位时可绑定写入
* 再判定槽位容量：写入后该物品在其绑定槽位中的数量不得超过该槽位上限
* 当 `*BufferSlots = 1` 时：
  * 缓存为空可接收任意符合端口要求的物品
  * 缓存非空仅可接收当前缓存中的该物品

生产完成写出规则：

* 周期完成时，若 `outputBuffer` 因容量或槽位限制无法完整写入本次产物，设备进入 `OUTPUT_BLOCKED`
* 周期保持在完成点（`progress01 = 1`）等待输出缓存可写入后再提交产物并进入下一周期

编辑态预置输入缓存：

* 编辑模式可为任意 `processor` 设备配置“按槽位的预置输入列表”
* 开始仿真时将预置值写入该设备 `inputBuffer`
* 每个槽位的预置数量必须被夹取到该槽位自身上限

---

## 5.2 conveyor / junction

* conveyor：slot（容量=1）
* junction：按设备语义定义槽位
  * splitter / merger：slot（容量=1）
  * bridge：两条独立通道各 1 个 slot（N-S 一槽，W-E 一槽）
* progress01 表示运输进度

---

# 6. 传送带双区间进度模型（冻结）

---

## 6.1 进度划分

progress01 ∈ [0,1]

* 入口段：0 ~ 0.5
* 出口段：0.5 ~ 1.0

---

## 6.2 入口段规则

* 只要 slot != null
* progress 可推进至 ≤ 0.5
* 不依赖下游可接收

---

## 6.3 出口段规则

* 仅当下游在 Commit 后将有容量
* 才允许 progress > 0.5

---

## 6.4 中心停靠点

* 下游不可接收时
* progress 停在 0.5

---

# 7. 两阶段更新机制（防奇偶交替）

---

每 tick：

### Phase A：Plan

* 计算哪些设备将在本 tick 末交接
* 计算下游是否将腾出容量
* 若存在冲突，则设备停机，stallReason=OUTPUT_BLOCKED

### Phase B：Commit

* 更新 progress
* 执行交接
* 更新 slot

下游可接收定义：

* 当前空
* 或本 tick 末将腾空
* 且入口未被其他设备预留

---

# 8. UI 与交互系统（完整描述）

---

## 8.1 页面布局

* 左侧：工具栏
* 中央：工业区网格
* 右侧：信息面板
* 顶部：仿真控制条

地块规格（当前实现）：

* 60x60
* 40x40

---

## 8.2 四模式编辑

### 选择模式

* 单击选择设备
* 再次点击空白取消选择
* 拖拽移动
* 框选移动
* R 键旋转

### 放置模式

* 选择设备类型
* 出现跟随鼠标的设备虚影，设备虚影中也包括输入输出口指示的虚影。
* 可以按R旋转
* 点击网格放置
* 传送带设备在放置模式时不出现在可放置设备列表。物流节点可以在放置模式手动放置。
* 在放置模式手动放置 `item_log_splitter` / `item_log_converger` / `item_log_connector` 时，若目标格被 `belt_*` 占用，则删除被覆盖的该格传送带并在该格放置对应物流节点。

### 物流模式

* 子模式：传送带
* 按住左键拖拽铺设，铺设路径产生传送带虚影
* 支持路径回退
* 仅支持格线方向
* 不允许单格落盘（定义：路径长度至少 2 格）；允许显示 1 格路径预览，但松手不落盘
* 起点必须为：
  * 设备输出端口（包括分流器汇流器桥接器）
  * 空地
  * 传送带（自动创建 splitter）
* 终点必须为：
  * 设备输入端口（包括分流器汇流器桥接器）
  * 空地
  * 传送带/传送带虚影（自动创建 merger）
* 当路径终点落在传送带/传送带虚影时，按终点接入语义创建临时 merger；若继续拖拽使该格变为路径中间点，则即时改判为 bridge
* 跨直线带/直线虚影自动创建 bridge（仅当该格为路径中间点时）
* 禁止跨拐角带/拐角虚影，只能在拐角停留
* 允许孤立物流（空地到空地）
* 不允许沿着或者逆着已有传送带或传送带虚影前进，只能停留或跨越（停留=终点落在该格；跨越=该格是路径中间点）。
* 出现禁止路径时，停止向非法方向继续延伸虚影，保留最后一次有效路径前缀，并允许回退；松手时按最后一次有效路径落盘

### 删除模式

* 单格删除
* 删除整条联通带
* 联通采用 4 邻接
* 删除整条联通带时，仅删除 `belt_*` 纯传送带格；不删除 `splitter/merger/bridge`，遇到上述三类时打断删除遍历。

---

## 8.3 仿真控制

* 开始仿真
* 退出仿真
* Tick 基准频率：仿真时间流逝速率永远固定为 20Hz（即每秒 20 tick）
* 术语定义：`标准秒` 是规则层时间单位，表示与仿真倍速无关的固定时间。
* 时间口径总则：在所有文档中，凡提到 X 秒 / X 分钟，均按仿真时间定义：1 秒 = 20 tick，1 分钟 = 1200 tick；该口径不受仿真倍速影响。
* 1x / 2x / 4x / 16x 仅用于控制系统运行速度，相当于整体加快现实时间流逝，仿真时间不变。
* 顶栏提示信息（用于反馈当前可操作状态）

退出仿真：

* 清空运行态
* 清空仓库统计快照
* 清空仓库物品数量
* 下一次启动仿真时，仓库从统一初始值重建：`item_originium_ore=∞`，其他物品=`0`
* 清空设备进度

---

# 9. 库存系统

---

## 9.1 仓库

* 统一库存池（取货口从仓库取货，存储箱可提交到仓库）
* 存储箱提交行为为用户可选配置，默认值为“提交”；开启后按仿真时间每 10 秒批量提交一次该存储箱内所有物品到仓库
* pickup_port 可选择任意已定义物品（包括 `item_originium_powder`）
* pickup_port 新增配置项 `pickupIgnoreInventory`（是否无视库存），默认 `false`
* 当 `pickupIgnoreInventory=true` 时，pickup_port 可持续出货且不扣减仓库该物品库存
* 若 pickup_port 选择了带 `矿石` tag 的物品，则 `pickupIgnoreInventory` 强制为 `true`，并在 UI 中禁止编辑
* 仓库统计与地图上设备增减解耦
* 每次进入仿真前，仓库库存重置为统一初始值：`item_originium_ore=∞`，其他物品=`0`

---

# 10. 统计面板

---

必须显示：

* 仓库当前库存总量
* 仓库物品变化速率（/min）

统计口径：

* /min 按仿真时间计算，按照滑动窗口计算。
* 不受 1x / 2x / 4x / 16x 影响。
* 当物品被任一 pickup_port 以“无视库存”方式取出时，该物品在“当前库存”列显示为 `∞`。

排序：

* 矿物优先
* 其余按 itemId 字母序

---

# 11. UX 冻结规则

* 设备粗边框矩形
* 箭头表示端口方向
* 名称居中显示
* 停机显示红框与图标
* 未选择物品显示 “?”
* starved 为显示层状态，语义等同 Idle（未工作）

---

# 12. 非功能需求

* 纯前端实现
* localStorage 存档
* 无后端依赖
* 可部署 GitHub Pages
* 不依赖游戏引擎

---

# 13. 完成标志（DoD）

满足：

1. 可搭建 item_originium_ore → item_originium_powder 产线
2. 仓库统计可稳定反映物品总量与变化速率
3. 缺料提示明确
4. 可见仓库统计与设备状态
5. 退出仿真后，运行态数据完全清理（进度、仓库统计快照、临时状态）

补充说明：

* filler_6x4 已移出 Stage1 冻结范围，不纳入实现与测试。

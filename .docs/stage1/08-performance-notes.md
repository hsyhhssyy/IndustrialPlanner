# 08 性能优化专题（Stage1）

> 本文档沉淀 Stage1 在高倍速仿真（`4x/16x`）下的性能治理方案、验证方法与后续优化方向。

## 1. 问题现象与目标

### 1.1 现象

- 在 `2x/4x` 下出现周期性卡顿（体感“每隔一段时间顿一下”）。
- DevTools 显示主线程中 `Render / beginWork` 占比高，存在较明显长任务峰值。

### 1.2 目标

- 降低高倍速下主线程长任务峰值。
- 减少周期性内存分配，抑制 GC 抖动。
- 保持 Stage1 规则与统计口径不变。

## 2. 已落地优化（2026-02）

### 2.1 引擎侧：布局级缓存

- 缓存 `layout -> neighbors graph`，避免每 tick 重建拓扑。
- 缓存 `layout -> deviceById`，避免 tick 循环中的 `find` 线性查找。
- 典型收益：降低 tick 内重复计算和 O(n) 查找开销。

### 2.2 UI 侧：静态层/运行态层拆分

- 设备静态绘制（几何、贴图、标签）从运行态更新路径中剥离。
- 静态层组件 memo 化，减少每 tick 的大规模 JSX 重建。
- 运行态停机样式改覆盖层渲染，保留异常可视反馈。

### 2.3 调度侧：`requestAnimationFrame + accumulator`

- 用帧驱动替换固定间隔调度。
- 每帧按累计时间批量执行 tick，并设置单帧补偿上限，避免“补偿尖峰”。
- 典型收益：高倍速下节拍更平滑，卡顿感下降。

### 2.4 统计侧：环形缓冲窗口

- `/min` 统计窗口从“每 tick 数组复制 + 全量重算”改为固定容量环形缓冲。
- 写入新 tick 前先移除被覆盖槽位对累计值的贡献，再增量加入当前 tick。
- 典型收益：分配更稳定，降低周期性 GC 峰值。

## 3. 验收与定位方法（推荐）

### 3.1 录制口径

- 固定同一布局，分别录 `1x/2x/4x/16x`。
- 录制时仅执行“开始仿真 + 等待”，避免交互噪声。

### 3.2 关键观察项

- Performance：
  - Main 线程长任务（是否存在周期尖峰）
  - `Render / beginWork` 占比
- React Profiler：
  - 每次 commit 耗时
  - commit 组件数量是否随 tick 全量扩散
- Memory：
  - Allocation timeline 是否存在固定周期分配尖峰

### 3.3 通过标准（建议）

- 高倍速下主线程长任务分布趋于平滑。
- `4x/16x` 体感无明显“周期顿挫”。
- 统计值与优化前在同口径下保持一致。

## 4. 仍可继续的优化点

1. **Runtime 脏写优化**：从“每 tick 全量 clone runtime”转为“按脏实例局部拷贝”。
2. **渲染路径预计算**：将高频端口/路径几何推导前移到布局变更阶段。
3. **调试信息降频刷新**：非核心 UI（如 Debug 文本）按 `250~500ms` 更新。
4. **带体 SVG 降复杂度**：减少每格 `defs/mask` 生成，尝试共享定义或轻量轨道样式。

## 5. 变更影响说明

- 本文档涉及优化均不改变 Stage1 规则语义：
  - Tick 规则、端口连接、Plan/Commit 判定逻辑不变
  - 仓库与 `/min` 统计口径不变
- 仅调整计算与渲染实现路径，以降低成本并提升高倍速稳定性。

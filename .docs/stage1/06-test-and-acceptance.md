# 06 测试与人工验收记录（Stage1）

## 1. 当前口径

- Stage1 暂无自动化测试框架。
- 本文档用于沉淀**人工验收**过程与结果，作为阶段完成依据之一。

## 2. 记录规则

- 每条验收记录必须包含：`日期`、`功能点`、`操作步骤`、`预期结果`、`实际结果`、`结论`、`备注`。
- `结论` 仅允许：`PASS` / `FAIL` / `BLOCKED`。
- 若为 `FAIL`，必须在备注中写明复现条件与影响范围。
- 若为 `BLOCKED`，必须写明阻塞原因（环境/数据/功能缺失等）。

### 2.1 视口验收统一标准（适用于 3.2 相关条目）

- 画布必须为固定视口容器：不出现滚动条，超出内容通过视口裁切显示。
- 缩放必须为“视口缩放”：图元、文字、网格线随同一缩放矩阵一起变化，不允许仅修改逻辑格尺寸导致显示不一致。
- 最大缩放标准：视口内可见范围约为 `12 x 12` 格（允许因窗口宽高比出现少量边界差异）。
- 缩放中心：以鼠标位置为锚点，缩放前后锚点对应的世界坐标应保持连续。
- 平移交互：支持按住鼠标中键拖动平移，且不影响左键的选择/放置/物流编辑语义。
- 缩放步进：采用分段步进策略，高倍区间步长应显著大于低倍区间，避免高倍下需要大量滚轮次数。
- 设备绘制间距：非传送带设备采用固定像素内收，当前标准为四边各 `2px`，用于保证并排设备可分辨且与物流连接保持一致观感。

## 3. 人工验收记录（持续追加，按主题分组）

### 3.1 UI 文案与本地化

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-19 | 模式选择文案本地化 | 进入应用后查看左侧模式切换按钮文案（select/place/logistics/delete） | 模式文案为中文 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 放置模式建筑名称本地化 | 切换到放置模式，查看设备列表与建筑显示名称 | 建筑显示名称为中文 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 设备显示名称不含尺寸后缀 | 在放置模式与画布内查看设备名称（如“粉碎机 3x3”“取货口 3x1”） | 设备显示名称仅包含设备名称本体，不显示尺寸信息 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | Material 字号规范与单格比例 | 在 100% 浏览器缩放下检查页面字号层级与画布网格尺寸比例 | 字号遵循 Material 可读性层级（如 16/14/12）；画布单格基准为标准字的 1.5 倍（16px → 24px） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 选择模式详情标签本地化 | 在选择模式选中任意设备，查看右侧“选中详情”标签文本 | 详情行标签使用中文（如实例ID、类型、旋转、位置、状态） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 删除模式子菜单本地化 | 切换到删除模式，查看子菜单标题与选项文案 | 删除模式子菜单文案使用中文 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |

### 3.2 画布交互与视口体验

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-19 | 画布滚轮缩放上限（12x12 视图） | 在画布区域使用鼠标滚轮持续放大，观察视口内可见格子数量 | 符合“2.1 视口验收统一标准”：最大缩放时视口内约为 12x12 格可见 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 选择模式光标样式一致性 | 在选择模式下将鼠标悬浮到建筑上，观察鼠标光标形态 | 悬浮建筑时应显示可交互光标（如 pointer/move），不应出现文本输入光标 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 放置模式跟随虚影预览 | 切换到放置模式并移动鼠标，观察建筑预览反馈 | 鼠标移动时应显示建筑虚影跟随（含放置预览） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 放置虚影网格吸附 | 在放置模式移动鼠标，观察虚影是否按格子吸附定位 | 虚影应按网格格子吸附（格点对齐） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 选择模式拖拽移动与网格吸附 | 在选择模式选中建筑后拖拽移动，观察建筑是否跟随鼠标并按网格吸附 | 拖拽时建筑应跟随鼠标移动，且按格子吸附落位 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-21 | 选择模式拖拽移动与网格吸附（复测） | 在选择模式选中非基础建筑并拖拽移动，分别验证单选与多选拖拽；同时保留地块外基础设施不参与拖拽 | 建筑可跟随鼠标拖拽并按格子吸附落位；基础设施不应阻塞普通建筑拖拽 | 复测通过：单选/多选拖拽均恢复正常，网格吸附正常；基础设施未再导致拖拽回滚 | PASS | 根因修复：拖拽越界校验从“全设备”改为“仅校验当前被拖拽选中设备”（`src/App.tsx`） |
| 2026-02-19 | 放置跟随锚点（几何中心） | 在放置模式移动鼠标，观察建筑虚影与鼠标相对位置 | 建筑应以几何中心跟随鼠标，并保持格子吸附 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 中央画布视口模式与无滚动条 | 在中间画布区域进行缩放与平移，观察容器滚动条与画布显示行为 | 符合“2.1 视口验收统一标准”：固定视口、无滚动条、超出内容裁切显示 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 中键按住拖动画布平移 | 在中央画布按住鼠标中键并拖动，观察地图是否随拖动方向平移 | 符合“2.1 视口验收统一标准”：支持中键平移且不影响左键编辑语义 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 滚轮缩放分段步进 | 在画布区域滚轮连续缩放，观察低倍与高倍区间每次缩放步长 | 符合“2.1 视口验收统一标准”：缩放步进分段，高倍区间步进显著增大 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 设备绘制内收与并排可分辨性 | 在放置模式将两个设备相邻摆放，观察设备边框与网格边界关系、相邻设备可分辨性 | 设备绘制不出格，采用固定 `2px` 内收；相邻设备并排时边界清晰可辨，且与传送带连接观感自然 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 传送带独立绘制风格（2/3 带宽 + 中心淡箭头） | 在物流模式铺设直线与拐角传送带，观察带体宽度、边缘描边与方向箭头样式 | 传送带采用独立带体绘制（约 2/3 格宽，带边缘），并在带体中心显示淡色小箭头指示方向 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-21 | 传送带两侧留白一致性（网格线锚点复测） | 在 `1x` 与高倍缩放下观察直线/转角传送带，分别对比左右（或上下）两侧留白；重点查看贴近网格线处是否出现 2px~4px 单侧偏差 | 传送带两侧留白视觉应保持一致，不应出现持续单侧被“吃掉”的现象 | 复测通过：留白恢复对称；根因确认为网格线按单格左/上边锚定导致放大后单侧加粗，修复为网格背景半像素偏移后表现稳定 | PASS | 修复口径：`grid-canvas` 使用 `background-position: -0.5px -0.5px`，让格线跨边界居中显示 |
| 2026-02-19 | 物流模式未连接端口 Chevron 指示（传送带与物流节点排除） | 切换到物流模式，观察设备未连接端口 Chevron 的位置、尺寸、透明度与朝向；并核对传送带及物流节点是否不显示 | 普通设备未连接端口在对应边外侧显示 Chevron；Chevron 沿箭头方向长度约为单格的 1/5、垂直箭头方向厚度约为单格的 2/3，且具备明确不透明度；传送带、分流器、汇流器、桥接器不显示该指示 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | Chevron 与格线重合规则（入尖端/出尾部） | 在物流模式观察普通设备未连接端口 Chevron，检查其与格子边线贴合关系 | 输入端口 Chevron 的尖端与格子边线精确重合；输出端口 Chevron 的尾部与格子边线精确重合（本条不适用于传送带/分流器/汇流器/桥接器） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 选择模式选中设备端口箭头可见性 | 切换到选择模式并选中设备，观察其端口箭头显示情况 | 选择模式下，普通设备可显示端口箭头；传送带、分流器、汇流器、桥接器不显示端口箭头 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |

### 3.3 传送带创建

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-19 | 最小成带长度（2格） | 在物流模式分别尝试 1 格与 2 格路径铺设传送带 | 1 格路径不成带；2 格路径可成功成带 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 1格路径虚影预览与松手不落带 | 在物流模式拖拽仅 1 格长度路径，观察拖拽中虚影与松手结果 | 拖拽过程中应显示 1 格路径虚影；松手后不创建传送带实例 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 顺/逆时针转角带旋转一致性 | 在物流模式分别生成顺时针与逆时针转角路径，检查生成的转角带朝向 | 顺时针与逆时针转角带均按路径方向正确旋转，不出现逆时针朝向错误 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 物流铺设中中键平移状态稳定性 | 在物流模式拖拽铺设过程中按中键拖动地图后继续/结束操作，观察路径与提交结果 | 中键平移不应导致物流状态混乱；触发平移后应保持一致行为（当前实现口径：取消本次物流草稿，不提交异常路径） | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 分流器/汇流器/桥接器接口显示规则 | 在物流模式创建分流器、汇流器、桥接器并观察接口箭头位置 | 分流器、汇流器、桥接器均不显示接口箭头 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 分流器/汇流器/桥接器名称隐藏规则 | 在画布中创建分流器、汇流器、桥接器并观察设备名称显示 | 分流器、汇流器、桥接器在画布内不显示设备名称文本 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 分流器独特图形（十字 + 三出口箭头） | 在画布中放置分流器并观察其图形外观 | 分流器显示十字主干，并在三个输出方向各显示一个箭头 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 分流器独特图形（十字 + 三出口箭头）复测 | 在最新版本中创建分流器并检查十字主干与三个出口箭头是否准确对线 | 分流器十字主干清晰可见，三个出口方向均有箭头且与主干/出口方向对齐 | 复测结果符合预期：十字与三出口箭头显示正确且对线准确 | PASS | 复测通过，保留历史 FAIL 记录用于追踪修复闭环 |
| 2026-02-19 | 汇流器独特图形（十字 + 出口单箭头）复测 | 在最新版本中创建汇流器并检查十字主干与出口方向箭头显示 | 汇流器显示十字主干，并仅在出口方向显示 1 个箭头，且箭头与出口方向对齐 | 复测结果符合预期：汇流器十字与出口单箭头显示正确且对线准确 | PASS | 复测通过，后续可继续微调线宽与对比度 |
| 2026-02-20 | 禁止沿既有传送带/传送带虚影延伸 | 在物流模式贴着已有传送带或当前虚影同向拖拽；再尝试“停在传送带”与“垂直穿过传送带”两种操作 | 不允许沿传送带（含虚影）继续延伸；允许停在传送带，允许径直越过传送带（非沿带方向） | 已实现：沿带方向会被截断；停留与越过可继续按合法前缀提交 | PASS | 本规则同时适用于已有传送带与当前绘制虚影 |
| 2026-02-20 | 停留/穿过传送带虚影的节点创建 | 在一次拖拽中让路径终点停在虚影，并继续向前拖拽使该格转为路径中间点；或路径与虚影发生穿越后结束绘制 | 终点停留在虚影（端点接入）时按终点语义创建临时汇流器；若继续拖拽使该格变为路径中间点，则应改判为桥接器；穿过虚影（中段交叉）时创建桥接器 | 已实现：终点落在虚影时先按汇流器处理；继续拖拽变为中间点后改判桥接器；中段穿越虚影创建桥接器 | PASS | 虚影与现有传送带在节点化规则上完全等同 |
| 2026-02-20 | 穿越传送带虚影时桥接器重复创建 | 在物流模式构造“路径穿越传送带虚影”的场景并提交，检查交叉格最终实例数量；对比“穿越实体直线带”场景 | 无论穿越虚影还是穿越实体直线带，交叉格都应只创建 1 个 `item_log_connector` | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-20 | 穿越传送带虚影时桥接器重复创建（复测） | 使用同一复现场景再次提交，核对交叉格设备实例数量并与“穿越实体直线带”结果对齐 | 交叉格仅创建 1 个 `item_log_connector`，与穿越实体直线带表现一致 | 已修复：对桥接器创建按坐标去重后，虚影穿越不再重复创建 | PASS | 修复点：`applyLogisticsPath` 增加 `createdBridgeCells` 去重集合 |
| 2026-02-20 | 跨拐角虚影禁止规则（PRD 对齐） | 在一次拖拽中先形成拐角虚影，再尝试从另一方向穿过该拐角格 | 仅允许跨直线带/直线虚影创建桥接器；跨拐角带/拐角虚影应判非法并截断，不提交非法尾段 | 已实现：跨直线虚影可桥接；跨拐角虚影被截断且不落非法段 | PASS | 与 PRD “跨直线可桥接、跨拐角禁止”保持一致 |
| 2026-02-20 | 选择模式下传送带 R 键旋转限制 | 在选择模式选中任意 `belt_*` 传送带后按 `R` 键 | 传送带不发生旋转；其他非传送带设备仍可按 `R` 旋转 | 已实现：`belt_*` 在选择模式下按 `R` 不旋转，非传送带设备旋转逻辑不变 | PASS | 与“传送带由物流模式生成，选择模式不支持其旋转”口径一致 |
| 2026-02-22 | 传送带断点续接（起点续画/终点接入） | 在物流模式中：1）从现有传送带“断点端”（未连接输出端）作为起点继续拖拽；2）将新路径终点落在另一条传送带“起点端”（未连接输入端） | 起点命中断点时应按“续画”处理并与原带连续连接；终点命中起点端时应正确接入原带；不应强制生成分流器/汇流器替换该断点格 | 已实现：当起点命中未连接输出端、或终点命中未连接输入端时，优先直接续接；仅在非断点续接场景回退为 splitter/merger 逻辑 | PASS | 修复点：`src/domain/logistics.ts` 在 `applyLogisticsPath` 中新增端点连通检测（基于 `linksFromLayout`） |
| 2026-02-22 | 断带端点方向不匹配时转拐角续接 | 在物流模式中：1）起点落在断带终点，但拖拽方向与原带输出方向不一致；2）终点落在断带起点，但接入方向与原带输入方向不一致；同时对照“起点落在带起点/终点落在带终点”两类场景 | 对“起点命中断带终点”与“终点命中断带起点”应始终优先连接传送带：必要时将对应端点格改为拐角带，不创建 splitter/merger；而“起点在带起点”与“终点在带终点”仍保持现有物流节点创建机制 | 已实现：断带终点/起点命中时优先重写端点带体并自动转角连接；对照场景下仍按既有 splitter/merger 机制处理 | PASS | 修复点：`src/domain/logistics.ts` 端点策略改为“断点优先带体续接”，并增加单格流向重写可行性校验 |
| 2026-02-22 | 删除整条传送带不误删相邻未连接带 | 构造两条彼此相邻但端口不连通的传送带（含并排直线、相邻转角两类）；在删除模式选择“整条传送带”，从其中一条任意格删除 | 仅删除与起点在端口拓扑上连通的 `belt_*`；相邻但未连通的传送带必须保留 | 已实现：整条删除改为基于端口连通图遍历，不再按纯4邻接泛化删除，未连通相邻带不再被误删 | PASS | 修复点：`src/domain/logistics.ts` 的 `deleteConnectedBelts` 改为使用 `linksFromLayout` 构建 belt 连通分量 |
| 2026-02-22 | 物流铺设虚影可视化（真实带体 + 自动节点白边） | 在物流模式拖拽铺设，分别覆盖直线、转角、终点接入既有带、路径中段跨越直线带四类场景，观察拖拽中预览图形 | 预览应展示传送带正常图像（轨道与方向箭头），并以白色边框强调；自动创建的 `splitter/merger/bridge` 也应在预览阶段出现且带白边，不再使用单色方块虚影 | 已实现：物流预览改为“投影后设备层”叠加渲染，带体与自动节点均按真实形态显示，并统一白色描边 | PASS | 实现位置：`src/App.tsx`（新增 `logisticsPreviewDevices` + 预览层渲染），`src/App.css`（`logistics-preview-device` 样式） |
| 2026-02-22 | 放置模式物流节点覆盖传送带替换 | 在放置模式选择 `splitter` / `converger` / `connector`，对准已有 `belt_*` 单格点击放置 | 被覆盖的该格传送带应被删除，并在同一格放置所选物流节点；不应保留重叠带格 | 已实现：放置时识别三类物流节点并执行“先删被覆盖带格，再放节点” | PASS | 实现位置：`src/App.tsx`（`placeDevice`） |
### 3.4 模式功能完整性

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-19 | 物流模式子菜单完整性 | 切换到物流模式，检查是否存在“放置传送带”操作入口 | 物流模式下存在“放置传送带”按钮 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-19 | 删除模式一键清空画布 | 切换到删除模式，检查是否存在独立“删除所有内容”按钮并执行 | 存在“删除所有内容”独立按钮，可一键清空画布 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-22 | 删除模式框选删除（确认后执行） | 切换到删除模式并选择“框选删除”；在画布拖拽框选后松开鼠标，观察是否弹确认；分别验证“确认”与“取消”路径 | 框选后必须先弹确认框；确认后删除框内设备，取消则不删除 | 已实现：新增“框选删除”子模式，松手后弹确认对话框；确认执行删除、取消保持原状 | PASS | 实现位置：`src/App.tsx`（删除子模式三态 + 框选确认流程），`src/i18n.ts`（新增文案键） |
| 2026-02-22 | 仿真态侧栏信息重排（统计/调试左移） | 在编辑态与仿真态之间切换，观察左右侧栏内容；仿真态尝试查看左侧是否仍可切换模式 | 编辑态不显示“仓库统计/仿真调试”；仿真态左侧固定为选择模式且隐藏模式按钮与子按钮，同时左侧显示“仓库统计/仿真调试” | 已实现：编辑态隐藏统计/调试；仿真态自动强制 `select` 并隐藏左侧模式区，统计/调试改为左侧显示 | PASS | 实现位置：`src/App.tsx`（`sim.isRunning` 条件渲染 + 仿真态强制 `select`） |
| 2026-02-22 | 侧栏默认同宽与拖拽调宽 | 打开页面观察左右侧栏初始宽度；分别拖拽左/右分隔条调整宽度并刷新页面 | 左右侧栏默认宽度一致；左右都可独立拖拽调宽；刷新后保持上次宽度 | 已实现：左右默认均为 `340px`，新增左右分隔拖拽条并持久化宽度（限制区间 `260~560px`） | PASS | 实现位置：`src/App.tsx`（宽度状态与拖拽逻辑），`src/App.css`（主网格与分隔条样式） |

### 3.5 统计与数据展示

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-19 | 仓库统计表列结构 | 查看右侧“仓库统计”区域的数据表头与列内容 | 统计区为多列表格，列为：物品名称、产出每分、消耗每分、当前库存 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |

### 3.6 仿真显示层

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-20 | 传送带在途物品显示读取（物品 + 进度） | 进入仿真后，构建一条有物品流动的传送带；在多个 tick 时刻观察显示层是否读取传送带 `slot.item` 与 `progress01`；核对小盒子位置是否随进度连续更新 | 每个时刻当传送带上有物品时，显示层都应基于“当前物品类型 + 当前进度”渲染一个小盒子，且位置与进度一致；无物品时不显示小盒子 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |
| 2026-02-20 | 仿真模式点击设备查看当前物品与进度 | 进入仿真模式后，分别点击普通设备、物流节点与传送带格；观察右侧详情是否展示该实例当前运行字段；重点核对传送带是否显示“当前物品（若有）+ progress01” | 仿真模式下可点击任意设备（含传送带）；详情区应显示该设备当前运行态。对传送带应明确显示当前段上的物品与进度，无物品时显示为空槽状态 | 已修复并通过复测 | PASS | 依据代码改动与复测结论更新 |

### 3.7 仿真测试

| 日期 | 功能点 | 操作步骤 | 预期结果 | 实际结果 | 结论 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2026-02-20 | 传送带在途小盒子渲染（物品+进度） | 搭建取货口+多段传送带，进入仿真后观察每段带体上的小盒子显示与移动 | 有物品的带段显示小盒子，位置随 `slot.progress01` 连续变化；空槽不显示 | 已实现并可稳定显示，物品类型配色正确 | PASS | 对应新增仿真显示层能力 |
| 2026-02-20 | 在途物品全局覆盖层叠放（避免半盒子遮挡） | 构造连续传送带并在仿真中观察物品跨格瞬间；重点检查格子边缘处是否被相邻带段/设备裁掉半边 | 在途物品应以全局覆盖层绘制，跨格瞬间仍完整可见，不出现“半个盒子被邻格遮挡”现象 | 已实现：在途物品从带格内部渲染迁移到全局覆盖层，边缘过渡连续且无遮挡半盒子 | PASS | 同时保持原有 `progress01` 插值轨迹与物品配色 |
| 2026-02-20 | 粉碎机出口堵塞时输出缓存写入 | 搭建“粉碎机下游阻塞”场景（如输出端下游不接收或持续拥堵），持续观察粉碎机运行与 `outputBuffer` | 粉碎机不应因出口堵塞而中断当前/后续生产周期；产出应持续写入 `outputBuffer`，`OUTPUT_BLOCKED` 仅表示下游阻塞状态 | 已实现：移除“`outputBuffer` 非空即停机”判定后，粉碎机在阻塞场景下可继续产出并累积到输出缓存 | PASS | 根因是旧逻辑将“缓存非空”错误等同于“无法生产” |
| 2026-02-20 | 仿真态选中详情（传送带） | 仿真运行中点击传送带，查看右侧详情 | 可见“当前状态”与“内部状态”两行，并显示当前物品与进度 | 已实现：支持仿真态选中并展示明细 | PASS | “内部状态”用于解释握手阶段 |
| 2026-02-20 | 取货口 `OUTPUT_BLOCKED` 抖动抑制 | 搭建取货口->传送带链路，观察取货口状态随 tick 变化 | 不应每 tick 闪红；仅在持续无法出货达到阈值后标记 `OUTPUT_BLOCKED` | 已实现：按运输间隔超时判定，状态稳定 | PASS | 阈值按标准秒口径定义（当前窗口 2 秒，运行时换算为 tick） |
| 2026-02-20 | 1x 传送带速度口径 | 在 `1x` 下观察单格运输耗时 | 约 2 秒/格（`tickRate=20`, `CONVEYOR_SPEED=0.025`） | 实测符合口径，体感速度与设计一致 | PASS | 与旧实现（约 1 秒/格）已区分 |
| 2026-02-20 | 双状态握手（canTry/canAccept） | 构造上下游连续带，观察下游处于 `0.5~1` 时上游推进行为与提交行为 | 下游 `canTry` 时上游可推进后半程；仅 `canAccept` 时允许提交 | 已实现并通过验证 | PASS | 语义：`canAccept` 是 `canTry` 子集 |
| 2026-02-20 | 阻塞即时停靠（后半程） | 构造“下游在后半程中途堵塞”场景，观察上游物品位置 | 上游在 `0.5~1` 内应停在当前进度，不得继续冲到 `1` | 已实现：阻塞发生即停靠，行为符合预期 | PASS | 保持 `0~0.5` 与 `0.5~1` 分段语义 |
| 2026-02-20 | 可尝试状态入口修复 | 构造下游处于 `0.5~1` 场景，观察上游是否仍卡在 `0.5` | 上游不应被错误卡死，应可进入后半程推进 | 已修复：上游可按 `canTry` 推进 | PASS | 根因是接收车道解析过早要求空槽 |
| 2026-02-20 | Plan 迭代收敛修复（1 tick 间距漂移） | 构造连续出货链路，持续观察相邻物品间距是否随时间线性变大；对比修复前后行为 | 不应出现“每个物品比上一个慢 1 tick”的累积漂移；同条件下间距应稳定在设计节拍附近 | 已修复：复测确认间距漂移问题消失 | PASS | 根因是 Plan 循环仅以 transfer plan 作为收敛条件，未将“仅进度推进”纳入继续迭代触发 |
| 2026-02-21 | 高倍速调度抖动优化（`setInterval` -> `rAF + accumulator`） | 在同一布局下对比 `4x/16x` 仿真体感与 Performance 时间线，观察是否仍出现固定周期卡顿 | 高倍速下长任务峰值应下降，节拍更平滑，体感“顿一下再走”显著缓解 | 已实现并通过体感复测：`4x` 卡顿明显减轻，`16x` 可连续运行 | PASS | 调度模型改为帧驱动批处理，并设置单帧 tick 补偿上限 |
| 2026-02-21 | `/min` 统计窗口分配优化（环形缓冲） | 在持续仿真下观察 Memory/Performance，核对是否存在由统计窗口复制导致的周期性分配尖峰 | 统计更新应避免每 tick 复制窗口数组，降低 GC 抖动风险，结果口径保持一致 | 已实现并通过回归：窗口改为固定容量环形缓冲 + 增量聚合，统计值与原口径一致 | PASS | 新增状态字段：`minuteWindowCursor/minuteWindowCount/minuteWindowCapacity` |

## 4. 与 Stage1 DoD 对齐检查

| DoD 条目 | 对应测试记录 | 当前状态 |
| --- | --- | --- |
| 可搭建并运行 `item_originium_ore -> item_originium_powder` 产线 | 已完成代码复核与验收项闭环 | PASS |
| 统计面板稳定反映仓库总量与变化速率 | 已完成代码复核与验收项闭环 | PASS |
| 缺料/堵塞/重叠停机原因可识别 | 已完成代码复核与验收项闭环 | PASS |
| 可见仓库统计与设备运行状态 | 2026-02-23 汇总结论（已完成代码相关条目复测） | PASS |
| 退出仿真后运行态数据清理完整 | 已完成代码复核与验收项闭环 | PASS |

## 5. 同步说明

- 你后续发送的测试内容将直接追加到“人工验收记录（持续追加）”表格。
- 我会在同步时自动更新“与 Stage1 DoD 对齐检查”中的状态。

## 6. 传送带绘制流程伪代码（专门章节）

> 说明：本节用于统一“传送带绘制”验收口径，采用“非法路径截断，不整单作废”的目标行为。

### 6.1 事件流与状态

```text
状态变量：
	rawTrace                # 鼠标拖拽原始轨迹（按经过格子记录）
	validPreviewPath        # 当前可展示/可提交的最后合法路径
	isDrawingBelt           # 是否处于传送带绘制中

onMouseDown(cell):
	if mode != logistics or simRunning: return
	isDrawingBelt = true
	rawTrace = [cell]
	validPreviewPath = []

onMouseMove(cell):
	if !isDrawingBelt: return
	if cell 与 rawTrace 最后一点相同: return
	rawTrace.append(cell)

	candidatePath = pathFromTrace(rawTrace)              # 轴向展开 + 回退去重
	validPreviewPath = longestValidPrefix(candidatePath) # 关键：取“最后合法前缀”

	# UI 仅渲染 validPreviewPath，不渲染非法尾段

onMouseUp():
	if !isDrawingBelt: return
	isDrawingBelt = false

	if validPreviewPath.length >= 2:
		layout = applyLogisticsPath(layout, validPreviewPath)
	# 否则不提交

	rawTrace = []
	validPreviewPath = []
```

### 6.2 合法性判定（longestValidPrefix）

```text
longestValidPrefix(path):
	if path 为空: return []

	prefix = [path[0]]
	for i from 1 to path.length-1:
		trial = prefix + [path[i]]

		if !isAxisAdjacentStep(prefix.last, path[i]):
			break

		if entersDeviceInterior(path[i], trial):
			break

		if invalidPortDirectionAtEndpoint(trial):
			break

		if invalidMiddleOccupancy(trial):
			break

		if extendsAlongExistingOrPreviewBelt(trial):
			break

		prefix = trial

	return prefix
```

### 6.3 与验收条目的对应关系

- 对应“1格路径虚影预览与松手不落带”：`validPreviewPath.length == 1` 时允许预览，不提交。
- 对应“最小成带长度（2格）”：仅 `validPreviewPath.length >= 2` 才提交。
- 对应“探入建筑内部/错误端口方向”：在 `longestValidPrefix` 中触发截断，虚影立即停止延伸。
- 对应“禁止沿既有传送带/虚影延伸”：若新段与既有带或虚影同向延展，则在前缀判定中截断。
- 对应用户期望：松手后按“最后一次正确路径”绘制，不因后续非法拖拽而整次失败。
- 对应“停留/穿过虚影节点化”：终点落在虚影时按终点语义创建临时汇流器；若继续拖拽使该格变为中间点，则改判为桥接器；中段穿过虚影时创建桥接器。
- 对应“规则等同性”：传送带虚影与现有传送带在“可停留、可穿越、禁止沿带延伸、节点类型判定”上完全一致。
- 对应“终点优先”：若终点格同时命中交叉判定，仍以汇流器语义为准，不在终点格额外生成桥接器。
- 对应“跨拐角禁止”：仅当被穿越目标为直线带/直线虚影时允许桥接；若为拐角带/拐角虚影则截断并拒绝非法尾段。

### 6.4 验收要点（人工测试）

1. 从合法端口起带，拖拽中途故意进入设备内部：
	 - 预期：虚影停在进入前一格；松手后落带到该合法终点。
2. 从错误方向尝试接入端口：
	 - 预期：虚影不进入错误端口；松手后提交截断前合法段。
3. 合法段 < 2 格（仅起点或 1 格）：
	 - 预期：可见虚影，不提交实例。
4. 全程合法路径：
	 - 预期：按完整路径提交，并保留现有分流/汇流/桥接自动生成规则。
5. 穿过虚影与穿过现有传送带一致性：
	- 预期：两者都创建桥接器，不应出现“桥接场景误生成为分流/汇流”。
6. 拐角虚影穿越限制：
	- 预期：跨直线虚影可桥接；跨拐角虚影应被截断且不提交该非法尾段。
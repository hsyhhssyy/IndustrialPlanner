# Stage1 UI 设计规范（当前实现）

> 本文档用于沉淀“当前可运行版本”的 UI 设计语言，重点覆盖视觉风格、设备外观、方向标识与状态反馈。

## 1. 设计目标

- 以“工业编辑器”定位为核心：清晰、稳重、信息密度高。
- 在深色背景下保证可读性与状态辨识度。
- 编辑态与仿真态共用同一视觉系统，仅通过状态高亮与文案提示区分。

## 2. 页面布局

### 2.1 三栏结构

- 左栏（`260px`）：工具栏，负责模式切换与设备/物流操作。
- 中栏（自适应）：网格画布，承载设备放置与物流可视化。
- 右栏（`340px`）：信息面板，负责统计、地块切换与选中对象详情。

地块规格（当前实现）：`60x60` 与 `40x40`。

### 2.2 顶栏

- 高度 `56px`，用于仿真总控：开始/退出仿真、倍速按钮、提示信息。
- 顶栏左上角提供语言切换（`中文 / English`）下拉框。
- 语言切换后页面文案应立即更新，并在刷新后保持上次选择。
- 顶栏与主内容区通过边线分隔，形成清晰的操作层级。

### 2.3 文案与 i18n

- 所有面向用户的核心 UI 文案必须接入统一 i18n 词典（禁止在组件内散落硬编码文案）。
- Stage1 至少覆盖：模式名称、按钮文案、面板标题、表头、详情字段、提示文案。
- 文案 fallback 规则：若翻译键缺失，应回退到稳定默认文案，不得显示异常占位符。
- 中英文切换仅影响显示层，不改变任何业务逻辑、坐标或仿真结果。

## 3. 视觉风格（Style Tokens）

### 3.1 字体

- 全局字体栈：`Segoe UI` / `PingFang SC` / `Microsoft YaHei` / `sans-serif`。
- 中文优先可读，英文与数字兼容展示。

### 3.2 颜色基调

- 页面背景：深灰蓝（`#151a22`）。
- 卡片/面板背景：更浅一层深蓝灰（`#1b222d`）。
- 分割线与边框：低对比冷灰蓝（`#2f3a4a`）。
- 正文文字：浅灰蓝（`#e5ebf3`）。
- 次级说明文字：低亮度灰蓝（`#a7b0bf` / `#b2bfd2`）。

### 3.3 控件形态

- 按钮统一小圆角（`6px`），边框+填充形成“可点击块”感。
- 激活按钮使用蓝色高亮底（`#395c93`）与更亮边框（`#4f7bc4`）。
- 禁用态统一降低不透明度并禁用手势（`opacity: 0.5` + `not-allowed`）。

## 4. 画布与网格视觉

### 4.1 画布框体

- 画布容器为卡片式面板，内部是固定像素正方形舞台。
- 舞台背景为深色（`#161c27`），外框使用细边线。

### 4.2 网格与边界

- 网格线颜色为低对比灰（`#2c3340`），强调“辅助定位”而非主视觉元素。
- 工业区外框使用橙色高亮（`#f28c28`），明确可操作边界。

### 4.3 视口反馈

- 支持滚轮缩放、空格/中键平移。
- 缩放/平移不改变逻辑坐标，仅改变观察视口。

### 4.4 画布分层（Z-Index 规范）

为避免遮挡歧义，Stage1 画布分层固定为以下顺序（数字越大越靠上）：

- `0`：网格背景（含地块边界）
- `1`：端口箭头（Chevron）
- `2`：传送带（带体与方向箭头）
- `3`：在途物品
- `4`：其他设备（非传送带设备）
- `5`：交互预览（放置虚影、框选框、物流路径预览）
- `6`：临时覆盖层（调试或临时可视化）

补充约束：

- 在途物品应使用统一覆盖层渲染，不嵌入单个带格内部渲染。
- 选中高亮不改变设备所属主层级（只改变描边/样式）。

## 5. 设备外观规范

### 5.1 设备主体

- 设备形状统一为矩形块，保持工程化、模块化视觉。
- 正常设备填充：蓝色系（`#2d4a78`），描边：`#5f7fb3`。
- 选中设备描边高亮：金色（`#f7d06a`）。
- 无效/阻塞设备填充：暗红（`#6a1f2e`），描边：亮红（`#ff6b6b`）。

### 5.2 设备文字

- 设备中心显示短名（`shortName`），无短名时回退名称。
- 文本颜色统一浅色（`#e5ebf3`），保持深底对比度。
- 文本始终正向显示，不跟随旋转翻转。

### 5.3 摆放与拖拽反馈

- 放置预览：半透明虚框。
- 合法放置预览：冷蓝色；非法越界预览：红色。
- 拖拽中的原始位置显示半透明“幽灵框”，便于对比移动前后位置。

## 6. 端口与方向标识

### 6.1 端口形状

- 端口使用“箭头化多边形”，直接表达流向语义。
- 端口根据方向旋转（`+x/-x/+y/-y`），保持朝向一致性。

### 6.2 端口配色

- 输出端口（`out`）：绿色（`#37c87a`）。
- 输入端口（`in`）：红色（`#ff5d5d`）。
- 当前物流拖拽起点端口：高亮黄（`#ffd166`）。

### 6.3 端口-带体连接视觉

- 当端口与带体邻接时，使用双层线段补全视觉连接。
- 外层深色、内层浅色，保持与传送带轨道一致的材质风格。

## 7. 传送带与节点外观

### 7.1 轨道线

- 传送带采用双层线：
  - 外层深绿（`#3e5a4e`）
  - 内层浅绿（`#bfe8d5`）
- 预览中轨道切换为棕黄系，区分“未提交路径”。

### 7.2 方向箭头

- 每条带段中部显示小三角箭头，表达当前可通行方向。
- 箭头颜色与轨道保持同色系，避免视觉噪声。

### 7.3 末端与微节点

- 未连接端点显示“端帽”线段，提示死端。
- 拐角/分汇流关键点显示双层圆点，强化拓扑可读性。

## 8. 在途物品视觉

- 在途物品以小方块表示，沿带段按 tick 插值移动。
- `item_originium_ore`：灰白系（填充 `#c9d1db`，描边 `#7e8a99`）。
- `item_originium_powder`：紫色系（填充 `#d7c0ff`，描边 `#7a5bb8`）。
- 拐角移动使用“两段式过渡”，减少视觉跳变。

## 9. 状态反馈系统

### 9.1 设备状态

- 摆放异常：显示“重叠停机”或“越界”（重叠允许摆放，但属于非法状态）。
- 运行异常：显示运行态状态文案（如 `starved` / `unpowered` 等）。
- 文案统一使用浅红色，位于设备区域内偏下位置。

状态语义补充：`starved` 为显示层状态，语义等同 `Idle`（未工作），并非新增运行态枚举。

状态词与运行态映射（Stage1）：

| UI 状态词 | 类型 | 运行态来源 | 触发条件（判定优先级从高到低） |
| --- | --- | --- | --- |
| overlap | 摆放/运行异常 | `stallReason=OVERLAP` | 占格冲突（可摆放但非法；进入仿真后按停机处理） |
| unpowered | 运行异常 | `stallReason=NO_POWER` | `requiresPower=true` 且未满足供电覆盖 |
| config_error | 运行异常 | `stallReason=CONFIG_ERROR` | 配置非法（如取货口未选择物品） |
| output_blocked | 运行异常 | `stallReason=OUTPUT_BLOCKED` | 可产出但下游不可接收 |
| starved | 显示层状态 | `stallReason=NO_INPUT` | 输入不足 |
| running | 运行中 | `stallReason=NONE` | 本 tick 正常推进且无停机原因 |

### 9.2 取货口特殊提示

- 取货口未选物品时，在设备中央显示 `?`（黄色高亮）。
- 右侧详情中，取货口除“取货物品”外还应提供 `无视库存` 开关（Switch）。
- 当开关开启时，该取货口可无视仓库库存持续取出所选物品。
- 当所选物品命中 `矿石` tag 时，该开关默认开启且禁用编辑（不可关闭）。

### 9.3 选中反馈

- 画布中：设备描边高亮，或传送带格显示高亮边框。
- 右侧面板中：联动显示当前选中设备/带格详情。

## 10. 面板信息设计

### 10.1 右侧统计区

- 采用卡片 + 表格展示仓库物品总量与 `/min` 变化速率。
- 明确标注“仓库统计”口径，并与地图设备状态展示解耦。
- 若某物品被取货口以“无视库存”方式取出，则该物品“当前库存”显示为 `∞`。

统计时间口径：`/min` 基于仿真时间计算，不受 `1x/2x/4x/16x` 倍速影响。

### 10.2 详情区

- 统一使用两列键值栅格（字段名 / 字段值）。
- 对长值启用自动换行，避免布局撑破。
- 设备详情应支持显示建筑标签（`tags`，多值使用分隔符展示）。
- 根据选中对象类型切换设备详情或传送带详情。

## 11. 交互一致性原则

- 颜色语义固定：
  - 蓝 = 常规设备
  - 绿 = 输出/可流动
  - 红 = 输入/错误/禁用
  - 黄 = 当前焦点/起点/选中强调
- 所有可编辑动作在仿真态受限，并通过按钮禁用与提示文案双重反馈。
- 同类操作（模式切换、按钮选中、删除子模式）复用同一控件样式，降低学习成本。

## 12. 后续可演进建议（不影响当前实现）

- 将颜色、间距、字号抽成设计 Token，便于主题化与规范复用。
- 为运行状态（`running/starved/unpowered`）增加图标层，减少英文状态词依赖。
- 将端口/轨道/节点的绘制参数统一配置化，便于不同缩放级别下的视觉优化。


---

# 附录：Stage1 UI 与交互实现指南（原 04 文档）

# 04 UI 与交互实现指南

## 1. 页面骨架

严格遵循三栏 + 顶栏：

- 左栏：工具栏（模式切换、设备选择、物流子模式、删除子模式）
- 中栏：网格画布（放置/拖拽/框选/铺带）
- 右栏：统计与选中对象详情
- 顶栏：仿真控制（开始/退出/倍速/提示）

地块规格（当前实现）：`60x60` 与 `40x40`，右栏支持地块切换。

## 2. 交互状态机

建议使用显式编辑模式机：

- `select`
- `place`
- `logistics`
- `delete`

并维护以下子状态：

- 当前选中对象（设备/带格/空）
- 当前设备类型（place 模式）
- 当前物流子模式（Stage1 仅传送带）
- 当前删除子模式（单格 / 整条联通带）

## 3. 选择模式

- 单击设备选中；再次点击空白取消
- 支持拖拽移动与框选移动
- `R` 键旋转选中设备
- 拖拽时展示原位置幽灵框

## 4. 放置模式

- 设备以左上角锚点放置
- 放置预览必须区分合法/非法
- 非法原因至少覆盖：越界、重叠
- 重叠属于“可摆放但非法”状态：允许落盘，进入仿真后以 `stallReason=OVERLAP` 标记并停机。
- 越界不可以落盘。也就是说不允许在放置模式放置越界设备。
- 传送带设备在放置模式时不出现在可放置设备列表。物流节点可以在放置模式手动放置。
- 放置模式手动放置 `item_log_splitter` / `item_log_converger` / `item_log_connector` 时，若目标格为 `belt_*`，则执行“覆盖替换”：删除该格被覆盖传送带，并在该格放置物流节点。

## 5. 物流模式（传送带）

路径输入规则：

- 按住左键拖拽铺设
- 仅允许格线方向；不允许单格落盘（定义：路径长度至少 2 格），但允许显示 1 格路径预览且松手不落盘
- 起点可为：设备输出端口 / 空地 / 传送带
- 终点可为：设备输入端口 / 空地 / 传送带
- 允许空地到空地形成孤立物流段

自动节点规则：

- 起点来自已有传送带：自动创建 `splitter`，原有传送带的入口方向成为 `splitter` 的入口方向。
- 终点接入已有传送带：自动创建 `merger`，原有传送带的出口方向成为 `merger` 的出口方向。
- 跨越直线带（路径内部节点）时：自动创建 `bridge`。
- 轨迹绘制过程中仅生成“临时节点预览”，不落盘：
	- 当前终点命中直线带格时，显示临时 `merger`。
	- 若继续拖拽使该格从“终点”变为“路径内部节点”，该临时节点必须即时重判为临时 `bridge`。
- 鼠标释放后，按最终路径一次性生成实际设备实例。
- 判定优先级：起点规则（`splitter`）与终点规则（`merger`）优先于路径内部跨越规则（`bridge`）。
- 禁止跨拐角带

## 6. 删除模式

- 单格删除：删除目标格设备
- 整条联通带：按 4 邻接删除整条连通传送网络中的纯传送带格（`belt_*`）
- `splitter` / `merger` / `bridge` 不属于“整条联通带”批量删除范围，遇到时停止删除遍历

## 7. 视觉规范映射

来自 UI 文档的关键语义必须落地：

- 正常设备：蓝色系；选中边框：金色；异常：红色系
- 输出端口绿色，输入端口红色，物流起点高亮黄色
- 传送带轨道双层线 + 中部方向箭头
- 工业区边界使用橙色强调
- 可编辑动作在仿真态受限（禁用 + 文案提示双反馈）

## 8. 信息面板

### 8.1 统计区

- 卡片 + 表格展示仓库内物品总量与 `/min` 变化速率
- 字段稳定排序，与仿真统计口径一致
- 统计仅基于仓库，不受当前地图设备增减影响
- `/min` 采用仿真时间口径，不受倍速按钮影响
- 若某物品被取货口以“无视库存”方式取出，则该物品“当前库存”显示 `∞`

### 8.2 详情区

- 两列键值布局
- 随选中对象类型切换设备详情/传送带详情
- 展示停机原因与关键运行字段（如 `progress01`）
- 取货口详情需提供 `无视库存` 开关（Switch）
- 当取货口所选物品命中 `矿石` tag 时，该开关默认开启且禁用编辑

## 9. 可用性守则

- 同类按钮复用一致样式与激活态
- 快捷键只保留 Stage1 必需项（如 `R`）
- 禁止新增与 PRD 无关的过滤器、浮窗、页面跳转

状态文案映射补充：

- `starved` 为显示层状态，语义等同 `Idle`（未工作）。
- 运行态枚举仍以 `stallReason` 为准，不新增 `STARVED` 枚举值。

## 10. 设备图像批量注册（实现约定）

设备图像采用“注册表驱动”而非渲染层硬编码：

- 注册入口：`src/domain/deviceSprites.ts`
- 注册结构：`DEVICE_SPRITE_REGISTRATIONS`
- 应用函数：`getDeviceSpritePath(typeId)`

批量新增设备图像时，仅需两步：

1. 将图像文件放入 `public/sprites/`。
2. 在 `DEVICE_SPRITE_REGISTRATIONS` 追加设备与文件名映射。

渲染层会自动根据 `typeId` 读取图像路径，无需再修改 `App.tsx` 的设备分支判断。

## 11. 全局提示与对话框（Toast / Modal）使用规范

Stage1 已提供统一的全局提示工具，避免业务层直接调用浏览器原生 `window.alert/window.confirm`。

### 11.1 Toast（轻提示，自动消失）

适用场景：

- 普通状态反馈（如“保存成功”“操作已完成”）
- 不要求用户确认已读

调用方式：

```ts
import { showToast } from '../../src/ui/toast'

showToast('操作成功')
showToast('规则校验失败', { variant: 'warning' })
showToast('网络异常，请稍后重试', { variant: 'error', durationMs: 3000 })
```

约束：

- 默认显示 2 秒
- 不阻塞业务流程
- 不承载“必须阅读后再继续”的关键提示

### 11.2 Modal 对话框（重要提示/确认）

统一入口：`src/ui/dialog.tsx`

#### A) Confirm（阻塞确认）

适用：危险操作、删除、覆盖等需要显式确认。

```ts
import { dialogConfirm } from '../../src/ui/dialog'

const confirmed = await dialogConfirm('确认删除所有内容吗？', {
	title: '确认',
	confirmText: '确定',
	cancelText: '取消',
	variant: 'warning',
})
if (!confirmed) return
```

#### B) Alert（阻塞版）

适用：必须中断当前流程，直到用户确认。

```ts
import { dialogAlertBlocking } from '../../src/ui/dialog'

await dialogAlertBlocking('检测到关键错误，请修复后继续。', {
	title: '提示',
	closeText: '确定',
	variant: 'error',
})
```

#### C) Alert（非阻塞版，需用户点击确定）

适用：重要提示，业务流程可继续，但要求用户“已读确认”。

```ts
import { dialogAlertNonBlocking } from '../../src/ui/dialog'

dialogAlertNonBlocking('当前存档包含旧版本设备，请尽快处理。', {
	title: '提示',
	closeText: '确定',
	variant: 'warning',
})
```

语义说明：

- 非阻塞 alert **不是 toast**
- 非阻塞 alert 不会阻塞主流程，但弹层必须用户点击“确定”才会关闭

### 11.3 i18n 接入约束

- 业务层调用时优先传入 `t('xxx.key')` 翻译后的文本
- 规则配置中的放置失败提示使用 key（例如 `violationMessageKey`）
- 禁止在业务逻辑里新增硬编码中英文混杂文案

### 11.4 选型建议（快速决策）

- 仅提示、无需确认：`showToast`
- 需要用户二选一：`dialogConfirm`
- 必须停住流程等待确认：`dialogAlertBlocking`
- 重要提示但不阻塞流程，且要求已读：`dialogAlertNonBlocking`

# Stage1 -> Stage2 迁移指南

## 1. 适用范围

- 适用对象：已运行 Stage1 编辑/仿真功能的前端版本。
- 目标版本：包含 Stage2 规划器能力的版本。
- 迁移特性：以“功能增量”形式引入，不替换 Stage1 主流程。

## 2. 迁移前检查

- 确认 Stage1 主功能可正常启动（编辑器、仿真、基础面板）。
- 记录当前本地持久化关键键值（用于回归与回滚核对）。
- 确认测试环境已覆盖中英文与常用浏览器。

## 3. 迁移步骤

1. 升级到 Stage2 版本代码并完成构建。
2. 启动后确认顶栏出现“产线规划器”入口。
3. 首次打开规划器，验证浮窗显示、关闭、再次打开状态保持。
4. 输入至少两条目标，验证聚合结果与配方切换重算。
5. 验证地区规则与条件配方规则是否生效（四号谷地/武陵）。
6. 在武陵地区验证流体工业三要素：可铺设管道、可接入管道设备、可选择流体配方。
7. 验证武陵扩展区域放置规则：抽水泵、管道、储水罐与管路设备可在扩展区域放置。
8. 验证抽水泵区域限制：扩展区域放置成功，基地内放置失败。
9. 验证扩展区抽水引水链路：抽水泵通过管道向基地内供水并可驱动流体配方。
10. 验证物品分类修正：紫晶矿应归类为矿物（固体），不应进入液体分类。
11. 验证瓶装液体规则：通用列表不直出 20 组合项，专用选择器可完成“瓶型 + 液体”选择。
12. 验证瓶型无关配方规则：UI 仅显示单条配方，执行层按瓶型展开且返还对应瓶子。
13. 验证武陵建筑上限规则：特定建筑（如天有烘炉）达到 `N` 后不可继续放置，删除后可恢复名额。
13.1 验证武陵建筑上限来源：`N` 由领域模型配置提供，未配置上限的建筑不应被误限。
14. 验证武陵上限地区隔离：同建筑在四号谷地不误触发武陵上限；在武陵执行 `N/N+1` 判定正确。
15. 验证管道传染规则：系统残留液体时异液输入阻塞；系统与连通储液罐排空后允许切换液体。
15.1 验证管道方向规则：管道本体无方向，可在任意端注入/抽取并形成有效输送。
15.2 验证分流/汇流方向规则：方向匹配可运输，方向不匹配不运输。
15.3 验证管道容量规则：连通管道本体容量按 `2 × 管道长度` 计算。
15.4 验证真实设备“储液罐”方向规则：储液罐保持 `1` 入口 + `1` 出口的定向行为。
16. 验证反应池规则：3 固体缓存位 + 2 液体缓存位；未选配方不生产；多配方可并行；产物按指定缓存端口送出。
17. 验证水培设备规则：水培设备以独立设备出现，不支持运行时形态切换，并可接入液体注入链路。
17.1 验证已知循环处理：种植闭环、蓝铁块/蓝铁粉末互转按专项规则处理；未知循环才截断。
18. 验证电力展示（耗电/发电）可见，且缺电场景下设备仍持续运转。
18.1 验证抽水泵电力口径：抽水泵具备耗电属性，但无需供电桩连接即可接入电网。
18.2 验证抽水泵效率口径：抽水泵输出效率与领域模型配置一致。
19. 验证电力统计三组数据（即时值/10 分钟/1 小时）均可见且按标准秒计算。
19.1 验证标准秒换算沿用 Stage1：`1 秒 = 20 tick`、`1 分钟 = 1200 tick`，且不受倍速影响。
20. 运行 Stage1 核心回归，确认无主流程回退。

## 4. 兼容性说明

| 维度 | 兼容级别 | 说明 |
|---|---|---|
| 配置项 | 完全兼容 | Stage1 配置继续有效，Stage2 增量配置独立新增 |
| 历史数据 | 完全兼容 | 不破坏 Stage1 已有地图与仿真数据逻辑 |
| 外部接口 | 部分兼容 | 若新增规划相关状态/事件或电力观测字段，需要调用方按新契约适配 |

## 5. 常见问题

- 症状：规划器结果为空或明显缺项。
	- 排查：是否启用了地区过滤导致配方候选被剔除。
	- 处理：切换目标组合或检查配方可用性。
- 症状：武陵地区无法完成流体链路。
	- 排查：确认管道是否连通、设备端口是否匹配、配方是否为流体配方。
	- 处理：按“管道 -> 端口设备 -> 流体配方”顺序逐项核对。
- 症状：抽水泵无法放置或在基地内被错误放置成功。
	- 排查：确认当前地块是否属于武陵扩展区域。
	- 处理：仅在扩展区域放置抽水泵，并检查“抽水泵仅扩展区”规则是否生效。
- 症状：紫晶矿未显示为矿物或被按液体处理。
	- 排查：检查物品元数据中紫晶矿分类是否为矿物（固体）。
	- 处理：修正分类映射并重新验证运输介质判定。
- 症状：瓶装液体在通用列表出现大量组合项（20 项）或无法选择。
	- 排查：检查是否启用了瓶装液体专用选择器与隐藏可见性规则。
	- 处理：恢复“通用列表隐藏 + 专用选择器选择”策略。
- 症状：瓶型无关配方显示 1 条但执行结果异常。
	- 排查：检查展示层聚合与执行层隐藏展开映射是否一致。
	- 处理：修正按瓶型展开逻辑并校验返瓶映射。
- 症状：武陵特定建筑可无限放置或提前被阻止。
	- 排查：检查“地区+建筑类型”上限配置与当前已放置计数。
	- 处理：修正上限映射或计数口径，确保 `N`/`N+1` 判定正确。
- 症状：管道中已有 A 液体时，B 液体被阻塞。
	- 排查：确认是否触发管道传染单液体锁定规则。
	- 处理：将系统及连通储液罐排空后再切换液体类型。
- 症状：管道分流器/汇流器已连接但不出液。
	- 排查：确认组件方向是否与当前输送方向一致。
	- 处理：调整分流器/汇流器朝向，方向匹配后重试。
- 症状：管道容量表现与预期不一致。
	- 排查：确认容量是否按“连通管道本体长度 × 2”计算，且未误计真实储液罐设备与设备缓存。
	- 处理：修正长度统计范围后复测双端注入/抽取场景。
- 症状：反应池没有产出或产出走错端口。
	- 排查：检查是否已手动选择配方、产物是否配置到正确缓存通道。
	- 处理：修正配方选择与产物路由配置后重试。
- 症状：找不到水培设备或无法使用。
	- 排查：确认水培设备是否已完成领域模型注册。
	- 处理：先补齐领域模型，再进行放置与仿真联调。
- 症状：切换配方后结果未变化。
	- 排查：是否切到等价配方，或切换对象未被当前需求链路引用。
	- 处理：核对目标输入与该物品在链路中的实际层级。
- 症状：农业链路出现循环异常提示。
	- 排查：确认是否属于种植机/采种机闭环场景。
	- 处理：核对闭环豁免规则与异常循环规则是否被误用。
- 症状：设备在缺电时停机或降速。
	- 排查：检查是否误将电力属性接入停机判定链路。
	- 处理：恢复“电力仅观测、接网约束不变”的运行规则。
- 症状：10 分钟/1 小时均值明显异常或随现实时间漂移。
	- 排查：检查统计窗口是否错误使用了现实时间而非标准秒。
	- 处理：改为基于仿真时间轴（标准秒）更新滚动窗口。

## 6. 回滚入口

- 触发条件：见 06-risk-and-rollback.md。
- 回滚简版流程：切回 Stage1 稳定版本 -> 清理 Stage2 新增持久化键 -> 回归 Stage1 核心流程。

# Stage2 增量设计说明（Design Delta）

## 1. 设计原则

- 仅记录相对 Stage1 的差异，不重复 Stage1 冻结基线。
- 输入约束、候选集合、计算集合保持同一过滤口径。
- 优先保证“可解释结果”，再考虑后续优化能力扩展。

## 2. 架构差异

| 模块 | Stage1 | Stage2 | 变更原因 |
|---|---|---|---|
| 功能入口 | 以编辑器/仿真为核心 | 顶栏新增“产线规划器”入口 | 提供从目标产量反推设备需求能力 |
| 业务编排 | 以地图构建与仿真推进为主 | 增加静态产线依赖展开与重算链路 | 承接原 Stage3 方向的第一步 |
| 地区能力 | 地区能力有限 | 武陵地图上线并接入流体工业能力 | 扩展地区玩法与工业链路 |
| 反馈体系 | Toast 使用较分散 | 引入 Toast 分级与降噪治理 | 降低高频操作噪音 |

## 3. 数据模型差异

| 实体/字段 | Stage1 | Stage2 | 兼容策略 |
|---|---|---|---|
| 规划目标列表 | 无 | 目标物品 + 目标吞吐（/min）集合 | 新增，不影响旧数据 |
| 规划器视图状态 | 无 | 浮窗显示状态、位置、上次输入 | 新增，不影响旧数据 |
| 地区约束上下文 | 地图规则为主 | 规划器新增地区切换与过滤上下文 | 兼容，支持四号谷地/武陵 |
| 配方选择状态 | 默认配方内置 | 允许按物品记录用户选择配方 | 兼容，未选择时走默认 |
| 设备电力属性 | 仅部分设备存在供电要求语义 | 全设备具备耗电属性，部分设备具备发电属性 | 兼容，未配置发电视为 0 |
| 电力统计状态 | 无统一窗口统计 | 即时值 + 10 分钟/1 小时滚动均值 | 新增，基于标准秒时间轴 |
| 流体网络要素 | 无 | 新增管道、管道端口设备、流体配方 | 新增，武陵地区启用 |
| 扩展区域抽水入口 | 无 | 新增抽水泵（清水无限资源）与扩展区域放置约束 | 新增，武陵地区启用 |
| 反应池运行状态 | 无 | 新增反应池缓存、配方选择、产物路由状态 | 新增，武陵地区启用 |
| 水培设备实体 | 无 | 新增独立水培设备实体（如种植机（水培）） | 新增，先补领域模型再启用 |
| 物品分类修正 | 紫晶矿未标注矿物 | 紫晶矿补充为矿物（固体）分类 | 修正，不改变接口结构 |
| 瓶装液体组合项 | 无 | 新增 20 个隐藏组合物品（4 瓶型 × 5 液体） | 新增，UI 不直接平铺展示 |
| 瓶装液体选择状态 | 无 | 新增瓶型/液体选择器状态与结果映射 | 新增，不影响旧流程 |
| 地区建筑上限配置 | 无 | 新增“地区+建筑类型=>上限N”配置映射 | 新增，默认未配置则不限制 |

## 4. 计算与规则差异

- 多目标同物品需求按吞吐合并计算。
- 多配方物品允许手动切换，切换即全局重算。
- 四号谷地下过滤武陵专属内容，武陵地区开放对应内容。
- 蓝铁块/蓝铁粉末互转配方仅在双需求场景进入候选与计算。
- 农业闭环（种植机/采种机）按闭环平衡计算机器数，不显示循环异常。
- 非农业循环仍按异常处理并在路径上截断。
- 流体工业链路引入三要素：管道连接、管道端口设备、流体配方计算。
- 管道重叠规则：
	- 不可与生产设备重叠；
	- 可与传送带及其分流/汇流/桥接组件重叠；
	- 重叠互不干扰。
- 管道输送规则：基准速度 `2` 液体/标准秒/格。
- 管道组件规则：新增管道分流器、管道汇流器、管道桥接器，语义对齐传送带版本。
- 扩展区域规则（武陵）：
	- 扩展区域允许放置抽水泵、管道、储水罐及管路设备（分流/汇流/桥接）；
	- 抽水泵仅允许放置在扩展区域；
	- 抽水泵产出清水并通过管道接入基地内流体网络。
- 瓶装液体规则：
	- 内部以“瓶型 × 液体”组合项建模，组合项默认隐藏；
	- 通用物品列表不展开组合项，由专用选择器生成目标组合项；
	- 特定瓶型配方直接绑定单一组合项；
	- 瓶型无关配方在展示层聚合为单条，在执行层按瓶型展开为多条隐藏配方；
	- 返瓶配方需保持瓶型守恒（输入瓶型与返还瓶型一致）。
- 武陵建筑上限规则：
	- 按“地区 + 建筑类型”读取摆放上限；
	- 示例：武陵地区 `天有烘炉` 上限为 `N`；
	- 放置前执行上限校验，超限立即拒绝；
	- 删除建筑后，计数同步回收。
- 管道可视化规则：仅显示当前流体颜色，不显示离散流体“盒子”动画。
- 管道传染规则（正式）：
	- 管道系统由管道、储液罐及分流/汇流/桥接连通的管段组成；
	- 同一系统仅允许一种液体；
	- 系统内有液体残留时，异液输入必须阻塞；
	- 系统与连通储液罐完全排空后才允许切换液体；
	- 设备内部液体不计入管道系统排空判定；
	- 桥接器视为两条独立通道，传染不跨通道传播。
- 反应池规则：
	- 缓存结构固定为 `3` 固体缓存位 + `2` 液体缓存位；
	- 固体与液体缓存独立，不共享容量与出料通道；
	- 放置模式下由用户手动选择执行配方；
	- 未选择配方时反应池不执行生产；
	- 支持多配方并行执行；
	- 每个配方产物可路由到指定缓存，并由对应端口输出。
- 水培设备规则：
	- 将形态切换能力映射为独立设备，不实现运行时切换；
	- 水培设备具备独立设备 ID、端口定义与配方可用性；
	- 水培设备通过自身流体端口接入管道系统。
- 新增电力展示口径（耗电/发电/净电力）用于观测，不参与生产停机判定。
- 保持“必须接入电网”前置约束，不因电力缺口放宽接入规则。
- 新增电力窗口统计：
	- 即时值：当前仿真 Tick 的发电/耗电值
	- 10 分钟均值：最近 `600` 标准秒滚动平均
	- 1 小时均值：最近 `3600` 标准秒滚动平均
- 统计窗口按仿真标准秒推进，倍速仅影响推进速度，不改变统计定义。
- 物品分类修正规则：
	- 紫晶矿在本版本归类为矿物（固体）；
	- 该修正仅影响分类/过滤与运输介质合法性判定，不引入液体语义。

## 5. UI/交互差异

- 入口变化：顶栏新增规划器按钮，打开独立浮窗。
- 结果呈现：由自由文本/列表信息转向三列伪表格卡片。
- 可读性要求：展示设备名与可读配方文本，不直接暴露 recipeId。
- 反馈策略：高频显式操作默认静默，失败与关键完成反馈保留。
- 新增观测信息：设备耗电与发电展示，支持发电调试。
- 新增抗震荡观测：同屏展示即时值与两档滚动均值。
- 武陵地区新增流体工业交互（管道铺设与流体链路展示）。
- 管道视觉采用颜色状态表达当前流体类型，避免高频粒子渲染噪音。
- 反应池新增交互：放置时配方选择与产物输出缓存路由配置。
- 水培设备新增交互：作为独立设备出现在放置与选择列表中。
- 抽水泵交互新增校验：基地内放置直接拒绝，扩展区域放置允许。
- 瓶装液体交互新增选择器：以“瓶型 + 液体”两级选择替代 20 项平铺列表。
- 武陵特定建筑交互新增上限反馈：达到 `N` 时给出可理解失败提示。

## 6. 影响与权衡

- 收益：用户可直接由目标吞吐反推设备需求，降低试错成本。
- 成本：规则分支增多，计算口径与过滤一致性维护成本上升。
- 风险：配方切换与条件配方可能引入边界场景结果抖动；电力语义若与停机逻辑误耦合将造成回归；流体端口与配方映射不一致会导致链路失效；管道重叠规则或流速口径实现错误会导致流体行为偏差；管道传染边界（排空判定、桥接通道隔离）实现错误会造成错误阻塞或串染；抽水泵区域放置校验错误会导致外区规则失效；瓶装液体单展示与隐藏展开不一致会导致配方结果偏差；武陵建筑上限计数错误会导致误拒绝或误放行；反应池多配方并行与产物路由配置不一致会导致出料错误；水培设备未独立建模会导致形态状态与仿真状态耦合错误。

## 7. 追踪链接

- 需求来源：01-planner-module-mvp.md
- 提示治理：02-toast-governance.md
- 风险背景：code-structure-smell-review.md

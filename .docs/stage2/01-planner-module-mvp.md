# Stage2-01 产线规划器（基础版）需求与 DoD

## 1. 背景与范围

根据阶段重定义，原 PRD 中“Stage2 的三条能力（更多配方/多产物/复杂输入）”已在现有系统具备基础数据能力。

因此新的 Stage2 目标调整为原 Stage3 的第一步：

- 在应用内集成一个基础产线规划器
- 支持多目标输入与配方分支手动切换
- 输出依赖展开后的需求机器数和中间吞吐（按物品平铺卡片聚合展示）

## 2. 功能需求（MVP）

### 2.1 入口与容器

- 顶栏在“合成百科”旁新增入口按钮“产线规划器”。
- 打开后以浮窗展示，尺寸为视口 `80% x 80%`。
- 支持关闭；再次打开时保持上次内容与窗口位置。

### 2.2 目标输入

- 用户可添加多行目标。
- 每行包含：
  - 目标物品（Item）
  - 目标吞吐（单位：`/min`）
- 允许同时规划多个目标并合并计算。
- 目标区顶部新增“地区切换”：
  - 可见选项为“四号谷地”“武陵”；
  - 当前版本“武陵”不可选（禁用态，仅展示）。
- 当地区为“四号谷地”时：
  - 目标物品下拉中不可选择带“武陵”tag 的物品；
  - 若历史已选目标因规则变为不可用，需自动回退到可用物品。

### 2.3 计算输出

- 输出按“平铺卡片”展示结果（按物品聚合，可标记来源层级）。
- 卡片内容采用三列“伪表格”布局：
  - 第一列：物品名称 + 配方（可读文本，不显示 `recipeId`）
  - 第二列：当前物品需求吞吐（`/min`）
  - 第三列：设备类型（设备名称）+ 机器数量（支持小数）
- “输入吞吐”作为第一列内的次级信息展示（弱化样式，不抢主信息）。
- 为避免重复信息，“产出吞吐”不单独展示。
- 必须支持中间物品的吞吐计算与聚合展示。

### 2.4 多配方手动切换

- 若某个物品有多个可产出配方，默认选择其中一个。
- 用户可手动切换该物品采用的配方。
- 切换后立即触发全局重算并刷新层级结果。
- 配方候选必须受地区规则约束：
  - 当地区为“四号谷地”时，凡输入或输出涉及“武陵”tag 物品的配方不可用；
  - 计算与展示均基于过滤后的可用配方集合。
- 蓝铁块/蓝铁粉末互转配方属于“条件启用配方”：
  - 配方对：`蓝铁粉末 -> 蓝铁块` 与 `蓝铁块 -> 蓝铁粉末`。
  - 仅当“其他配方统计结果”中同时存在蓝铁块与蓝铁粉末需求时，才允许这两条互转配方进入可选集合。
  - 当条件不满足时，互转配方必须从可选配方与计算配方中同时移除。
  - 一旦某物品选择互转配方，该物品按互转链路计算，不再按直接生产配方计算。

### 2.5 循环配方展示（含种植机/采种机）

- 系统存在由 `采种机 + 种植机` 组合形成的循环依赖配方链。
- 依赖展开必须支持循环检测，避免无限递归。
- 对于“种植机/采种机”构成的农业闭环，视为正常生产链：
  - 不显示循环异常标签与循环告警；
  - 机器数量按配方倍率的闭环平衡结果计算（而非递归节点累加）。
- 对非农业闭环，仍按异常循环处理：
  - 可显示循环标记；
  - 对该路径后续展开进行截断。

## 3. 非目标（本阶段不做）

- 自动地图布局与自动连线
- 多目标最优解搜索（成本最小化、机型最少化）
- 副产物回收闭环优化
- 与仿真地图实例双向绑定

## 4. 计算口径

- 配方速率：`每台产能 = outputs.amount / cycleSeconds * 60`
- 机器需求：`需求量 / 对应产能`
- 多目标同物品需求应汇总计算。
- 遇到无配方可生产的物品，标记为“基础供给需求（raw demand）”。
- 配方展示口径：在 UI 中使用“设备名 + 输入 -> 输出”的可读表达；`recipeId` 仅作为内部计算键。
- 农业闭环（种植机/采种机）采用基线需求 + 联立平衡修正：
  - 先基于“移除农业互转配方”的结果统计外部需求；
  - 再按闭环倍率联立计算两侧总需求与机器数量。
- 示例（砂叶）：当外部需求为 `砂叶 120/min`，稳态结果为 `种植机 8 台`、`采种机 4 台`（采种机:种植机 = 1:2）。

## 5. DoD（基础版完成定义）

1. 能输入至少 2 个目标物品并成功计算。
2. 结果以按物品聚合的平铺卡片展示，并可识别来源层级。
3. 对存在多配方的物品可切换配方并实时重算，且配方显示为可读文本。
4. 能正确显示种植机/采种机场景中的循环引用，并进行截断。
5. 浮窗关闭后再次打开，输入内容与窗口位置保持一致。
6. 不影响 Stage1 编辑/仿真主流程。
7. 目标区显示地区切换，且“武陵”选项为禁用态。
8. 在“四号谷地”下，目标物品与配方均正确过滤“武陵”tag 相关内容。
9. 结果区采用三列伪表格卡片（物品/配方、需求、设备），且“输入吞吐”位于第一列次信息区域。
10. 蓝铁块/蓝铁粉末互转配方仅在“双需求”条件下可选；条件不满足时不可选且不参与计算。
11. 种植机/采种机闭环按平衡口径计算，且不显示循环异常提示；`砂叶 120/min` 场景输出 `种植机 8`、`采种机 4`。
# Stage2-01 产线规划器（基础版）需求与 DoD

## 1. 背景与范围

根据阶段重定义，原 PRD 中“Stage2 的三条能力（更多配方/多产物/复杂输入）”已在现有系统具备基础数据能力。

因此新的 Stage2 目标调整为原 Stage3 的第一步：

- 在应用内集成一个基础产线规划器
- 支持多目标输入与配方分支手动切换
- 输出依赖展开后的需求机器数和中间吞吐（按物品平铺卡片聚合展示）

## 2. 功能需求（MVP）

### 2.1 入口与容器

- 顶栏在“合成百科”旁新增入口按钮“产线规划器”。
- 打开后以浮窗展示，尺寸为视口 `80% x 80%`。
- 支持关闭；再次打开时保持上次内容与窗口位置。

### 2.2 目标输入

- 用户可添加多行目标。
- 每行包含：
  - 目标物品（Item）
  - 目标吞吐（单位：`/min`）
- 允许同时规划多个目标并合并计算。
- 目标区顶部新增“地区切换”：
  - 可见选项为“四号谷地”“武陵”；
  - 本阶段“四号谷地”“武陵”均可选。
- 当地区为“四号谷地”时：
  - 目标物品下拉中不可选择带“武陵”tag 的物品；
  - 若历史已选目标因规则变为不可用，需自动回退到可用物品。
- 当地区为“武陵”时：
  - 开放武陵地区专属物品、设备与配方；
  - 开放流体工业相关候选（流体物品、流体配方、管道设备）。

### 2.3 计算输出

- 输出按“平铺卡片”展示结果（按物品聚合，可标记来源层级）。
- 卡片内容采用三列“伪表格”布局：
  - 第一列：物品名称 + 配方（可读文本，不显示 `recipeId`）
  - 第二列：当前物品需求吞吐（`/min`）
  - 第三列：设备类型（设备名称）+ 机器数量（支持小数）
- “输入吞吐”作为第一列内的次级信息展示（弱化样式，不抢主信息）。
- 为避免重复信息，“产出吞吐”不单独展示。
- 必须支持中间物品的吞吐计算与聚合展示。

### 2.4 多配方手动切换

- 若某个物品有多个可产出配方，默认选择其中一个。
- 用户可手动切换该物品采用的配方。
- 切换后立即触发全局重算并刷新层级结果。
- 配方候选必须受地区规则约束：
  - 当地区为“四号谷地”时，凡输入或输出涉及“武陵”tag 物品的配方不可用；
  - 计算与展示均基于过滤后的可用配方集合。
- 蓝铁块/蓝铁粉末互转配方属于“条件启用配方”：
  - 配方对：`蓝铁粉末 -> 蓝铁块` 与 `蓝铁块 -> 蓝铁粉末`。
  - 仅当“其他配方统计结果”中同时存在蓝铁块与蓝铁粉末需求时，才允许这两条互转配方进入可选集合。
  - 当条件不满足时，互转配方必须从可选配方与计算配方中同时移除。
  - 一旦某物品选择互转配方，该物品按互转链路计算，不再按直接生产配方计算。

### 2.5 循环配方展示（含种植机/采种机）

- 系统存在由 `采种机 + 种植机` 组合形成的循环依赖配方链。
- 依赖展开必须支持循环检测，避免无限递归。
- 对于“种植机/采种机”构成的农业闭环，视为正常生产链：
  - 不显示循环异常标签与循环告警；
  - 机器数量按配方倍率的闭环平衡结果计算（而非递归节点累加）。
- 对于系统中“已知循环配方”，按专项规则处理，不按异常截断：
  - 当前已知循环包括：`采种机 + 种植机` 农业闭环、`蓝铁块 <-> 蓝铁粉末` 互转闭环。
- 对非农业闭环，仍按异常循环处理：
  - 可显示循环标记；
  - 对该路径后续展开进行截断。

### 2.6 电力属性引入（观测用途）

- 本阶段为所有设备引入电力属性：
  - `powerDemand`（耗电）
  - `powerSupply`（发电，非发电设备为 `0`）
- 保留“必须接入电网”作为设备可运行前提，接入规则与现有口径一致。
- 电力不足时设备仍可继续运转：
  - 不因供电缺口停机；
  - 不因供电缺口降速；
  - 不改写产线吞吐与机器数量计算结果。
- 电力属性引入目的为“发电调试与可视化”，仅要求展示：
  - 设备耗电（单机与聚合）
  - 设备发电（单机与聚合）
  - 净电力（发电 - 耗电）
  - 发电/耗电统计口径三组数据：
    - 当前即时值
    - 10 分钟滚动窗口平均
    - 1 小时滚动窗口平均
  - 时间口径统一为“标准秒”，不是现实时间。

### 2.7 武陵地区流体工业（三要素）

- 在武陵地区地图中引入流体工业基础能力，包含以下三项且缺一不可：
  1. 管道铺设：支持基础管道放置、连接与编辑。
  2. 管道出入口设备：支持具有流体输入/输出端口的设备接入管网。
  3. 流体配方：支持包含流体输入或输出的配方参与计算与展示。
- 管道铺设与占位规则：
  - 管道不可与任何生产设备重叠。
  - 管道可与传送带、分流器、汇流器、桥接器重叠。
  - 重叠时双方互不干扰运行（物流与流体各自按本系统规则结算）。
- 管道流速与可视化规则：
  - 管道基准速度为 `2` 液体/标准秒/格。
  - 管道不展示流体“盒子/单位粒子”动画。
  - 管道仅展示当前流体类型对应颜色（或等价颜色标识）。
- 管道方向与容量规则：
  - 管道本体无方向，可从任意方向向任意方向输送液体。
  - 连通的“管道本体”在结算上视为一个等效管道缓存池（抽象模型，非设备“储液罐”）。
  - 等效管道缓存池容量 = `2 × 管道长度`（仅统计管道本体长度，不含真实储液罐设备与设备内部缓存）。
  - 等效管道缓存池允许在任意端进行液体注入与抽取。
  - 真实设备“储液罐”为定向设备，具备 `1` 入口与 `1` 出口。
- 管道网络组件：
  - 管道分流器、管道汇流器、管道桥接器均需提供。
  - 功能语义与传送带对应组件一致（分流/汇流/跨越），但作用对象为流体链路。
  - 管道分流器与管道汇流器为有方向组件：方向不匹配时不运输（该路径流量为 0）。
- 管道传染（关键特性，正式生效）：
  - “管道系统”定义：由管道、储液罐及通过管道分流器/汇流器/桥接器连通的管段构成；其中分流器/汇流器仅在方向匹配时视为连通。
  - 桥接器按“两条互不连通的独立管道通道”处理，传染只沿各自通道传播，不跨通道传播。
  - 同一管道系统在任一时刻只允许存在一种液体类型。
  - 若系统任意位置存在 A 液体（哪怕仅 1 滴），向该系统注入 B 液体必须被阻塞。
  - 阻塞判定不以“是否还有空余容量”为转移，只以“系统内是否残留其他液体”为准。
  - “完全排空”条件：
    - 系统内所有管段液体为 `0`；
    - 与该系统连通的储液罐液体为 `0`；
    - 设备内部缓存液体不计入管道系统排空判定。
  - 仅在满足完全排空后，系统才可切换为运输另一种液体。
- 三要素在口径上保持一致：
  - 可放置的管道设备，其流体端口必须可被管道连接；
  - 可选流体配方的输入/输出，必须能映射到可连接的流体端口与流体物品；
  - 规划器展示中，流体项与非流体项遵循同一聚合与可读展示原则。

### 2.8 武陵特殊设备：反应池（Reactor Pool）

- 反应池已存在于领域模型，本阶段需在仿真与交互中启用。
- 反应池缓存结构：
  - 固体缓存位：`3` 个；
  - 液体缓存位：`2` 个；
  - 固体与液体缓存互不干扰。
- 反应池配方执行规则：
  - 可同时进行多个配方生产（并行执行）；
  - 具体生产哪些配方由用户在放置模式手动选择；
  - 若用户未选择任何配方，则反应池不生产。
- 产物路由规则：
  - 反应池存在 `2` 个液体输出口与 `1` 个固体输出缓存通道；
  - 三条输出通道互不共享；
  - 用户可为某个配方的产物指定目标缓存/通道；
  - 产物进入对应缓存后，由该缓存对应端口送出。

### 2.9 可切换形态设备的实现策略（水培设备）

- 在《明日方舟：终末地》中存在可切换形态设备（例如：种植机 <-> 水培种植机）。
- 在本仿真系统中，本阶段不实现“运行时形态切换”，统一采用“独立新设备”实现：
  - 示例：新增 `种植机（水培）` 作为独立设备，而非 `种植机` 的形态状态。
- 水培设备规则：
  - 具备独立设备标识、独立配方可用性与独立端口定义；
  - 需要液体注入链路时，通过其独立流体端口接入管道系统；
  - 与原始设备共享业务语义但不共享运行时形态状态。
- 领域模型状态：
  - 当前水培设备尚未加入领域模型；
  - 本阶段需先补齐领域模型，再接入放置、仿真与规划器候选。

### 2.10 物品类别与运输介质合法性（固液分离）

- 物品类别新增：`液体`。
- 数据迁移要求：部分既有物品将由 `固体` 调整为 `液体`。
- 运输介质约束：
  - 液体不可通过传送带运输；
  - 固体不可通过管道运输。
- 接口合法性约束：
  - 传送带端口与管道端口互为非法接口；
  - 管道网络仅接受液体类输入/输出；
  - 传送带网络仅接受固体类输入/输出。
- 连通判定要求：
  - 若物品类别与介质不匹配，连通请求必须失败；
  - 失败应以规则失败口径反馈，不进入隐式转换。
- 版本修正规则：
  - 上一版本遗漏“紫晶矿”的矿物分类；
  - 本版本需将紫晶矿补充为“矿物（固体）”并参与固体侧规则。

### 2.11 扩展区域清水接入（抽水泵）

- 背景约束：仿真系统不处理基地外行为。
- 规则定义：
  - 允许用户在基地外“扩展区域”布设抽水泵；
  - 抽水泵产出清水，视为无限资源入口；
  - 抽水泵输出效率由领域模型配置提供；
  - 抽水泵具备耗电属性，但不要求供电桩连接，可凭空接入电网；
  - 抽水泵需通过管道接入基地内网络后方可参与流体链路。
- 区域放置约束（武陵）：
  - 抽水泵、管道、储水罐、管路设备（分流/汇流/桥接）允许布置在扩展区域；
  - 抽水泵仅允许布置在扩展区域，基地内放置应判定失败。
- 仿真口径：
  - 扩展区域仅提供资源入口语义，不引入基地外实体仿真与路径求解；
  - 清水供给能力按抽水泵规则进入现有管道吞吐结算。

### 2.12 瓶装液体（隐藏物品与专用选择器）

- 领域差异：
  - 原游戏中“瓶装液体”更接近“瓶子属性”；
  - 本系统中“瓶装液体”按物品建模，但属于隐藏物品。
- 组合规则：
  - 瓶型共 `4` 种，液体共 `5` 种；
  - 内部维护 `4 × 5 = 20` 个瓶装液体组合物品。
- UI 选择规则：
  - 通用物品选择列表不直接暴露这 `20` 个组合物品；
  - 提供“瓶装液体专用选择器”，先选瓶型再选液体（或等价交互）。
- 配方匹配规则：
  - 部分配方要求“特定瓶型 + 特定液体”，需严格匹配对应组合物品；
  - 部分配方对瓶型不敏感，仅关心液体类型。
- 瓶型无关配方展示与执行：
  - 配方表中仅展示 `1` 条配方；
  - 实现层按瓶型展开为一组隐藏配方（按瓶型维度展开）；
  - 产出后若规则要求返还瓶子，需按输入瓶型返还对应瓶子物品。
- 匹配决策规则：
  - 除反应池外，设备根据收到的输入物品匹配配方；
  - 反应池不使用带有瓶子的配方。

### 2.13 武陵特定建筑摆放上限

- 规则目标：限制武陵地区特定高价值建筑的可放置数量。
- 基础规则：
  - 在武陵地区，特定建筑存在摆放上限 `N`；
  - 示例：天有烘炉最多只能摆放 `N` 个。
  - 上限 `N` 由领域模型配置提供。
- 判定规则：
  - 已放置数量 `< N` 时允许放置；
  - 已放置数量 `>= N` 时放置失败；
  - 删除对应建筑后可释放名额并再次放置。
- 区域规则：
  - 该上限规则仅在武陵地区生效；
  - 四号谷地不受武陵专属上限约束。

## 3. 非目标（本阶段不做）

- 自动地图布局与自动连线
- 多目标最优解搜索（成本最小化、机型最少化）
- 副产物回收闭环优化
- 与仿真地图实例双向绑定
- 电力潮流仿真与电网负载求解
- 因电力不足导致的设备停机/降速机制
- 流体压力损耗、温度变化、相变与复杂网络求解
- 运行时设备形态切换系统（本阶段不实现）
- 固体/液体自动互转与跨介质自动适配
- 基地外世界完整仿真（扩展区域仅承载抽水入口语义）
- 在通用物品下拉中直接平铺显示全部瓶装液体组合项
- 全局统一建筑数量上限系统（仅实现武陵特定建筑上限）

## 4. 计算口径

- 时间口径总则（沿用 Stage1）：在所有文档中，凡提到 X 秒 / X 分钟，均按仿真时间定义：`1 秒 = 20 tick`、`1 分钟 = 1200 tick`；该口径不受仿真倍速影响。
- 术语定义：`标准秒` 是规则层时间单位，表示与仿真倍速无关的固定时间。

- 配方速率：`每台产能 = outputs.amount / cycleSeconds * 60`
- 机器需求：`需求量 / 对应产能`
- 多目标同物品需求应汇总计算。
- 遇到无配方可生产的物品，标记为“基础供给需求（raw demand）”。
- 配方展示口径：在 UI 中使用“设备名 + 输入 -> 输出”的可读表达；`recipeId` 仅作为内部计算键。
- 流体配方口径：流体输入/输出与固体输入/输出并列展示，单位与标签可区分但遵循同一可读规则。
- 物品类别口径：
  - 固体与液体为互斥类别；
  - 类型变更后的物品按新类别参与运输与端口合法性判定。
  - 紫晶矿归类为矿物（固体），遵循固体运输与端口判定口径。
- 管道输送口径：
  - 单格基准输送能力为 `2` 液体/标准秒。
  - 管道本体无方向，可在任意连接方向进行输送。
  - 连通管道本体按等效管道缓存池结算：`容量 = 2 × 管道长度`。
  - 等效管道缓存池允许双端提交（注入）与双端取出（抽取）。
  - 分流/汇流/桥接组件的吞吐继承管道速度基准。
  - 分流器/汇流器方向不匹配时，相关路径吞吐记为 `0`。
  - 管道可视化仅体现流体颜色，不体现离散“盒子”粒子。
  - 管道传染口径：
    - 系统液体类型锁定为当前系统内首个非空液体类型；
    - 锁定期间，其他液体输入均返回“阻塞”；
    - 系统与连通储液罐完全排空后解除锁定。
- 反应池口径：
  - 固体/液体缓存容量、占用与出料各自独立结算；
  - 多配方并行时按各配方输入可得性与目标缓存可用性分别推进；
  - 未选配方不进入执行队列；
  - 配方产物仅写入用户指定缓存，不进行自动改道。
- 水培设备口径：
  - 水培设备作为独立设备参与机器数、吞吐与端口连通计算；
  - 不存在“同一设备运行时切换形态”导致的状态迁移计算；
  - 流体注入需求由水培设备自身流体端口与配方输入定义驱动。
- 介质匹配口径：
  - 管道仅结算液体吞吐；
  - 传送带仅结算固体吞吐；
  - 端口类型不匹配时吞吐记为 0 且连接无效。
- 扩展区域口径：
  - 武陵扩展区域允许流体设施放置（抽水泵/管道/储水罐/管路设备）；
  - 抽水泵是清水无限资源入口，仅允许外区放置；
  - 抽水泵输出效率由领域模型配置提供；
  - 抽水泵具备耗电属性，但无需供电桩连接，可凭空接入电网；
  - 外区到基地内仅通过管道连通生效。
- 瓶装液体口径：
  - 瓶装液体组合项在实现层存在，在通用列表中默认隐藏；
  - 专用选择器负责生成目标组合项（瓶型 × 液体）；
  - 瓶型无关配方仅单条展示，但计算按隐藏展开配方执行；
  - 瓶子返还遵循“输入瓶型 -> 返回同瓶型”映射。
- 武陵建筑上限口径：
  - 上限按“建筑类型 + 地区”维度配置；
  - 天有烘炉在武陵的上限为 `N`（由配置提供）；
  - 上限校验在放置前执行，失败不进入后续连通与仿真流程。
- 农业闭环（种植机/采种机）采用基线需求 + 联立平衡修正：
  - 先基于“移除农业互转配方”的结果统计外部需求；
  - 再按闭环倍率联立计算两侧总需求与机器数量。
- 示例（砂叶）：当外部需求为 `砂叶 120/min`，稳态结果为 `种植机 8 台`、`采种机 4 台`（采种机:种植机 = 1:2）。
- 已知循环口径：`采种机 + 种植机` 与 `蓝铁块 <-> 蓝铁粉末` 属于已知循环，按专项规则处理；未知/意外循环才进入异常截断流程。
- 电力展示口径：
  - 总耗电 = `Σ(设备台数 × 设备 powerDemand)`
  - 总发电 = `Σ(设备台数 × 设备 powerSupply)`
  - 净电力 = `总发电 - 总耗电`
  - 电力缺口不参与停机判定，不影响吞吐结算。
  - 即时值口径：当前 Tick 对应的功率值（按标准秒换算）。
  - 10 分钟滚动均值：最近 `600` 标准秒窗口平均。
  - 1 小时滚动均值：最近 `3600` 标准秒窗口平均。
  - 滚动窗口基于仿真时间推进，不受现实时间与帧率波动影响。

## 5. DoD（基础版完成定义）

1. 能输入至少 2 个目标物品并成功计算。
2. 结果以按物品聚合的平铺卡片展示，并可识别来源层级。
3. 对存在多配方的物品可切换配方并实时重算，且配方显示为可读文本。
4. 能正确处理循环引用：已知循环（种植机/采种机、蓝铁块/蓝铁粉末）按专项规则处理且不显示异常；未知/意外循环进行截断。
5. 浮窗关闭后再次打开，输入内容与窗口位置保持一致。
6. 不影响 Stage1 编辑/仿真主流程。
7. 目标区显示地区切换，且“四号谷地/武陵”均可选。
8. 在“四号谷地”下，目标物品与配方均正确过滤“武陵”tag 相关内容；在“武陵”下相关内容可用。
9. 结果区采用三列伪表格卡片（物品/配方、需求、设备），且“输入吞吐”位于第一列次信息区域。
10. 蓝铁块/蓝铁粉末互转配方仅在“双需求”条件下可选；条件不满足时不可选且不参与计算。
11. 种植机/采种机闭环按平衡口径计算，且不显示循环异常提示；`砂叶 120/min` 场景输出 `种植机 8`、`采种机 4`。
12. 所有设备均可配置并展示耗电；发电设备可展示发电量。
13. 在“电力不足”场景下，设备仍持续运转且吞吐结果不变，但电力展示可反映供需缺口。
14. “必须接入电网”规则保持不变，不因新增电力属性而放宽。
15. 发电与耗电均展示三组统计：即时值、10 分钟滚动均值、1 小时滚动均值。
16. 三组统计严格按标准秒计算；切换仿真倍速时，统计结果仅随仿真时间变化。
17. 武陵地区可进行管道铺设，且管道连接规则生效。
18. 至少一类带管道出入口设备可正常接入管道网络并参与链路。
19. 至少一条含流体输入/输出的配方可被选择、计算并展示。
20. 管道不可与生产设备重叠；可与传送带/分流汇流桥接器重叠且互不干扰。
21. 管道基准速度为 `2` 液体/标准秒/格，并在结果口径与链路结算中生效。
22. 管道仅展示流体颜色，不展示流体“盒子”动画。
23. 管道分流器/汇流器/桥接器可用，且语义与传送带对应组件一致。
24. 管道本体无方向：同一连通管道本体可在任意方向输送液体。
25. 管道分流器/汇流器有方向：方向不匹配时对应路径不运输。
26. 连通管道本体容量按 `2 × 管道长度` 计算，且可双端注入/抽取。
27. 管道传染规则生效：同一管道系统仅允许一种液体，异液输入在未排空前必须阻塞。
28. 桥接器按两条独立通道处理，传染不跨桥接器另一通道传播。
29. 管道系统与连通储液罐完全排空后，方可切换运输另一种液体。
30. 反应池支持 `3` 固体缓存位与 `2` 液体缓存位，且两类缓存互不干扰。
31. 反应池允许多配方并行生产；未选择配方时反应池不生产。
32. 反应池产物可按配方配置目标输出缓存/通道，并由对应端口送出。
33. 可切换形态设备在本系统中以独立新设备实现（如“种植机（水培）”），不实现运行时形态切换。
34. 水培设备需先补齐到领域模型，随后方可被放置、计算与仿真使用。
35. 物品类别已包含“液体”，且类型变更后的物品按液体规则参与运输。
36. 液体不可经传送带运输，固体不可经管道运输。
37. 传送带端口与管道端口互为非法接口，不发生跨介质连通。
38. 武陵扩展区域允许布置抽水泵、管道、储水罐与管路设备。
39. 抽水泵仅可放置在扩展区域，在基地内放置必须失败。
40. 抽水泵提供清水无限资源入口，需通过管道接入基地内网络后生效。
41. 紫晶矿已补充为矿物（固体）分类，不按液体规则处理。
42. 瓶装液体以隐藏物品建模，内部维护 20 个组合项（4 瓶型 × 5 液体）。
43. 通用物品列表不直接展示瓶装液体组合项，必须通过专用选择器选择。
44. 特定瓶型配方仅匹配对应组合项，不允许跨瓶型替代。
45. 瓶型无关配方在 UI 仅显示 1 条，但实现层按瓶型展开隐藏配方执行。
46. 涉及返瓶的瓶型无关配方，需按输入瓶型返还对应瓶子。
47. 武陵特定建筑存在摆放上限；天有烘炉达到 `N` 后不可继续放置。
48. 武陵上限仅作用于武陵地区，不影响四号谷地。
49. 达到上限后删除已放置建筑可恢复可用名额。
50. 武陵建筑上限 `N` 来自领域模型配置，未配置上限的建筑不受此规则影响。
51. 抽水泵输出效率由领域模型配置并参与流体吞吐结算。
49. 抽水泵具备耗电属性，但不需要供电桩连接即可接入电网。
50. 除反应池外，带瓶配方由设备收到的输入物品驱动匹配。
51. 反应池不使用带有瓶子的配方。
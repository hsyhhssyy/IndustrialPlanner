# Stage2 变更总览与目标

## 1. 文档目的

- 统一说明 Stage2 相对 Stage1 的增量范围与业务价值。
- 建立“需求 -> 设计 -> 测试 -> 发布”的追踪主线。

## 2. 版本信息

- Stage1 基线版本：待补（建议填写冻结 Tag）
- Stage2 当前版本：持续迭代中
- 文档维护人：项目组
- 最近更新时间：2026-02-23

## 3. 变更摘要（相对 Stage1）

### 3.1 新增能力

- 应用内新增“产线规划器”入口与浮窗容器（80% x 80%）。
- 支持多目标吞吐输入（/min）并进行合并计算。
- 支持多配方物品的手动切换与全局重算。
- 结果区按物品聚合展示需求吞吐与设备数量。
- 上线武陵地区地图，并开放地区切换。
- 引入流体工业三要素：管道铺设、带管道出入口设备、流体配方。
- 引入管道方向规则：管道本体无方向，可从任意方向向任意方向输送液体。
- 引入管道组件方向规则：管道分流器/管道汇流器有方向，方向不匹配时不运输。
- 引入管道容量规则：同一连通管道本体视为一个“等效管道缓存池”（抽象模型，非设备“储液罐”），容量为 `2 × 管道长度`。
- 明确真实设备“储液罐”为定向设备：`1` 入口 + `1` 出口。
- 引入管道传染规则：同一管道系统单液体锁定，异液输入在排空前阻塞。
- 启用武陵特殊设备“反应池”：多缓存结构、多配方并行、产物路由送出。
- 引入水培设备策略：将可切换形态设备在本系统中实现为独立新设备（如“种植机（水培）”）。
- 引入物品类别“液体”，并将部分既有物品从固体调整为液体。
- 引入“抽水泵”作为清水无限资源入口：允许在基地外扩展区域布设并通过管道接入基地。
- 抽水泵输出效率由领域模型提供。
- 修正物品分类缺失：将“紫晶矿”补充为“矿物”分类。
- 引入“瓶装液体”隐藏物品体系：以瓶型 × 液体组合形成内部物品，并通过专用选择器交互。
- 引入武陵地区“特定建筑摆放上限”规则：如天有烘炉最多放置 `N` 个。
- 上限 `N` 由领域模型配置提供。

### 3.2 规则增强

- 新增地区约束入口：支持“四号谷地/武陵”双地区可选。
- 地区规则差异生效：四号谷地过滤武陵专属内容；武陵地区开放流体工业相关内容。
- 管道本体按“无方向网络”处理，可在任意连接方向进行注入与抽取。
- 管道分流器/汇流器按“有方向组件”处理，方向不匹配时该路径流量为 0。
- 连通管道本体按“等效管道缓存池（抽象模型）”处理，容量统一按 `2 × 管道长度` 计算。
- 管道系统采用“单液体锁定 + 排空切换”规则，桥接器按双通道独立传染处理。
- 反应池采用“手动选配方 + 未选不生产 + 指定缓存路由”规则。
- 对“形态切换”类设备采用“独立设备建模”规则，不实现运行时形态切换。
- 运输介质与物品类别严格匹配：液体仅可通过管道运输，固体仅可通过传送带运输。
- 传送带端口与管道端口互斥，不构成合法连接接口。
- 循环处理仅用于未知/意外闭环；系统内已知闭环采用专项规则（当前包括：种植闭环、蓝铁块/蓝铁粉末互转）。
- 武陵地图扩展区域允许布置抽水泵、管道、储水罐及管路设备（分流/汇流/桥接等）。
- 抽水泵仅允许布置在扩展区域，不允许布置在基地内区域。
- 紫晶矿按“矿物（固体）”参与分类与过滤，不按液体处理。
- 瓶装液体不进入通用物品选择列表，需通过“瓶装液体选择器”选择瓶型与液体。
- 对“瓶型无关”配方，UI 仅显示 1 条配方；实现层按瓶型展开为多条隐藏配方执行。
- 武陵地区特定建筑受摆放上限约束；达到上限后禁止继续放置。
- 蓝铁块/蓝铁粉末互转配方采用条件启用：仅双需求时进入可选集合。
- 种植机/采种机农业闭环采用平衡口径，不显示循环异常提示。
- 引入全设备电力属性（耗电/发电）用于可视化调试；电力不足不触发停机或降速。
- 保持“必须接入电网”前置约束不变。
- 抽水泵具备耗电属性，但不需要供电桩连接，可凭空接入电网。
- 新增发电/耗电统计口径：即时值、10 分钟滚动窗口平均、1 小时滚动窗口平均。
- 电力统计时间基准统一为“标准秒”，不使用现实时间。
- 标准秒口径沿用 Stage1：`tickRate=20` 时，`1 标准秒 = 20 tick`，`1 标准分钟 = 1200 tick`；该口径不受倍速影响。

### 3.3 交互治理

- Toast 提示进入降噪治理：高频可见状态切换默认静默。
- 保留失败、异常、关键完成反馈类提示。

## 4. 目标与非目标

### 4.1 目标（Goals）

- 在不影响 Stage1 编辑与仿真主流程前提下，交付可用的基础产线规划能力。
- 提供可解释的结果展示：物品/配方、需求吞吐、设备数量三列信息。
- 建立地区约束与配方过滤的一致口径，保证“可选项 = 可计算项”。
- 提供设备耗电/发电可见性，支持发电设备调试。
- 提供抗震荡观测能力：支持短期（即时）与中长期（10 分钟/1 小时）电力统计对照。
- 支持武陵地区流体工业最小闭环：可铺设管道、可使用管道设备、可计算流体配方。
- 支持管道网络双端提交与回抽：同一连通管道本体可在任意端进行液体注入/抽取。
- 保证管道系统液体一致性：系统含液时阻止异液混入，排空后允许切换液体类型。
- 支持反应池并行生产与产物精确路由，满足武陵复杂工艺链配置需求。
- 支持水培设备独立接入流体链路，避免形态切换带来的状态耦合。
- 保证固液运输边界清晰，避免跨介质误连与错误输送。
- 在不模拟基地外世界的前提下，支持“扩展区域抽水 + 管道引入基地”的清水供给闭环。
- 在不挤占 UI 列表空间的前提下，支持瓶装液体组合物品与瓶型相关配方约束。
- 支持武陵专属建筑容量治理，避免高价值建筑无限堆叠破坏平衡。

### 4.2 非目标（Non-goals）

- 自动地图布局、自动连线、寻路系统。
- 多目标全局最优求解（成本最小化、设备最少化等）。
- 与地图实例实时双向绑定与自动落盘布置。
- 电力潮流求解与基于电力缺口的生产惩罚（停机/降速）。
- 流体压力/温度/相变等复杂流体网络求解。

## 5. 影响面总表

| 维度 | 影响级别 | 说明 |
|---|---|---|
| 用户操作流程 | 中 | 新增规划入口与配置流程，但不改变 Stage1 主编辑链路 |
| 数据结构/持久化 | 中 | 新增规划器局部状态持久化与设备电力属性 |
| 计算结果一致性 | 高 | 引入地区差异、流体配方、配方切换、条件配方、农业闭环与电力展示口径 |
| 电力观测稳定性 | 高 | 电力统计需按标准秒滚动窗口计算，避免现实时间抖动干扰 |
| 流体工业可用性 | 高 | 需保证管道、管道设备、流体配方三要素协同可用 |
| 反应池可配置性 | 高 | 需保证缓存结构、配方选择、并行执行与产物路由一致 |
| 水培设备建模完整性 | 高 | 需保证新增水培设备已进入领域模型并具备独立设备语义 |
| 固液运输合法性 | 高 | 需保证液体/固体与管道/传送带接口严格匹配 |
| 扩展区域流体设施合法性 | 高 | 需保证武陵扩展区域可放流体设施，且抽水泵仅可外区放置 |
| 瓶装液体配方一致性 | 高 | 需保证单展示配方与隐藏展开配方在计算结果上等价 |
| 武陵建筑摆放上限一致性 | 高 | 需保证特定建筑在武陵受 N 上限约束，其他地区不误触发 |
| 性能表现 | 低-中 | 多目标展开与重算频率上升，需关注重算时延 |
| 向后兼容性 | 中 | Stage1 主功能兼容，新增能力独立启用 |

## 6. 入口文档

- 范围与验收：01-scope-and-dod-stage2.md
- 增量设计：02-design-delta.md
- 迁移策略：03-migration-guide.md
- 回归测试：05-regression-test-plan.md

# Stage2 风险与回滚预案

> 冻结说明（2026-02-26）：本文件含 Stage2 全量风险池。与未落地能力相关的风险项已迁移至 Stage3 风险文档继续跟踪。

## 1. 风险清单

| 风险ID | 描述 | 触发条件 | 影响 | 概率 | 应对策略 |
|---|---|---|---|---|---|
| S2-RISK-001 | 地区过滤与计算口径不一致 | 输入可选但计算被过滤，或反之 | 结果可信度下降 | 中 | 建立三点一致性检查：输入/候选/计算 |
| S2-RISK-002 | 条件配方启用边界错误 | 双需求识别错误或重算时机错误 | 结果抖动或错误 | 中 | 增加单双需求对照用例与日志观测 |
| S2-RISK-003 | 农业闭环被误判为异常循环 | 循环检测规则覆盖过宽 | 结果中断或提示误导 | 中 | 闭环白名单规则与专用验收样例 |
| S2-RISK-004 | 规划器重算性能下降 | 多目标+多切换连续触发 | 交互卡顿 | 低-中 | 限流/缓存评估，记录重算耗时分布 |
| S2-RISK-005 | Toast 降噪过度 | 关键反馈被静默 | 用户误判操作结果 | 低 | 保留失败/异常/关键成功反馈底线 |
| S2-RISK-006 | 电力语义误耦合停机逻辑 | 引入电力属性后复用旧停机判断 | 设备异常停机，违背需求 | 中 | 明确“电力仅观测”并加专项回归 |
| S2-RISK-007 | 接网约束被误放宽 | 调整电力逻辑时改动接网前置判断 | 规则回退，行为不一致 | 低-中 | 增加未接网场景回归用例 |
| S2-RISK-008 | 电力统计时间基准错误 | 使用现实时间更新窗口统计 | 10 分钟/1 小时均值失真 | 中 | 强制以标准秒维护窗口并加倍速对照测试 |
| S2-RISK-009 | 流体三要素契约不一致 | 管道、端口设备、流体配方定义不一致 | 武陵流体链路不可用 | 中 | 建立三要素联动验收与一致性检查 |
| S2-RISK-010 | 管道重叠规则错误 | 错误允许与生产设备重叠或错误禁止与传送带重叠 | 链路冲突或玩法缺失 | 中 | 增加重叠矩阵测试并固化判定顺序 |
| S2-RISK-011 | 管道速度口径偏差 | 管道速度未按 `2` 液体/标准秒/格实现 | 流体产线结果偏差 | 中 | 增加基准链路速度校准用例 |
| S2-RISK-011A | 管道方向规则实现错误 | 将有方向管道误实现为无方向或方向判定错误 | 链路阻塞或吞吐异常 | 中-高 | 增加方向匹配/失配对照用例并校验方向约束 |
| S2-RISK-011B | 分流/汇流方向判定错误 | 方向失配仍可运输或方向匹配被误阻断 | 流体路径错误或断流 | 中-高 | 增加方向匹配矩阵测试并固化判定顺序 |
| S2-RISK-011C | 管道容量口径实现偏差 | 容量未按 `2 × 管道长度` 计算，或误计真实储液罐设备/设备缓存 | 液量结算与预期不一致 | 中 | 增加长度-容量线性校验与边界回归 |
| S2-RISK-012 | 管道传染判定错误 | 系统锁定液体类型或阻塞条件实现错误 | 异液误入或误阻塞 | 中-高 | 增加“末端残液阻塞”与“排空切换”强制用例 |
| S2-RISK-013 | 桥接器通道串染 | 桥接器未按双通道隔离处理 | 不同通道液体互相污染 | 中 | 增加桥接器双通道隔离测试 |
| S2-RISK-014 | 排空口径实现偏差 | 将设备内部液体误计入管道系统排空 | 液体切换被错误阻塞 | 中 | 明确排空口径并加专项回归 |
| S2-RISK-015 | 反应池配方执行异常 | 未选配方仍执行或并行配方互相阻塞 | 产能与结果错误 | 中 | 增加“未选不生产+并行执行”专项用例 |
| S2-RISK-016 | 反应池路由错误 | 产物未按指定缓存/端口送出 | 出料错位或堵塞 | 中 | 增加产物路由与端口映射回归 |
| S2-RISK-017 | 水培设备未入领域模型 | 未完成设备注册即进入功能联调 | 放置/仿真不可用 | 高 | 将“领域模型补齐”设为前置阻塞条件 |
| S2-RISK-018 | 误实现运行时形态切换 | 将独立设备误做成同设备切换 | 状态耦合与数据错乱 | 中 | 固化“独立设备实现”规则并加回归用例 |
| S2-RISK-019 | 扩展区域流体放置边界错误 | 武陵扩展区域错误拒绝或基地内错误放行 | 规则失真与链路异常 | 中 | 增加区域矩阵测试并固化放置判定优先级 |
| S2-RISK-020 | 抽水泵区域约束失效 | 抽水泵被允许放置在基地内 | 无限水入口越界影响平衡 | 中-高 | 强制抽水泵“仅扩展区域”校验并加阻断用例 |
| S2-RISK-021 | 紫晶矿分类遗漏或误分 | 紫晶矿未标记矿物或被误标为液体 | 过滤与运输判定错误 | 中 | 增加分类校验用例并在迁移阶段核对元数据 |
| S2-RISK-022 | 瓶装液体可见性泄漏 | 20 个隐藏组合项被直接暴露到通用列表 | UI 噪音过高与误选增加 | 中 | 强制使用专用选择器入口并加可见性回归 |
| S2-RISK-023 | 单展示多展开不一致 | 瓶型无关配方展示与执行层展开不一致 | 计算结果偏差 | 中-高 | 增加展示层/执行层对照测试与日志比对 |
| S2-RISK-024 | 返瓶瓶型错配 | 返瓶未按输入瓶型返回对应瓶子 | 物料守恒错误 | 中 | 增加四瓶型返瓶一致性测试 |
| S2-RISK-025 | 武陵建筑上限越界 | 达到 N 后仍可继续放置 | 平衡性破坏 | 中-高 | 增加 N/N+1 阻断用例并强制放置前校验 |
| S2-RISK-026 | 武陵上限误伤其他地区 | 四号谷地误应用武陵上限 | 地区规则错乱 | 中 | 增加地区隔离测试并按地区键读取上限配置 |

## 2. 监控与告警

- 关键指标：规划器计算错误数、重算耗时、空结果率、关键 warning 触发频次、电力展示一致性错误数、电力窗口统计偏差次数、流体链路失败次数、异液阻塞误判次数、管道方向误判次数、分流/汇流方向失配误放行次数、管道容量口径偏差次数、反应池路由失败次数、水培设备注册缺失次数、抽水泵越界放置次数、紫晶矿分类校验失败次数、瓶装液体可见性泄漏次数、返瓶错配次数、武陵上限越界放置次数。
- 建议阈值：
	- 重算 P95 > 500ms 需标记性能风险；
	- 同场景结果不一致复现 >= 1 次即立刻阻断发布。
- 观察窗口：提测日到发布后首周。

## 3. 回滚策略

### 3.1 触发条件

- 出现 P0 缺陷且 24 小时内无法完成修复与复测。
- 关键结果口径错误（地区规则、流体三要素、管道有方向规则、分流/汇流方向规则、管道容量规则、管道传染规则、扩展区域流体放置规则、抽水泵区域规则、瓶装液体展开规则、返瓶规则、武陵建筑上限规则、反应池规则、水培设备规则、互转条件、农业闭环、电力语义、标准秒窗口统计）被确认。
- Stage1 主流程出现阻断回归。

### 3.2 回滚步骤

1. 发布层面回退到 Stage1 稳定版本（或关闭 Stage2 入口开关）。
2. 清理 Stage2 新增持久化状态，避免旧版本解析异常。
3. 执行 Stage1 最小回归清单，确认核心可用后再对外恢复。

### 3.3 回滚后验证

- Stage1 编辑/仿真主路径可用。
- 不出现因 Stage2 残留状态导致的启动或渲染异常。
- 关键告警恢复到回滚前基线。

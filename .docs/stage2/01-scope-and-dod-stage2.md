# Stage2 范围与完成定义（DoD）

## 1. 范围边界

### 1.1 In Scope

- 新增“产线规划器”入口、浮窗容器与状态保持。
- 支持多目标输入（目标物品 + /min）并合并计算。
- 结果区按物品聚合，采用三列伪表格卡片展示。
- 多配方物品支持手动切换并触发全局重算。
- 地区约束切换（“四号谷地/武陵”双地区可用）。
- 武陵地区引入流体工业三要素：管道铺设、管道出入口设备、流体配方。
- 管道本体无方向：连通管道本体可从任意方向向任意方向输送液体。
- 管道分流器/管道汇流器有方向：方向不匹配时不运输。
- 连通管道本体等效为一个“管道缓存池”（抽象模型，非设备“储液罐”）：容量为 `2 × 管道长度`。
- 真实设备“储液罐”为定向设备：`1` 入口 + `1` 出口。
- 武陵地图扩展区域允许布置流体设施：抽水泵、管道、储水罐与管路设备（分流/汇流/桥接等）。
- 抽水泵仅可布置在扩展区域，并可通过管道向基地内供水。
- 引入瓶装液体专用选择器：用户通过“瓶型 + 液体”选择瓶装液体，不在通用物品列表直接展开组合项。
- 支持瓶装液体隐藏物品展开：内部按 4 种瓶型 × 5 种液体维护 20 个组合物品。
- 支持“瓶型无关”配方单展示：UI 显示 1 条配方，实现层按瓶型展开为多条隐藏配方。
- 武陵地区支持“特定建筑摆放上限”规则：受限建筑在达到上限 `N` 后禁止继续放置。
- 武陵建筑上限 `N` 由领域模型配置提供。
- 固液运输互斥规则生效：液体不可走传送带，固体不可走管道，带/管接口互斥。
- 物品分类修正规则生效：紫晶矿补充为矿物（固体）分类。
- 管道传染规则生效：同一管道系统仅允许单液体类型，异液输入需在系统完全排空前阻塞。
- 启用武陵特殊设备“反应池”：3 固体缓存位 + 2 液体缓存位，多配方并行与产物缓存路由。
- 可切换形态设备采用独立建模策略：新增“水培设备”而非运行时切换形态。
- 蓝铁块/蓝铁粉末互转配方条件启用规则。
- 种植机/采种机农业闭环平衡计算与异常提示豁免。
- 已知循环（当前包括：种植闭环、蓝铁块/蓝铁粉末互转）按专项规则处理；未知/意外循环才执行异常截断。
- 引入全设备电力属性（耗电/发电）并提供展示能力。
- 电力不足时设备仍可运行（不降速、不停机），但“必须接入电网”约束保持不变。
- 抽水泵具备耗电属性与领域模型定义的输出效率，但不需要供电桩连接即可接入电网。
- 发电/耗电展示支持三组统计：即时值、10 分钟滚动均值、1 小时滚动均值。
- 电力统计时间口径采用标准秒，不采用现实时间（沿用 Stage1：`1 秒 = 20 tick`、`1 分钟 = 1200 tick`，不受倍速影响）。
- Stage2 Toast 降噪治理（见专题文档）。

### 1.2 Out of Scope

- 自动布局、自动连线、寻路与地图自动布置。
- 多目标优化求解器（成本、能耗、设备数最优）。
- 副产物闭环最优回收策略。
- 对 Stage1 设备仿真模型进行全面重构。
- 电力潮流网络求解、线损建模与按电力缺口处罚生产。
- 流体压力/温度/相变等复杂流体网络求解。
- 运行时设备形态切换机制（本阶段不实现）。

## 2. 用户故事与验收条款

| 用户故事 | 验收条件 | 验收方式 |
|---|---|---|
| 作为玩家，我希望输入多个目标物品并得到统一产线需求 | 至少 2 个目标可同时输入并产出聚合结果 | 手测 |
| 作为玩家，我希望切换某物品配方并立即看到结果变化 | 手动切换配方后，结果区在一次交互内完成重算刷新 | 手测 |
| 作为玩家，我希望地区限制在输入与计算上保持一致 | 四号谷地下过滤武陵专属内容；武陵地区开放对应内容 | 手测 |
| 作为玩家，我希望在武陵地图使用流体工业能力 | 可铺设管道、接入管道设备、选择并计算流体配方 | 手测 |
| 作为玩家，我希望管道本体可双向输送液体 | 同一连通管道本体可在任意端注入/抽取液体并形成有效输送 | 手测 |
| 作为玩家，我希望分流/汇流遵循方向规则 | 分流器/汇流器方向不匹配时不运输，方向匹配时可运输 | 手测 |
| 作为玩家，我希望管道容量可预期 | 连通管道本体容量按 `2 × 管道长度` 计算并可验证 | 手测 |
| 作为玩家，我希望在基地外接入清水无限资源 | 扩展区域可放置抽水泵并可通过管道向基地内输送清水 | 手测 |
| 作为玩家，我希望抽水泵摆放规则明确 | 抽水泵在基地内放置失败，在扩展区域放置成功 | 手测 |
| 作为玩家，我希望选择瓶装液体时不被 20 个组合项干扰 | 通用列表不直接显示组合项，改由瓶装液体选择器完成瓶型与液体选择 | 手测 |
| 作为玩家，我希望瓶型无关配方更简洁 | 配方表仅显示 1 条配方，但计算结果与隐藏展开一致 | 手测 |
| 作为玩家，我希望武陵高价值建筑有数量上限 | 特定建筑（如天有烘炉）达到 `N` 后不可继续放置 | 手测 |
| 作为玩家，我希望武陵上限不影响其他地区 | 四号谷地不误触发武陵专属建筑上限 | 手测 |
| 作为玩家，我希望同一管道系统不被异液污染 | 系统内有液体时异液输入被阻塞；完全排空后可切换液体 | 手测 |
| 作为玩家，我希望按需配置反应池产物出口 | 可在放置时选配方，并将产物指定到目标缓存/端口送出 | 手测 |
| 作为玩家，我希望使用水培形态设备 | 可放置独立水培设备并接入液体链路，不依赖形态切换 | 手测 |
| 作为玩家，我希望规划器不影响原编辑/仿真体验 | Stage1 主流程可完整执行，未出现阻断缺陷 | 回归测试 |
| 作为玩家，我希望看到设备耗电/发电以便调试发电设备 | 可查看单设备与聚合电力信息；电力不足时设备仍持续运转 | 手测 |
| 作为玩家，我希望在震荡场景下看到稳定统计 | 可查看即时值 + 10 分钟/1 小时滚动均值，且口径基于标准秒 | 手测 |

## 3. DoD（完成定义）

### 3.1 开发完成

- 产线规划器 MVP 需求在 01-planner-module-mvp.md 中列项全部满足。
- 地区规则、条件配方、农业闭环、流体工业三要素均已实现。
- 管道本体无方向输送规则、分流/汇流有方向规则、以及 `2 × 管道长度` 容量规则已实现。
- 管道传染规则已实现（含桥接器双通道独立传染语义）。
- 反应池规则已实现（缓存独立、并行配方、未选不生产、按缓存路由送出）。
- 水培设备独立模型已确定，待领域模型补齐后接入放置/计算/仿真链路（不含运行时形态切换）。
- 全设备电力属性与展示已实现，且不影响吞吐结算链路。
- 三组电力统计（即时/10 分钟/1 小时）已实现并按标准秒计算。
- 武陵地区流体工业三要素（管道、管道端口设备、流体配方）已实现并可联动。
- 武陵扩展区域流体设施放置规则已实现，且抽水泵仅限扩展区域放置。
- 瓶装液体组合项隐藏与专用选择器规则已实现，且“瓶型无关配方”遵循单展示多展开口径。
- 武陵特定建筑摆放上限规则已实现，达到上限后放置请求被拒绝。
- 武陵特定建筑摆放上限 `N` 读取自领域模型配置。
- 关键异常路径具备可恢复行为（无效输入、不可用配方、循环路径）。

### 3.2 质量完成

- 回归测试计划项通过（见 05-regression-test-plan.md）。
- 无 P0/P1 已知缺陷；P2/P3 已登记并可解释。
- 规划器核心链路在常见规模目标下可接受（建议首屏重算 < 500ms，超阈值需备案）。
- 已验证电力不足场景下设备不停机，且“必须接入电网”规则未回退。

### 3.3 文档完成

- 迁移文档已更新（见 03-migration-guide.md）。
- 契约变化文档已更新（见 04-api-and-contract-changes.md）。
- 发布说明已更新（见 07-release-notes.md）。

## 4. 验收签字

- 产品：待填
- 开发：待填
- 测试：待填

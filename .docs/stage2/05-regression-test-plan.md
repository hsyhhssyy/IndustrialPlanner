# Stage2 回归测试计划

## 1. 测试目标

- 验证 Stage2 规划器能力与规则口径正确性。
- 保证 Stage1 编辑与仿真核心路径无回归。

## 2. 测试范围

### 2.1 必测（Smoke）

- 启动与基础交互可用（含中英文切换后入口可见）。
- 规划器可打开/关闭并保留输入与窗口状态。
- 多目标输入与聚合结果可正常生成。
- 地区约束过滤在输入、候选配方、计算结果三处一致。
- 武陵地区可切换并加载流体工业相关内容。
- 管道重叠规则正确：不可与生产设备重叠，可与传送带及其分流汇流桥接重叠。
- 管道方向规则正确：管道本体有方向，方向不匹配时不运输。
- 分流/汇流方向规则正确：方向不匹配时不运输。
- 管道容量规则正确：连通管道本体容量 = `2 × 管道长度`。
- 管道流速口径正确：`2` 液体/标准秒/格。
- 管道可视化正确：仅显示流体颜色，不显示流体盒子动画。
- 配方手动切换后可即时重算。
- 电力信息可见：设备耗电、发电与聚合结果可展示。
- 电力不足时设备不停机、不降速（接网规则仍生效）。
- 电力统计三组数据可见：即时值、10 分钟滚动均值、1 小时滚动均值。
- 统计窗口按标准秒推进；倍速切换不改变统计定义。
- 标准秒换算口径与 Stage1 一致：`1 秒 = 20 tick`、`1 分钟 = 1200 tick`。

### 2.2 回归（Regression）

- Stage1 编辑主路径：放置、旋转、拖拽、框选、删除。
- Stage1 仿真主路径：启动、停止、倍速切换、统计可见。
- 蓝图常见路径：保存、导入、放置（结合 toast 降噪策略观察）。

### 2.3 扩展（Extended）

- 蓝铁块/蓝铁粉末互转条件启用边界测试。
- 农业闭环（种植机/采种机）平衡计算场景测试。
- 长时多次重算稳定性与性能观察。
- 发电设备调试场景测试（不同发电/耗电组合下展示正确）。
- 电力震荡场景下滚动窗口稳定性测试。
- 流体工业三要素联动测试（管道、端口设备、流体配方）。
- 管道分流器/汇流器/桥接器语义一致性测试（对齐传送带版本）。
- 管道本体方向匹配与失配测试（有方向）。
- 分流器/汇流器方向匹配与失配测试。
- 管道容量线性增长测试（长度变化与 `2 × 长度` 一致）。
- 管道传染特性测试（系统单液体锁定、排空切换、桥接通道隔离）。
- 扩展区域抽水泵测试（外区放置、基地内拦截、引水入基地链路）。
- 物品分类修正测试（紫晶矿补充为矿物分类）。
- 瓶装液体规则测试（专用选择器、隐藏组合项、单展示多展开）。
- 武陵特定建筑摆放上限测试（达到 N 拦截、删除后恢复、地区隔离）。
- 反应池专项测试（缓存独立、多配方并行、未选不生产、产物路由）。
- 水培设备专项测试（独立设备、无运行时形态切换、液体注入链路）。

## 3. 用例矩阵（v0）

| 用例ID | 场景 | 前置条件 | 步骤 | 预期结果 | 优先级 |
|---|---|---|---|---|---|
| S2-SM-001 | 规划器入口与状态保持 | 已进入主界面 | 打开规划器 -> 输入目标 -> 关闭 -> 再打开 | 输入与窗口状态保持 | P0 |
| S2-SM-002 | 多目标聚合计算 | 至少可选2种目标物品 | 添加2条目标并计算 | 输出按物品聚合，显示需求与设备数 | P0 |
| S2-SM-003 | 地区规则一致性 | 可切换四号谷地/武陵 | 检查目标下拉、配方候选、计算结果 | 地区规则在输入/候选/计算三处一致 | P0 |
| S2-SM-004 | 配方切换重算 | 某物品存在多配方 | 手动切换配方 | 结果即时刷新且口径一致 | P0 |
| S2-SM-004A | 武陵地区流体可用性 | 地区切换为武陵 | 检查流体物品、流体配方、管道设备候选 | 三类内容均可见且可用 | P0 |
| S2-SM-004B | 管道重叠规则 | 武陵地区且存在传送带/生产设备 | 尝试与不同对象重叠铺设管道 | 与生产设备重叠失败；与传送带组件重叠成功且互不干扰 | P0 |
| S2-SM-004B1 | 管道本体有方向 | 武陵地区且已形成连通管道本体 | 分别在方向匹配与失配条件下注入/抽取 | 方向匹配可运输；方向失配不运输 | P0 |
| S2-SM-004B2 | 分流/汇流方向匹配 | 存在分流器/汇流器并可调方向 | 分别在匹配与失配方向下运行链路 | 匹配方向可运输；失配方向不运输 | P0 |
| S2-SM-004B3 | 管道容量口径 | 已知管道本体长度 L | 向管道系统持续注入直至满载 | 满载容量为 `2 × L`，且不计入真实储液罐设备/设备缓存 | P0 |
| S2-SM-004C | 管道速度口径 | 存在可观测流体链路 | 统计单位格输送能力 | 基准能力为 `2` 液体/标准秒/格 | P0 |
| S2-SM-004D | 管道可视化口径 | 流体在管道内流动 | 观察管道渲染 | 显示流体颜色，不显示盒子动画 | P1 |
| S2-SM-004E | 管道传染阻塞 | 同一管道系统末端存在 A 液体 | 在起点注入 B 液体 | B 液体被阻塞（即使有空余容量） | P0 |
| S2-SM-004F | 排空后切换液体 | 系统内及连通储液罐液体已清空 | 注入与此前不同液体 | 注入成功并建立新液体锁定 | P0 |
| S2-SM-004G | 反应池缓存结构 | 存在反应池设备 | 查看缓存结构与运行 | 具备 3 固体缓存位与 2 液体缓存位，且互不干扰 | P0 |
| S2-SM-004H | 反应池未选不生产 | 放置反应池但未配置配方 | 运行仿真观察 | 反应池不执行生产 | P0 |
| S2-SM-004I | 水培设备独立可见性 | 已补齐水培设备领域模型 | 打开放置列表与规划候选 | 可见“种植机（水培）”等独立设备 | P0 |
| S2-SM-004J | 武陵扩展区流体设施放置 | 地区切换为武陵 | 在扩展区域放置抽水泵/管道/储水罐/管路设备 | 放置成功且可连通 | P0 |
| S2-SM-004K | 抽水泵区域限制 | 存在基地内与扩展区可选地块 | 分别在两类地块放置抽水泵 | 扩展区成功，基地内失败 | P0 |
| S2-SM-004K1 | 抽水泵接网口径 | 抽水泵已放置且无供电桩连接 | 运行仿真并观察抽水行为 | 抽水泵可接入电网并工作，不依赖供电桩连接 | P0 |
| S2-SM-004K2 | 抽水泵效率口径 | 领域模型配置抽水泵输出效率 | 观测单位标准秒输出 | 实际输出与领域模型效率一致 | P0 |
| S2-SM-004L | 紫晶矿分类修正 | 已加载物品元数据 | 检查紫晶矿分类与运输介质判定 | 紫晶矿为矿物（固体），不进入液体管道规则 | P0 |
| S2-SM-004M | 瓶装液体选择器可用 | 已加载瓶型与液体数据 | 打开物品选择并选择瓶型+液体 | 通用列表不平铺 20 项；可通过专用选择器选中目标组合项 | P0 |
| S2-SM-004N | 特定瓶型配方匹配 | 存在要求指定瓶型的配方 | 分别喂入匹配与不匹配瓶型组合 | 仅匹配瓶型可执行，不匹配被拒绝 | P0 |
| S2-SM-004O | 瓶型无关配方单展示 | 存在瓶型无关且返瓶配方 | 查看配方列表并执行 | UI 仅 1 条配方；执行按瓶型展开且返还对应瓶子 | P0 |
| S2-SM-004P | 武陵建筑上限拦截 | 武陵地区，天有烘炉上限为 N | 连续放置至 N 后再放置 1 个 | 前 N 次成功，第 N+1 次失败 | P0 |
| S2-SM-004Q | 上限名额回收 | 已达到上限 N | 删除 1 个后再次放置 | 可再次成功放置 1 个 | P0 |
| S2-SM-005 | 电力展示可用 | 存在至少一种发电设备与耗电设备 | 执行规划/仿真并查看信息 | 可见耗电、发电与聚合值 | P0 |
| S2-SM-006 | 电力不足不停机 | 构造总发电 < 总耗电场景 | 运行仿真并观察设备 | 设备继续运转，不因缺电停机/降速 | P0 |
| S2-SM-007 | 电力三组统计可用 | 存在功率波动场景 | 查看即时值/10 分钟/1 小时数据 | 三组数据均可见且语义正确 | P0 |
| S2-SM-008 | 标准秒口径校验 | 可切换仿真倍速 | 在不同倍速下对照统计窗口 | 统计按标准秒滚动，不按现实时间漂移 | P0 |
| S2-RG-001 | Stage1 编辑回归 | 打开地图编辑模式 | 执行放置/拖拽/框选/删除 | 操作行为与 Stage1 一致 | P1 |
| S2-RG-002 | Stage1 仿真回归 | 已搭建基础产线 | 启动仿真并切换倍速 | 仿真与统计无阻断问题 | P1 |
| S2-RG-003 | 接网前置约束回归 | 设备未接入电网 | 启动并观察运行状态 | 接网约束行为与既有口径一致 | P1 |
| S2-EX-001 | 互转条件配方 | 构造单双需求两种输入 | 比较互转配方候选可见性 | 仅双需求时可选并参与计算 | P1 |
| S2-EX-001A | 已知循环处理口径 | 构造种植闭环与蓝铁互转闭环场景 | 执行计算并观察提示与结果 | 两类已知循环按专项规则处理，不显示异常截断提示 | P1 |
| S2-EX-002 | 农业闭环平衡 | 使用砂叶 120/min 场景 | 执行计算 | 输出种植机8、采种机4，且无循环异常提示 | P1 |
| S2-EX-003 | 流体链路最小闭环 | 武陵地图存在流体设备与配方 | 铺设管道并接入设备，触发流体配方 | 流体链路可计算且结果可展示 | P1 |
| S2-EX-004 | 管道组件语义 | 存在管道分流/汇流/桥接器 | 分别验证分流、汇流、跨越 | 组件行为与传送带对应组件语义一致 | P1 |
| S2-EX-004A | 有方向管道双端并发 | 同一连通管道本体两端均有输入/输出端口 | 双端同时注入与抽取 | 系统按同一等效管道缓存池结算，且各路径遵循端口方向约束 | P1 |
| S2-EX-004B | 分流汇流方向失配恢复 | 分流器/汇流器初始方向失配 | 观测不运输后调整方向重试 | 失配时流量为 0，修正方向后恢复运输 | P1 |
| S2-EX-004C | 连通长度变更容量联动 | 动态增减管道本体长度 | 对比扩容/缩容后可容纳液量 | 容量随长度线性变化并满足 `2 × 长度` | P1 |
| S2-EX-005 | 桥接器通道隔离 | 存在桥接器双通道 | 一通道注入 A，另一通道注入 B | 两通道独立，不发生跨通道传染 | P1 |
| S2-EX-006 | 设备内液体排除 | 管道已排空但设备缓存仍有液体 | 注入新液体 | 允许注入（设备缓存不阻塞切换） | P1 |
| S2-EX-007 | 反应池多配方并行 | 反应池已选择多个可执行配方 | 启动仿真并观测产出 | 多配方并行推进，互不阻塞 | P1 |
| S2-EX-008 | 反应池产物路由 | 已配置配方产物目标缓存 | 触发产出并检查端口输出 | 产物进入指定缓存并由对应端口送出 | P1 |
| S2-EX-009 | 水培设备无形态切换 | 同时存在普通与水培设备 | 运行中尝试切换形态 | 不提供运行时切换；以独立设备分别运行 | P1 |
| S2-EX-010 | 水培液体注入链路 | 水培设备已接入管道 | 执行需液体配方 | 液体通过水培设备独立端口注入并正常生产 | P1 |
| S2-EX-011 | 抽水引水链路 | 扩展区抽水泵已接管道至基地内设备 | 运行仿真并观测清水流动 | 清水可由扩展区进入基地内并驱动配方 | P1 |
| S2-EX-012 | 瓶型无关配方展开一致性 | 存在 4 种瓶型可用 | 分别以四种瓶型执行同一单展示配方 | 四组执行结果在液体产出上等价，返瓶按输入瓶型一致 | P1 |
| S2-EX-012A | 设备配方匹配决策 | 存在带瓶输入的普通设备与反应池 | 分别投喂带瓶物品并执行 | 普通设备按输入物品匹配带瓶配方；反应池不使用带瓶配方 | P1 |
| S2-EX-013 | 武陵上限地区隔离 | 切换四号谷地与武陵 | 对同建筑执行放置上限对照 | 武陵受 N 限制，四号谷地不误触发武陵上限 | P1 |

## 4. 缺陷分级

- P0：阻断发布（核心流程不可用、数据错误不可恢复）
- P1：核心能力不可用或结果口径错误
- P2：功能可用但存在明显偏差或体验阻断
- P3：体验类问题与低风险展示问题

## 5. 通过标准

- P0/P1 缺陷清零。
- Smoke 用例全通过。
- 回归用例通过率 >= 95%。
- 关键扩展用例（互转条件、农业闭环）通过。

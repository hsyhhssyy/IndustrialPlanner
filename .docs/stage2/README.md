# Stage2 开发指导文档集（重定义）

本目录用于承接 Stage1 基线后的增量迭代，强调“变更可追溯、升级可迁移、结果可验证、异常可回滚”。

## 阶段说明

Stage2 已重定义为原 PRD 的 Stage3 能力方向：

- 产线规划与目标产量反推
- 多目标联合规划
- 配方分支可切换策略

本阶段首个交付模块为“产线规划器（基础版）”，用于在现有仿真编辑器中提供静态产能计算能力。

本阶段新增武陵地区地图能力，并引入流体工业基础要素：

- 管道铺设（Pipe）
- 带管道出入口的设备（Pipe IO）
- 含有流体输入/输出的配方（Fluid Recipe）
- 管道方向口径：管道本体无方向，连通管道本体可从任意方向向任意方向输送液体
- 管道组件方向口径：管道分流器/管道汇流器有方向，方向不匹配时不运输
- 管道容量口径：同一连通管道本体视为一个等效储液罐，容量为 `2 × 管道长度`

并新增扩展区域清水接入规则：

- 武陵扩展区域允许布置抽水泵、管道、储水罐、管路设备（分流/汇流/桥接）。
- 抽水泵作为清水无限资源入口，仅允许布置在扩展区域。
- 扩展区域仅承载资源入口语义，不引入基地外完整仿真。

并新增瓶装液体规则：

- 瓶装液体按隐藏物品建模（4 种瓶型 × 5 种液体，共 20 个组合项）。
- 通用物品列表不平铺 20 项，使用专用选择器完成瓶型与液体选择。
- 瓶型无关配方在 UI 单条展示，实现层按瓶型展开执行。

并新增武陵建筑上限规则：

- 武陵特定建筑受摆放上限约束（示例：天有烘炉最多 `N` 个）。
- 上限达到后放置失败，删除后可恢复名额。

并补充分类与运输边界修正：

- 紫晶矿补充为矿物（固体）分类。
- 液体不可走传送带、固体不可走管道，带/管接口互斥。

当前阶段同步引入电力属性观测能力：

- 全设备具备耗电属性，部分设备具备发电属性。
- 电力不足不触发停机/降速，但设备仍需满足“接入电网”前置约束。
- 电力属性主要用于发电调试与可视化展示。
- 发电/耗电展示包含三组统计：即时值、10 分钟滚动均值、1 小时滚动均值。
- 三组统计统一按标准秒计算，不按现实时间计算。

## 主线文档（建议先读）

1. [00-change-log-and-goals.md](./00-change-log-and-goals.md)：相对 Stage1 的变更总览、目标与非目标
2. [01-scope-and-dod-stage2.md](./01-scope-and-dod-stage2.md)：范围边界、DoD、验收口径
3. [02-design-delta.md](./02-design-delta.md)：架构/数据/交互增量设计（仅记录差异）
4. [03-migration-guide.md](./03-migration-guide.md)：从 Stage1 升级到 Stage2 的迁移与兼容策略
5. [04-api-and-contract-changes.md](./04-api-and-contract-changes.md)：接口、状态、事件契约变化
6. [05-regression-test-plan.md](./05-regression-test-plan.md)：回归测试矩阵与通过标准
7. [06-risk-and-rollback.md](./06-risk-and-rollback.md)：风险、观测指标、回滚预案
8. [07-release-notes.md](./07-release-notes.md)：发布说明、已知限制、后续计划

## 专题文档（按需阅读）

1. [01-planner-module-mvp.md](./01-planner-module-mvp.md)：产线规划器基础版需求与完成定义
2. [02-toast-governance.md](./02-toast-governance.md)：全局提示（Toast）降噪规范与落地表
3. [code-structure-smell-review.md](./code-structure-smell-review.md)：代码结构异味审查记录

## 与 Stage1 的关系

- Stage1 主流程保持兼容，不被替换或阻断。
- Stage2 在此基础上引入增量规则（地区、流体、电力观测等），属于“主流程兼容 + 规则扩展”。
- Stage2 模块先作为独立浮窗工具，不直接驱动地图自动布置。
- 不引入自动寻路、自动摆放、优化求解器。